{layout name="common/layout" /}
<article class="min-h-screen bg-gray-50 py-6">
    <!-- è°·æ­Œå¹¿å‘Šä½ - é¡¶éƒ¨æ¨ªå¹…ï¼ˆå±•ç¤ºå¹¿å‘Šï¼‰-->
    <div class="mx-auto my-6 max-w-3xl px-4 text-center sm:px-6 lg:px-8">
        <ins class="adsbygoogle block"
             data-ad-client="ca-pub-9195262048954682"
             data-ad-slot="2969657271"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <div class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8">
        <div class="rounded-2xl bg-white p-6 shadow-sm ring-1 ring-gray-200 sm:p-8">
            <!-- æµ‹è¯•æ ‡é¢˜ -->
            <header class="border-b border-gray-100 pb-6 text-center">
                <h1 id="test-title" class="text-2xl font-bold text-gray-900 sm:text-3xl">è´å…‹æŠ‘éƒé‡è¡¨ï¼ˆBDI-SFï¼‰</h1>
                <!-- <p id="test-subtitle">æµ‹è¯•ç»“æœä»…ä¾›å‚è€ƒï¼Œå…·ä½“è¯·å’¨è¯¢ä¸“ä¸šæŒ‡å¯¼</p> -->
            </header>

            <!-- æµ‹è¯•ä¿¡æ¯ - æŠ˜å å¼ -->
            <section class="mt-6 overflow-hidden rounded-2xl border border-gray-200 bg-gray-50" id="test-info">
                <button type="button" class="flex w-full items-center justify-between gap-3 px-5 py-4 text-left" onclick="toggleTestInfo()">
                    <h2 class="text-base font-semibold text-gray-900" id="info-header-title">æµ‹è¯•ä¿¡æ¯</h2>
                    <span class="text-sm font-semibold text-gray-500" id="test-info-icon">â–¼</span>
                </button>
                <div class="hidden px-5 pb-5" id="info-content">
                    <!-- æµ‹è¯•ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </section>

            <!-- åˆ†æ•°æ˜¾ç¤º -->
            <section class="mt-6">
                <div class="rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 p-6 text-white shadow-sm sm:flex sm:items-center sm:gap-6">
                    <div class="mx-auto flex h-28 w-28 flex-col items-center justify-center rounded-full bg-white/20 ring-2 ring-white/20 sm:mx-0">
                        <div class="text-3xl font-bold" id="total-score">0</div>
                        <div class="mt-1 text-sm font-semibold opacity-90" id="score-label">æ€»åˆ†</div>
                    </div>
                    <div class="mt-4 text-center sm:mt-0 sm:text-left">
                        <div class="text-base font-semibold sm:text-lg" id="score-description">Loading...</div>
                        <div class="mt-2 text-sm opacity-90" id="score-level">Evaluating...</div>
                    </div>
                </div>
            </section>

            <!-- ç»“æœåˆ†æ -->
            <section class="mt-8" id="analysis-section">
                <h2 class="text-center text-lg font-semibold text-gray-900 sm:text-2xl" id="analysis-header-title">è¯¦ç»†åˆ†ææŠ¥å‘Š</h2>
                <div class="prose prose-sm mt-5 max-w-none rounded-2xl border border-gray-200 bg-white p-5 text-gray-700 shadow-sm" id="analysis-content">
                    <!-- åˆ†æå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </section>

            <!-- å»ºè®®å’ŒæŒ‡å¯¼ -->
            <section class="mt-8" id="suggestions-section">
                <h2 class="text-center text-lg font-semibold text-gray-900 sm:text-2xl" id="suggestions-header-title">å»ºè®®å’ŒæŒ‡å¯¼</h2>
                <div class="prose prose-sm mt-5 max-w-none rounded-2xl border border-gray-200 bg-white p-5 text-gray-700 shadow-sm" id="suggestions-content">
                    <!-- å»ºè®®å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </section>
        </div>
    </div>

    <!-- è°·æ­Œå¹¿å‘Šä½ - ä¸­é—´å†…å®¹ï¼ˆæ–‡ç« å†…åµŒå¹¿å‘Šï¼‰-->
    <div class="mx-auto my-10 max-w-3xl px-4 text-center sm:px-6 lg:px-8">
        <ins class="adsbygoogle block"
             data-ad-layout="in-article"
             data-ad-format="fluid"
             data-ad-client="ca-pub-9195262048954682"
             data-ad-slot="5294962935"></ins>
        <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>
</article>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // è·å–URLå‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    const answer_id = urlParams.get('answer_id');
    
    if (!answer_id) {
        document.getElementById('score-description').textContent = 'æœªæ‰¾åˆ°æµ‹è¯•ç»“æœ';
        document.getElementById('score-level').textContent = '';
        return;
    }
    
    // è·å–URLå‚æ•°ä¸­çš„è¯­è¨€
    const lg = urlParams.get('lg') || 'zh-cn';
    
    // è·å–æµ‹è¯•ç»“æœ
    fetch('/addons/cms/psychometry/answerInfo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'answer_id=' + answer_id + '&lang=' + lg
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 1) {
            displayScoreResult(data.data);
        } else {
            document.getElementById('score-description').textContent = 'è·å–ç»“æœå¤±è´¥ï¼š' + data.msg;
            document.getElementById('score-level').textContent = '';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('score-description').textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
        document.getElementById('score-level').textContent = '';
    });
});

function displayScoreResult(data) {
    // è·å–è¯­è¨€å‚æ•°
    const lg = new URLSearchParams(window.location.search).get('lg');
    const isEnglish = lg === 'en';
    
    // æ›´æ–°UIè¯­è¨€
    updateUILanguage(isEnglish, data);
    
    // æ›´æ–°é¡µé¢æ ‡é¢˜
    if (data.a_info) {
        document.getElementById('test-title').textContent = data.a_info.title || (isEnglish ? 'Score Test Result' : 'åˆ†æ•°æµ‹è¯•ç»“æœ');
    }
    
    // æ˜¾ç¤ºæ€»åˆ†
    const totalScore = data.max_score || 0;
    document.getElementById('total-score').textContent = totalScore;
    
    // æ˜¾ç¤ºå¾—åˆ†æè¿°å’Œç­‰çº§
    const scoreInfo = getScoreInfo(totalScore, data, isEnglish);
    document.getElementById('score-description').innerHTML = scoreInfo.description;
    document.getElementById('score-level').textContent = scoreInfo.level;
    
    // æ˜¾ç¤ºæµ‹è¯•ä¿¡æ¯
    displayTestInfo(data, isEnglish);
    
    // æ˜¾ç¤ºåˆ†æå†…å®¹
    displayAnalysis(data, isEnglish);
    
    // æ˜¾ç¤ºå»ºè®®å’ŒæŒ‡å¯¼
    displaySuggestions(data, isEnglish);
}

// æ›´æ–°UIè¯­è¨€
function updateUILanguage(isEnglish, data) {
    const texts = {
        zh: {
            testResult: 'æµ‹è¯•ç»“æœ',
            testInfo: 'æµ‹è¯•ä¿¡æ¯',
            totalScore: 'æ€»åˆ†',
            analysisReport: 'è¯¦ç»†åˆ†ææŠ¥å‘Š',
            suggestions: 'å»ºè®®å’ŒæŒ‡å¯¼',
            loading: 'æ­£åœ¨è®¡ç®—æ‚¨çš„å¾—åˆ†...',
            evaluating: 'è¯„ä¼°ä¸­...',
            testName: 'æµ‹è¯•åç§°ï¼š',
            testDescription: 'æµ‹è¯•è¯´æ˜ï¼š',
            questionCount: 'é¢˜ç›®æ•°é‡ï¼š',
            maxScore: 'æ»¡åˆ†ï¼š',
            testType: 'æµ‹è¯•ç±»å‹ï¼š',
            scoreTest: 'åˆ†æ•°æµ‹è¯•',
            questions: ' é¢˜',
            score: ' åˆ†',
            yourScore: 'æ‚¨çš„æ€»å¾—åˆ†ä¸ºï¼š',
            scoreRate: 'å¾—åˆ†ç‡ä¸ºï¼š',
            resultExplanation: 'ç»“æœè¯´æ˜',
            referenceNote: 'æµ‹è¯•ç»“æœä»…ä¾›å‚è€ƒï¼Œå¦‚éœ€ä¸“ä¸šæŒ‡å¯¼ï¼Œè¯·å’¨è¯¢ç›¸å…³é¢†åŸŸçš„ä¸“å®¶ã€‚',
            excellent: 'ä¼˜ç§€',
            excellentDesc: 'æ‚¨çš„å¾—åˆ†éå¸¸ä¼˜ç§€ï¼',
            good: 'è‰¯å¥½',
            goodDesc: 'æ‚¨çš„å¾—åˆ†è¡¨ç°è‰¯å¥½ã€‚',
            average: 'ä¸­ç­‰',
            averageDesc: 'æ‚¨çš„å¾—åˆ†å¤„äºä¸­ç­‰æ°´å¹³ã€‚',
            pass: 'åŠæ ¼',
            passDesc: 'æ‚¨çš„å¾—åˆ†è¾¾åˆ°åŠæ ¼æ°´å¹³ã€‚',
            needImprovement: 'éœ€è¦æ”¹è¿›',
            needImprovementDesc: 'æ‚¨çš„å¾—åˆ†è¿˜æœ‰æå‡ç©ºé—´ã€‚',
            generalSuggestions: 'ğŸ’¡ é€šç”¨å»ºè®®',
            notes: 'ğŸ“ æ³¨æ„äº‹é¡¹',
            defaultDescription: 'é€šè¿‡ä¸“ä¸šçš„å¿ƒç†å­¦é‡è¡¨ï¼Œå¸®åŠ©æ‚¨äº†è§£è‡ªå·±åœ¨ç›¸å…³æ–¹é¢çš„è¡¨ç°å’Œæ°´å¹³ã€‚'
        },
        en: {
            testResult: 'Test Result',
            testInfo: 'Test Information',
            totalScore: 'Total Score',
            analysisReport: 'Detailed Analysis Report',
            suggestions: 'Suggestions',
            loading: 'Calculating your score...',
            evaluating: 'Evaluating...',
            testName: 'Test Name: ',
            testDescription: 'Description: ',
            questionCount: 'Questions: ',
            maxScore: 'Max Score: ',
            testType: 'Test Type: ',
            scoreTest: 'Score Test',
            questions: ' questions',
            score: ' points',
            yourScore: 'Your total score: ',
            scoreRate: 'Score rate: ',
            resultExplanation: 'Result Explanation',
            referenceNote: 'Test results are for reference only. Please consult a professional for specific guidance.',
            excellent: 'Excellent',
            excellentDesc: 'Your score is excellent!',
            good: 'Good',
            goodDesc: 'Your score is good.',
            average: 'Average',
            averageDesc: 'Your score is at an average level.',
            pass: 'Pass',
            passDesc: 'Your score meets the passing standard.',
            needImprovement: 'Need Improvement',
            needImprovementDesc: 'Your score has room for improvement.',
            generalSuggestions: 'ğŸ’¡ General Suggestions',
            notes: 'ğŸ“ Notes',
            defaultDescription: 'Through professional psychological scales, help you understand your performance and level in related aspects.'
        }
    };
    
    const t = isEnglish ? texts.en : texts.zh;
    
    // æ›´æ–°å„ä¸ªåŒºåŸŸæ ‡é¢˜
    document.getElementById('info-header-title').textContent = t.testInfo;
    document.getElementById('score-label').textContent = t.totalScore;
    document.getElementById('analysis-header-title').textContent = t.analysisReport;
    document.getElementById('suggestions-header-title').textContent = t.suggestions;
    
    // ä¿å­˜æ–‡æœ¬åˆ°å…¨å±€å˜é‡ï¼Œä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
    window.i18nTexts = t;
}

function getScoreInfo(score, data, isEnglish) {
    const t = window.i18nTexts;
    
    // å¦‚æœæœ‰analyseæ•°æ®ï¼Œä¼˜å…ˆä½¿ç”¨
    if (data.analyse && data.analyse.title) {
        return {
            level: data.analyse.title,
            description: data.analyse.intro || t.referenceNote
        };
    }
    
    // æ ¹æ®åˆ†æ•°èŒƒå›´æä¾›é€šç”¨è¯„ä¼°
    const maxScore = data.max_score || 100;
    const percentage = (score / maxScore) * 100;
    
    if (percentage >= 90) {
        return {
            level: t.excellent,
            description: t.excellentDesc
        };
    } else if (percentage >= 80) {
        return {
            level: t.good,
            description: t.goodDesc
        };
    } else if (percentage >= 70) {
        return {
            level: t.average,
            description: t.averageDesc
        };
    } else if (percentage >= 60) {
        return {
            level: t.pass,
            description: t.passDesc
        };
    } else {
        return {
            level: t.needImprovement,
            description: t.needImprovementDesc
        };
    }
}

function displayTestInfo(data, isEnglish) {
    const t = window.i18nTexts;
    let infoHtml = '';
    
    if (data.a_info) {
        const testTitle = data.a_info.title || t.scoreTest;

        // ä¼˜å…ˆä½¿ç”¨sub_titleï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨descriptionï¼Œæœ€åä½¿ç”¨é»˜è®¤æè¿°
        let description = data.a_info.sub_title || data.a_info.description || '';
        if (description === 'é»˜è®¤æè¿°' || description === '') {
            description = t.defaultDescription;
        }

        const questionCount = data.test_info?.question_count || 0;
        const maxScorePerQuestion = 1;
        const theoreticalMaxScore = questionCount * maxScorePerQuestion;

        infoHtml += '<div class="divide-y divide-gray-200 overflow-hidden rounded-xl border border-gray-200 bg-white">';
        infoHtml += '<div class="flex items-center justify-between gap-4 px-4 py-3 text-sm"><span class="font-semibold text-gray-700">' + t.testName.replace(/[:ï¼š]\s*$/, '') + '</span><span class="text-gray-600">' + testTitle + '</span></div>';
        infoHtml += '<div class="flex items-center justify-between gap-4 px-4 py-3 text-sm"><span class="font-semibold text-gray-700">' + t.testDescription.replace(/[:ï¼š]\s*$/, '') + '</span><span class="text-gray-600">' + description + '</span></div>';
        infoHtml += '<div class="flex items-center justify-between gap-4 px-4 py-3 text-sm"><span class="font-semibold text-gray-700">' + t.questionCount.replace(/[:ï¼š]\s*$/, '') + '</span><span class="text-gray-600">' + questionCount + t.questions + '</span></div>';
        infoHtml += '<div class="flex items-center justify-between gap-4 px-4 py-3 text-sm"><span class="font-semibold text-gray-700">' + t.maxScore.replace(/[:ï¼š]\s*$/, '') + '</span><span class="text-gray-600">' + theoreticalMaxScore + t.score + '</span></div>';
        infoHtml += '<div class="flex items-center justify-between gap-4 px-4 py-3 text-sm"><span class="font-semibold text-gray-700">' + t.testType.replace(/[:ï¼š]\s*$/, '') + '</span><span class="text-gray-600">' + t.scoreTest + '</span></div>';
        infoHtml += '</div>';
    }
    
    document.getElementById('info-content').innerHTML = infoHtml;
}

function displayAnalysis(data, isEnglish) {
    const t = window.i18nTexts;
    let analysisHtml = '';
    
    // å¦‚æœæœ‰analyseæ•°æ®ï¼Œä¼˜å…ˆæ˜¾ç¤º
    if (data.analyse && data.analyse.content) {
        analysisHtml = data.analyse.content;
    } else if (data.analyse && data.analyse.analysis) {
        analysisHtml = data.analyse.analysis;
    } else {
        // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
        const totalScore = data.max_score || 0;
        const percentage = totalScore > 0 ? Math.round((totalScore / data.max_score) * 100) : 0;
        
        analysisHtml = `
            <h4>${t.testResult}</h4>
            <p>${t.yourScore}<strong>${totalScore}</strong>${t.score}</p>
            <p>${t.scoreRate}<strong>${percentage}%</strong></p>
            
            <h4>${t.resultExplanation}</h4>
            <p>${t.referenceNote}</p>
        `;
    }
    
    document.getElementById('analysis-content').innerHTML = analysisHtml;
}

function displaySuggestions(data, isEnglish) {
    const t = window.i18nTexts;
    let suggestionsHtml = '';
    
    // å¦‚æœæœ‰analyseæ•°æ®ä¸­çš„å»ºè®®ï¼Œä¼˜å…ˆæ˜¾ç¤º
    if (data.analyse && data.analyse.suggestion) {
        suggestionsHtml = data.analyse.suggestion;
    } else {
        // æ˜¾ç¤ºé€šç”¨å»ºè®®ï¼ˆå¤šè¯­è¨€ï¼‰
        if (isEnglish) {
            suggestionsHtml = `
                <h4>ğŸ’¡ General Suggestions</h4>
                <ul>
                    <li>Understand your current status based on test results</li>
                    <li>Consult relevant professionals if you have any questions</li>
                    <li>Maintain a positive mindset and continue to focus on personal development</li>
                    <li>Conduct regular self-assessment and reflection</li>
                </ul>
                
                <h4>ğŸ“ Notes</h4>
                <p>Test results are for reference only. Please consult a professional for specific guidance.</p>
            `;
        } else {
            suggestionsHtml = `
                <h4>ğŸ’¡ é€šç”¨å»ºè®®</h4>
                <ul>
                    <li>æ ¹æ®æµ‹è¯•ç»“æœï¼Œäº†è§£è‡ªå·±çš„ç°çŠ¶</li>
                    <li>å¦‚æœ‰ç–‘é—®ï¼Œå»ºè®®å’¨è¯¢ç›¸å…³ä¸“ä¸šäººå£«</li>
                    <li>ä¿æŒç§¯æçš„å¿ƒæ€ï¼ŒæŒç»­å…³æ³¨è‡ªèº«å‘å±•</li>
                    <li>å®šæœŸè¿›è¡Œè‡ªæˆ‘è¯„ä¼°å’Œåæ€</li>
                </ul>
                
                <h4>ğŸ“ æ³¨æ„äº‹é¡¹</h4>
                <p>æµ‹è¯•ç»“æœä»…ä¾›å‚è€ƒï¼Œå…·ä½“è¯·å’¨è¯¢ä¸“ä¸šæŒ‡å¯¼ã€‚</p>
            `;
        }
    }
    
    document.getElementById('suggestions-content').innerHTML = suggestionsHtml;
}

// æŠ˜å åŠŸèƒ½
function toggleTestInfo() {
    const content = document.getElementById('info-content');
    const icon = document.getElementById('test-info-icon');
    
    if (!content || !icon) {
        console.error('æ— æ³•æ‰¾åˆ°æµ‹è¯•ä¿¡æ¯å…ƒç´ ');
        return;
    }

    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.textContent = 'â–²';
    } else {
        content.classList.add('hidden');
        icon.textContent = 'â–¼';
    }
}

</script>
