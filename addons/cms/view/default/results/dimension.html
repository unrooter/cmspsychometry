{extend name="common/layout" /}

{block name="content"}
<div class="mx-auto max-w-7xl px-4 py-10 sm:px-6 lg:px-8">
    <div id="app" class="hidden">
        <!-- 加载状态 -->
        <div v-if="loading" class="flex flex-col items-center justify-center py-16 text-center">
            <div class="h-10 w-10 animate-spin rounded-full border-4 border-gray-200 border-t-black" role="status"></div>
            <p class="mt-4 text-sm text-gray-600">正在加载测试结果...</p>
        </div>

        <!-- 错误状态 -->
        <div v-if="error" class="my-10 ui-card border border-red-200 bg-red-50 text-center">
            <div class="ui-card-body">
                <h4 class="text-base font-semibold text-red-800">加载失败</h4>
                <p class="mt-2 text-sm text-red-700">{{error}}</p>
                <button @click="loadData" class="mt-4 inline-flex items-center rounded-md bg-black px-4 py-2 text-sm font-semibold text-white hover:bg-black/90">重新加载</button>
            </div>
        </div>

        <!-- 维度结果内容 -->
        <div v-if="!loading && !error && allInfo" class="dimension-result-container">
            <!-- 测试信息头部 -->
            <div class="mb-6 ui-card bg-black text-center text-white">
                <div class="ui-card-body p-8 sm:p-10">
                <h1 class="text-2xl font-bold drop-shadow-sm sm:text-4xl">
                    维度分析结果
                </h1>
                <p class="mt-2 text-base opacity-90 sm:text-lg">多维度性格特征分析</p>
                <div v-if="allInfo.a_info" class="mt-3 text-sm opacity-80 sm:text-base">
                    {{allInfo.a_info.title}}
                </div>
                </div>
            </div>

            <!-- 维度雷达图 -->
            <div class="mb-6 ui-card">
                <div class="ui-card-header text-center">
                    <h3 class="text-base font-semibold text-gray-900">维度对比图</h3>
                </div>
                <div class="ui-card-body">
                    <div class="mx-auto max-w-2xl">
                        <canvas id="dimensionChart" class="h-72 w-full"></canvas>
                    </div>
                </div>
            </div>

            <!-- 维度分数详情 -->
            <div v-if="allInfo.stat_data && Object.keys(allInfo.stat_data).length > 0" class="mb-6 ui-card">
                <div class="ui-card-header text-center">
                    <h3 class="text-base font-semibold text-gray-900">各维度得分</h3>
                </div>
                <div class="ui-card-body">
                <div class="grid gap-4 sm:grid-cols-2">
                    <div v-for="(value, key) in allInfo.stat_data" :key="key">
                        <div class="rounded-xl border-l-4 border-black bg-gray-50 p-5">
                            <div class="flex items-center justify-between gap-3">
                                <h5 class="text-sm font-semibold text-gray-900 sm:text-base">{{getDimensionName(key)}}</h5>
                                <span class="text-lg font-bold text-gray-900">{{value}}</span>
                            </div>
                            <div class="mt-3 h-3 overflow-hidden rounded-full bg-gray-200">
                                <div class="h-full bg-black transition-all duration-700" :style="{ width: getDimensionPercentage(value) + '%' }"></div>
                            </div>
                            <div class="mt-3 text-sm leading-6 text-gray-600">{{getDimensionDescription(key, value)}}</div>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- 维度分析 -->
            <div class="mb-6 ui-card">
                <div class="ui-card-header text-center">
                    <h3 class="text-base font-semibold text-gray-900">维度分析</h3>
                </div>
                <div class="ui-card-body">
                
                <!-- 最高分维度 -->
                <div v-if="getHighestDimension()" class="mb-5 rounded-xl border-l-4 border-black bg-gray-50 p-5">
                    <h5 class="mb-2 text-base font-semibold text-gray-900">最强维度：{{getHighestDimension().name}}</h5>
                    <div class="text-sm leading-7 text-gray-700">
                        您在 {{getHighestDimension().name}} 方面表现最为突出，得分为 {{getHighestDimension().value}} 分。
                        {{getDimensionDescription(getHighestDimension().key, getHighestDimension().value)}}
                    </div>
                </div>
                
                <!-- 最低分维度 -->
                <div v-if="getLowestDimension()" class="mb-5 rounded-xl border-l-4 border-amber-400 bg-amber-50 p-5">
                    <h5 class="mb-2 text-base font-semibold text-amber-800">待提升维度：{{getLowestDimension().name}}</h5>
                    <div class="text-sm leading-7 text-gray-700">
                        您在 {{getLowestDimension().name}} 方面还有提升空间，得分为 {{getLowestDimension().value}} 分。
                        建议您在这方面多加练习和关注。
                    </div>
                </div>
                
                <!-- 整体分析 -->
                <div class="rounded-xl bg-gray-50 p-5">
                    <h5 class="mb-2 text-base font-semibold text-gray-900">整体分析</h5>
                    <div class="text-sm leading-7 text-gray-700">
                        {{getOverallAnalysis()}}
                    </div>
                </div>
                </div>
            </div>

            <!-- 结果解析 -->
            <div v-if="allInfo.answer_info" class="mb-6 ui-card">
                <div class="ui-card-header text-center">
                    <h3 class="text-base font-semibold text-gray-900">结果解析</h3>
                </div>
                <div class="ui-card-body">
                
                <!-- 主要结果 -->
                <div v-if="allInfo.answer_info.title" class="mb-6 rounded-xl bg-gray-50 p-5">
                    <h5 class="mb-2 text-base font-semibold text-gray-900">测试结果</h5>
                    <div class="text-sm leading-7 text-gray-600">{{allInfo.answer_info.title}}</div>
                </div>
                
                <!-- 详细分析 -->
                <div v-if="allInfo.answer_info.content" class="mb-6 rounded-xl bg-gray-50 p-5">
                    <h5 class="mb-2 text-base font-semibold text-gray-900">详细分析</h5>
                    <div class="prose max-w-none text-sm leading-7 text-gray-600" v-html="allInfo.answer_info.content"></div>
                </div>
                
                <!-- 建议 -->
                <div v-if="allInfo.answer_info.suggestion" class="rounded-xl border-l-4 border-black bg-gray-50 p-5">
                    <h5 class="mb-2 text-base font-semibold text-gray-900">发展建议</h5>
                    <div class="prose max-w-none text-sm leading-7 text-gray-600" v-html="allInfo.answer_info.suggestion"></div>
                </div>
                </div>
            </div>

            <!-- 测试总结 -->
            <div class="ui-card bg-gray-50">
                <div class="ui-card-header text-center">
                    <h3 class="text-base font-semibold text-gray-900">测试总结</h3>
                </div>
                <div class="ui-card-body">
                    <div class="grid gap-4 sm:grid-cols-3">
                        <div class="bg-white p-4 text-center ring-1 ring-gray-100">
                            <div class="text-2xl font-bold text-gray-900 sm:text-3xl">{{Object.keys(allInfo.stat_data || {}).length}}</div>
                            <div class="mt-1 text-sm text-gray-600">分析维度</div>
                        </div>
                        <div class="bg-white p-4 text-center ring-1 ring-gray-100">
                            <div class="text-2xl font-bold text-gray-900 sm:text-3xl">{{allInfo.max_score || 0}}</div>
                            <div class="mt-1 text-sm text-gray-600">总分数</div>
                        </div>
                        <div class="bg-white p-4 text-center ring-1 ring-gray-100">
                            <div class="text-2xl font-bold text-gray-900 sm:text-3xl">{{getAverageScore()}}</div>
                            <div class="mt-1 text-sm text-gray-600">平均分</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
new Vue({
    el: '#app',
    data: {
        loading: true,
        error: null,
        allInfo: null
    },
    mounted() {
        this.$el.classList.remove('hidden');
        this.loadData();
    },
    methods: {
        loadData() {
            this.loading = true;
            this.error = null;
            
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const answer_id = urlParams.get('answer_id');
            
            if (!answer_id) {
                this.error = '缺少测试结果ID';
                this.loading = false;
                return;
            }
            
            // 调用API获取数据
            fetch('/addons/cms/psychometry/answerInfo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'answer_id=' + answer_id
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 1) {
                    this.allInfo = data.data;
                    this.$nextTick(() => {
                        this.drawDimensionChart();
                    });
                } else {
                    this.error = data.msg || '获取数据失败';
                }
                this.loading = false;
            })
            .catch(error => {
                this.error = '网络错误：' + error.message;
                this.loading = false;
            });
        },
        
        drawDimensionChart() {
            if (!this.allInfo || !this.allInfo.stat_data) return;
            
            const ctx = document.getElementById('dimensionChart').getContext('2d');
            const labels = Object.keys(this.allInfo.stat_data);
            const values = Object.values(this.allInfo.stat_data);
            const maxValue = Math.max(...values);
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels.map(key => this.getDimensionName(key)),
                    datasets: [{
                        label: '您的得分',
                        data: values,
                        backgroundColor: 'rgba(17, 17, 17, 0.12)',
                        borderColor: 'rgba(17, 17, 17, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(17, 17, 17, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(17, 17, 17, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: maxValue * 1.2,
                            ticks: {
                                stepSize: Math.ceil(maxValue / 5)
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        },
        
        getDimensionName(key) {
            const names = {
                '外向性': '外向性',
                '内向性': '内向性',
                '感觉': '感觉',
                '直觉': '直觉',
                '思考': '思考',
                '情感': '情感',
                '判断': '判断',
                '知觉': '知觉'
            };
            return names[key] || key;
        },
        
        getDimensionPercentage(value) {
            const maxValue = this.allInfo ? Math.max(...Object.values(this.allInfo.stat_data || {})) : 100;
            return Math.min((value / maxValue) * 100, 100);
        },
        
        getDimensionDescription(key, value) {
            // 根据维度和分数返回描述
            return `您在${key}方面得分为${value}分，表现${value > 70 ? '优秀' : value > 50 ? '良好' : '一般'}。`;
        },
        
        getHighestDimension() {
            if (!this.allInfo || !this.allInfo.stat_data) return null;
            const entries = Object.entries(this.allInfo.stat_data);
            const highest = entries.reduce((max, [key, value]) => value > max.value ? {key, value, name: this.getDimensionName(key)} : max, {key: '', value: 0, name: ''});
            return highest.value > 0 ? highest : null;
        },
        
        getLowestDimension() {
            if (!this.allInfo || !this.allInfo.stat_data) return null;
            const entries = Object.entries(this.allInfo.stat_data);
            const lowest = entries.reduce((min, [key, value]) => value < min.value ? {key, value, name: this.getDimensionName(key)} : min, {key: '', value: Infinity, name: ''});
            return lowest.value < Infinity ? lowest : null;
        },
        
        getOverallAnalysis() {
            if (!this.allInfo || !this.allInfo.stat_data) return '暂无分析数据。';
            
            const values = Object.values(this.allInfo.stat_data);
            const average = values.reduce((sum, val) => sum + val, 0) / values.length;
            const max = Math.max(...values);
            const min = Math.min(...values);
            
            let analysis = `您的平均得分为${average.toFixed(1)}分，`;
            if (max - min < 10) {
                analysis += '各维度发展较为均衡，';
            } else if (max - min > 20) {
                analysis += '各维度发展差异较大，';
            } else {
                analysis += '各维度发展有一定差异，';
            }
            
            if (average > 70) {
                analysis += '整体表现优秀。';
            } else if (average > 50) {
                analysis += '整体表现良好。';
            } else {
                analysis += '整体表现有待提升。';
            }
            
            return analysis;
        },
        
        getAverageScore() {
            if (!this.allInfo || !this.allInfo.stat_data) return 0;
            const values = Object.values(this.allInfo.stat_data);
            return (values.reduce((sum, val) => sum + val, 0) / values.length).toFixed(1);
        }
    }
});
</script>
{/block}
