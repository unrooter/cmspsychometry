{extend name="common/layout" /}

{block name="content"}
<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <div id="app">
        <!-- 加载状态 -->
        <div v-if="loading" class="text-center" style="padding: 50px;">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">加载中...</span>
            </div>
            <p class="mt-3">正在加载测试结果...</p>
        </div>

        <!-- 错误状态 -->
        <div v-if="error" class="alert alert-danger text-center" style="margin: 50px 0;">
            <h4>加载失败</h4>
            <p>{{error}}</p>
            <button @click="loadData" class="btn btn-primary">重新加载</button>
        </div>

        <!-- 维度结果内容 -->
        <div v-if="!loading && !error && allInfo" class="dimension-result-container">
            <!-- 测试信息头部 -->
            <div class="test-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 20px; margin-bottom: 30px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                <h1 style="font-size: 36px; font-weight: bold; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                    维度分析结果
                </h1>
                <p style="font-size: 18px; margin: 0; opacity: 0.9;">多维度性格特征分析</p>
                <div v-if="allInfo.a_info" style="margin-top: 15px; font-size: 16px; opacity: 0.8;">
                    {{allInfo.a_info.title}}
                </div>
            </div>

            <!-- 维度雷达图 -->
            <div class="dimension-chart" style="background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="color: #333; margin-bottom: 25px; font-size: 24px; text-align: center;">维度对比图</h3>
                <div style="text-align: center;">
                    <canvas id="dimensionChart" width="400" height="400" style="max-width: 100%; height: auto;"></canvas>
                </div>
            </div>

            <!-- 维度分数详情 -->
            <div v-if="allInfo.stat_data && Object.keys(allInfo.stat_data).length > 0" class="dimension-scores" style="background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="color: #333; margin-bottom: 25px; font-size: 24px; text-align: center;">各维度得分</h3>
                <div class="row">
                    <div class="col-md-6" v-for="(value, key) in allInfo.stat_data" :key="key" style="margin-bottom: 20px;">
                        <div class="dimension-item" style="background: #f8f9fa; padding: 20px; border-radius: 12px; border-left: 5px solid #5DBE9E;">
                            <div class="dimension-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h5 style="color: #333; margin: 0; font-size: 18px;">{{getDimensionName(key)}}</h5>
                                <span style="font-size: 20px; font-weight: bold; color: #2E7D5F;">{{value}}</span>
                            </div>
                            <div class="dimension-bar" style="background: #e9ecef; height: 12px; border-radius: 6px; overflow: hidden; position: relative;">
                                <div :style="'background: linear-gradient(90deg, #5DBE9E, #28a745); height: 100%; width: ' + getDimensionPercentage(value) + '%; transition: width 1s ease;'"></div>
                            </div>
                            <div class="dimension-description" style="margin-top: 10px; font-size: 14px; color: #666;">
                                {{getDimensionDescription(key, value)}}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 维度分析 -->
            <div class="dimension-analysis" style="background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="color: #333; margin-bottom: 25px; font-size: 24px; text-align: center;">维度分析</h3>
                
                <!-- 最高分维度 -->
                <div v-if="getHighestDimension()" style="background: #e8f5e8; padding: 25px; border-radius: 12px; border-left: 5px solid #5DBE9E; margin-bottom: 20px;">
                    <h5 style="color: #5DBE9E; margin-bottom: 15px; font-size: 18px;">最强维度：{{getHighestDimension().name}}</h5>
                    <div style="color: #666; line-height: 1.8; font-size: 16px;">
                        您在 {{getHighestDimension().name}} 方面表现最为突出，得分为 {{getHighestDimension().value}} 分。
                        {{getDimensionDescription(getHighestDimension().key, getHighestDimension().value)}}
                    </div>
                </div>
                
                <!-- 最低分维度 -->
                <div v-if="getLowestDimension()" style="background: #fff3cd; padding: 25px; border-radius: 12px; border-left: 5px solid #ffc107; margin-bottom: 20px;">
                    <h5 style="color: #856404; margin-bottom: 15px; font-size: 18px;">待提升维度：{{getLowestDimension().name}}</h5>
                    <div style="color: #666; line-height: 1.8; font-size: 16px;">
                        您在 {{getLowestDimension().name}} 方面还有提升空间，得分为 {{getLowestDimension().value}} 分。
                        建议您在这方面多加练习和关注。
                    </div>
                </div>
                
                <!-- 整体分析 -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 12px;">
                    <h5 style="color: #5DBE9E; margin-bottom: 15px; font-size: 18px;">整体分析</h5>
                    <div style="color: #666; line-height: 1.8; font-size: 16px;">
                        {{getOverallAnalysis()}}
                    </div>
                </div>
            </div>

            <!-- 结果解析 -->
            <div v-if="allInfo.answer_info" class="result-analysis" style="background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="color: #333; margin-bottom: 25px; font-size: 24px; text-align: center;">结果解析</h3>
                
                <!-- 主要结果 -->
                <div v-if="allInfo.answer_info.title" style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                    <h5 style="color: #5DBE9E; margin-bottom: 15px; font-size: 18px;">测试结果</h5>
                    <div style="color: #666; line-height: 1.8; font-size: 16px;">{{allInfo.answer_info.title}}</div>
                </div>
                
                <!-- 详细分析 -->
                <div v-if="allInfo.answer_info.content" style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                    <h5 style="color: #5DBE9E; margin-bottom: 15px; font-size: 18px;">详细分析</h5>
                    <div style="color: #666; line-height: 1.8; font-size: 16px;" v-html="allInfo.answer_info.content"></div>
                </div>
                
                <!-- 建议 -->
                <div v-if="allInfo.answer_info.suggestion" style="background: #e8f5e8; padding: 25px; border-radius: 12px; border-left: 5px solid #5DBE9E;">
                    <h5 style="color: #5DBE9E; margin-bottom: 15px; font-size: 18px;">发展建议</h5>
                    <div style="color: #666; line-height: 1.8; font-size: 16px;" v-html="allInfo.answer_info.suggestion"></div>
                </div>
            </div>

            <!-- 测试总结 -->
            <div class="test-summary" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <h3 style="color: white; margin-bottom: 20px; font-size: 24px;">测试总结</h3>
                <div class="row">
                    <div class="col-md-4">
                        <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">{{Object.keys(allInfo.stat_data || {}).length}}</div>
                        <div style="font-size: 16px; opacity: 0.9;">分析维度</div>
                    </div>
                    <div class="col-md-4">
                        <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">{{allInfo.max_score || 0}}</div>
                        <div style="font-size: 16px; opacity: 0.9;">总分数</div>
                    </div>
                    <div class="col-md-4">
                        <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">{{getAverageScore()}}</div>
                        <div style="font-size: 16px; opacity: 0.9;">平均分</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
new Vue({
    el: '#app',
    data: {
        loading: true,
        error: null,
        allInfo: null
    },
    mounted() {
        this.loadData();
    },
    methods: {
        loadData() {
            this.loading = true;
            this.error = null;
            
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const answer_id = urlParams.get('answer_id');
            
            if (!answer_id) {
                this.error = '缺少测试结果ID';
                this.loading = false;
                return;
            }
            
            // 调用API获取数据
            fetch('/addons/cms/psychometry/answerInfo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'answer_id=' + answer_id
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 1) {
                    this.allInfo = data.data;
                    this.$nextTick(() => {
                        this.drawDimensionChart();
                    });
                } else {
                    this.error = data.msg || '获取数据失败';
                }
                this.loading = false;
            })
            .catch(error => {
                this.error = '网络错误：' + error.message;
                this.loading = false;
            });
        },
        
        drawDimensionChart() {
            if (!this.allInfo || !this.allInfo.stat_data) return;
            
            const ctx = document.getElementById('dimensionChart').getContext('2d');
            const labels = Object.keys(this.allInfo.stat_data);
            const values = Object.values(this.allInfo.stat_data);
            const maxValue = Math.max(...values);
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels.map(key => this.getDimensionName(key)),
                    datasets: [{
                        label: '您的得分',
                        data: values,
                        backgroundColor: 'rgba(93, 190, 158, 0.2)',
                        borderColor: 'rgba(93, 190, 158, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(93, 190, 158, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(93, 190, 158, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: maxValue * 1.2,
                            ticks: {
                                stepSize: Math.ceil(maxValue / 5)
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        },
        
        getDimensionName(key) {
            const names = {
                '外向性': '外向性',
                '内向性': '内向性',
                '感觉': '感觉',
                '直觉': '直觉',
                '思考': '思考',
                '情感': '情感',
                '判断': '判断',
                '知觉': '知觉'
            };
            return names[key] || key;
        },
        
        getDimensionPercentage(value) {
            const maxValue = this.allInfo ? Math.max(...Object.values(this.allInfo.stat_data || {})) : 100;
            return Math.min((value / maxValue) * 100, 100);
        },
        
        getDimensionDescription(key, value) {
            // 根据维度和分数返回描述
            return `您在${key}方面得分为${value}分，表现${value > 70 ? '优秀' : value > 50 ? '良好' : '一般'}。`;
        },
        
        getHighestDimension() {
            if (!this.allInfo || !this.allInfo.stat_data) return null;
            const entries = Object.entries(this.allInfo.stat_data);
            const highest = entries.reduce((max, [key, value]) => value > max.value ? {key, value, name: this.getDimensionName(key)} : max, {key: '', value: 0, name: ''});
            return highest.value > 0 ? highest : null;
        },
        
        getLowestDimension() {
            if (!this.allInfo || !this.allInfo.stat_data) return null;
            const entries = Object.entries(this.allInfo.stat_data);
            const lowest = entries.reduce((min, [key, value]) => value < min.value ? {key, value, name: this.getDimensionName(key)} : min, {key: '', value: Infinity, name: ''});
            return lowest.value < Infinity ? lowest : null;
        },
        
        getOverallAnalysis() {
            if (!this.allInfo || !this.allInfo.stat_data) return '暂无分析数据。';
            
            const values = Object.values(this.allInfo.stat_data);
            const average = values.reduce((sum, val) => sum + val, 0) / values.length;
            const max = Math.max(...values);
            const min = Math.min(...values);
            
            let analysis = `您的平均得分为${average.toFixed(1)}分，`;
            if (max - min < 10) {
                analysis += '各维度发展较为均衡，';
            } else if (max - min > 20) {
                analysis += '各维度发展差异较大，';
            } else {
                analysis += '各维度发展有一定差异，';
            }
            
            if (average > 70) {
                analysis += '整体表现优秀。';
            } else if (average > 50) {
                analysis += '整体表现良好。';
            } else {
                analysis += '整体表现有待提升。';
            }
            
            return analysis;
        },
        
        getAverageScore() {
            if (!this.allInfo || !this.allInfo.stat_data) return 0;
            const values = Object.values(this.allInfo.stat_data);
            return (values.reduce((sum, val) => sum + val, 0) / values.length).toFixed(1);
        }
    }
});
</script>
{/block}
