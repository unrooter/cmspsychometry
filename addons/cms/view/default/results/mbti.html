{extend name="common/layout" /}

{block name="content"}
<div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
    <div id="app" class="hidden">
        <!-- 加载状态 -->
        <div v-if="loading" class="flex flex-col items-center justify-center py-16 text-center">
            <div class="h-10 w-10 animate-spin rounded-full border-4 border-gray-200 border-t-emerald-600" role="status"></div>
            <p class="mt-4 text-sm text-gray-600">正在加载测试结果...</p>
        </div>

        <!-- 错误状态 -->
        <div v-if="error" class="my-10 rounded-lg border border-red-200 bg-red-50 p-6 text-center">
            <h4 class="text-base font-semibold text-red-800">加载失败</h4>
            <p class="mt-2 text-sm text-red-700">{{error}}</p>
            <button @click="loadData" class="mt-4 inline-flex items-center rounded-md bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700">重新加载</button>
        </div>

        <!-- MBTI结果内容 -->
        <div v-if="!loading && !error && allInfo" class="mbti-result-container">
            <!-- 测试信息头部 -->
            <div class="mb-8 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 p-8 text-center text-white shadow-lg sm:p-10">
                <h1 class="text-3xl font-bold drop-shadow-sm sm:text-5xl">
                    {{allInfo.answer_info.mbti_type || 'MBTI'}}
                </h1>
                <p class="mt-2 text-base opacity-90 sm:text-lg">您的MBTI性格类型</p>
                <div v-if="allInfo.a_info" class="mt-3 text-sm opacity-80 sm:text-base">
                    {{allInfo.a_info.title}}
                </div>
            </div>

            <!-- 维度分数展示 -->
            <div class="mb-8 rounded-2xl bg-white p-6 shadow-sm ring-1 ring-gray-100 sm:p-8">
                <h3 class="mb-6 text-center text-lg font-semibold text-gray-900 sm:text-2xl">性格维度分析</h3>
                <div class="grid gap-4 sm:grid-cols-2">
                    <div v-for="(value, key) in allInfo.stat_data" :key="key">
                        <div class="rounded-xl border-l-4 border-emerald-500 bg-gray-50 p-5">
                            <div class="flex items-center justify-between gap-3">
                                <h5 class="text-sm font-semibold text-gray-900 sm:text-base">{{getDimensionName(key)}}</h5>
                                <span class="text-lg font-bold text-emerald-700">{{value}}</span>
                            </div>
                            <div class="mt-3 h-3 overflow-hidden rounded-full bg-gray-200">
                                <div class="h-full bg-gradient-to-r from-emerald-500 to-green-500 transition-all duration-700" :style="{ width: getDimensionPercentage(value) + '%' }"></div>
                            </div>
                            <div class="mt-3 text-sm leading-6 text-gray-600">{{getDimensionDescription(key, value)}}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MBTI详细解析 -->
            <div v-if="allInfo.answer_info.mbti_content" class="mb-8 rounded-2xl bg-white p-6 shadow-sm ring-1 ring-gray-100 sm:p-8">
                <h3 class="mb-6 text-center text-lg font-semibold text-gray-900 sm:text-2xl">{{allInfo.answer_info.mbti_content.title || '性格类型解析'}}</h3>
                
                <!-- 类型简介 -->
                <div v-if="allInfo.answer_info.mbti_content.intro" class="mb-6 rounded-xl bg-gray-50 p-5">
                    <h5 class="mb-2 text-base font-semibold text-emerald-600">类型简介</h5>
                    <div class="text-sm leading-7 text-gray-600">{{allInfo.answer_info.mbti_content.intro}}</div>
                </div>
                
                <!-- 性格特征 -->
                <div v-if="allInfo.answer_info.mbti_content.content" class="mb-6 rounded-xl bg-gray-50 p-5">
                    <h5 class="mb-2 text-base font-semibold text-emerald-600">性格特征</h5>
                    <div class="prose max-w-none text-sm leading-7 text-gray-600" v-html="allInfo.answer_info.mbti_content.content"></div>
                </div>
                
                <!-- 深度分析 -->
                <div v-if="allInfo.answer_info.mbti_content.analysis" class="mb-6 rounded-xl bg-gray-50 p-5">
                    <h5 class="mb-2 text-base font-semibold text-emerald-600">深度分析</h5>
                    <div class="prose max-w-none text-sm leading-7 text-gray-600" v-html="allInfo.answer_info.mbti_content.analysis"></div>
                </div>
                
                <!-- 发展建议 -->
                <div v-if="allInfo.answer_info.mbti_content.suggestion" class="rounded-xl border-l-4 border-emerald-500 bg-emerald-50 p-5">
                    <h5 class="mb-2 text-base font-semibold text-emerald-600">发展建议</h5>
                    <div class="prose max-w-none text-sm leading-7 text-gray-600" v-html="allInfo.answer_info.mbti_content.suggestion"></div>
                </div>
                
                <!-- 封面图片 -->
                <div v-if="allInfo.answer_info.mbti_content.cover" class="mt-6 text-center">
                    <img :src="allInfo.answer_info.mbti_content.cover" class="mx-auto max-h-96 w-full max-w-full rounded-xl object-contain shadow">
                </div>
            </div>

            <!-- 测试总结 -->
            <div class="rounded-2xl bg-gradient-to-br from-fuchsia-400 to-rose-500 p-6 text-center text-white shadow sm:p-8">
                <h3 class="mb-5 text-lg font-semibold text-white sm:text-2xl">测试总结</h3>
                <div class="grid gap-4 sm:grid-cols-3">
                    <div class="rounded-xl bg-white/20 p-4">
                        <div class="text-2xl font-bold sm:text-3xl">{{allInfo.answer_info.mbti_type}}</div>
                        <div class="mt-1 text-sm opacity-90">性格类型</div>
                    </div>
                    <div class="rounded-xl bg-white/20 p-4">
                        <div class="text-2xl font-bold sm:text-3xl">{{allInfo.max_score}}</div>
                        <div class="mt-1 text-sm opacity-90">总分数</div>
                    </div>
                    <div class="rounded-xl bg-white/20 p-4">
                        <div class="text-2xl font-bold sm:text-3xl">4</div>
                        <div class="mt-1 text-sm opacity-90">维度分析</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
new Vue({
    el: '#app',
    data: {
        loading: true,
        error: null,
        allInfo: null
    },
    mounted() {
        this.$el.classList.remove('hidden');
        this.loadData();
    },
    methods: {
        loadData() {
            this.loading = true;
            this.error = null;
            
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const answer_id = urlParams.get('answer_id');
            
            if (!answer_id) {
                this.error = '缺少测试结果ID';
                this.loading = false;
                return;
            }
            
            // 调用API获取数据
            fetch('/addons/cms/psychometry/answerInfo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'answer_id=' + answer_id
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 1) {
                    this.allInfo = data.data;
                } else {
                    this.error = data.msg || '获取数据失败';
                }
                this.loading = false;
            })
            .catch(error => {
                this.error = '网络错误：' + error.message;
                this.loading = false;
            });
        },
        
        getDimensionName(key) {
            const names = {
                'E': '外向性 (E)',
                'I': '内向性 (I)', 
                'S': '感觉 (S)',
                'N': '直觉 (N)',
                'T': '思考 (T)',
                'F': '情感 (F)',
                'J': '判断 (J)',
                'P': '知觉 (P)'
            };
            return names[key] || key;
        },
        
        getDimensionPercentage(value) {
            // 假设最大分数是40，根据实际情况调整
            return Math.min((value / 40) * 100, 100);
        },
        
        getDimensionDescription(key, value) {
            const descriptions = {
                'E': value > 20 ? '您更倾向于外向，喜欢与人交往，从社交中获得能量。' : '您更倾向于内向，喜欢独处思考，从内心世界获得能量。',
                'I': value > 20 ? '您更倾向于内向，喜欢独处思考，从内心世界获得能量。' : '您更倾向于外向，喜欢与人交往，从社交中获得能量。',
                'S': value > 20 ? '您更倾向于感觉，注重具体事实和细节。' : '您更倾向于直觉，注重可能性和整体概念。',
                'N': value > 20 ? '您更倾向于直觉，注重可能性和整体概念。' : '您更倾向于感觉，注重具体事实和细节。',
                'T': value > 20 ? '您更倾向于思考，注重逻辑和客观分析。' : '您更倾向于情感，注重价值观和人际关系。',
                'F': value > 20 ? '您更倾向于情感，注重价值观和人际关系。' : '您更倾向于思考，注重逻辑和客观分析。',
                'J': value > 20 ? '您更倾向于判断，喜欢有序和计划。' : '您更倾向于知觉，喜欢灵活和开放。',
                'P': value > 20 ? '您更倾向于知觉，喜欢灵活和开放。' : '您更倾向于判断，喜欢有序和计划。'
            };
            return descriptions[key] || '';
        }
    }
});
</script>
{/block}
