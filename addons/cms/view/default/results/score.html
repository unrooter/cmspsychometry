{extend name="common/layout" /}

{block name="content"}
<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <div id="app">
        <!-- 加载状态 -->
        <div v-if="loading" class="text-center" style="padding: 50px;">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">加载中...</span>
            </div>
            <p class="mt-3">正在加载测试结果...</p>
        </div>

        <!-- 错误状态 -->
        <div v-if="error" class="alert alert-danger text-center" style="margin: 50px 0;">
            <h4>加载失败</h4>
            <p>{{error}}</p>
            <button @click="loadData" class="btn btn-primary">重新加载</button>
        </div>

        <!-- 分数结果内容 -->
        <div v-if="!loading && !error && allInfo" class="score-result-container">
            <!-- 测试信息头部 -->
            <div class="test-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 20px; margin-bottom: 30px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                <h1 style="font-size: 48px; font-weight: bold; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                    {{allInfo.max_score}} 分
                </h1>
                <p style="font-size: 20px; margin: 0; opacity: 0.9;">您的测试总分</p>
                <div v-if="allInfo.a_info" style="margin-top: 15px; font-size: 16px; opacity: 0.8;">
                    {{allInfo.a_info.title}}
                </div>
            </div>

            <!-- 分数等级展示 -->
            <div class="score-level" style="background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px; text-align: center;">
                <h3 style="color: #333; margin-bottom: 25px; font-size: 24px;">分数等级评定</h3>
                <div class="level-display" style="display: inline-block; padding: 20px 40px; border-radius: 15px; background: linear-gradient(135deg, #5DBE9E, #28a745); color: white; font-size: 24px; font-weight: bold; margin-bottom: 20px;">
                    {{getScoreLevel(allInfo.max_score)}}
                </div>
                <p style="color: #666; font-size: 16px; margin: 0;">{{getScoreDescription(allInfo.max_score)}}</p>
            </div>

            <!-- 分数详情 -->
            <div v-if="allInfo.stat_data && Object.keys(allInfo.stat_data).length > 0" class="score-details" style="background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="color: #333; margin-bottom: 25px; font-size: 24px; text-align: center;">分数详情</h3>
                <div class="row">
                    <div class="col-md-6" v-for="(value, key) in allInfo.stat_data" :key="key" style="margin-bottom: 20px;">
                        <div class="score-item" style="background: #f8f9fa; padding: 20px; border-radius: 12px; border-left: 5px solid #5DBE9E;">
                            <div class="score-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h5 style="color: #333; margin: 0; font-size: 18px;">{{getScoreItemName(key)}}</h5>
                                <span style="font-size: 20px; font-weight: bold; color: #2E7D5F;">{{value}} 分</span>
                            </div>
                            <div class="score-bar" style="background: #e9ecef; height: 12px; border-radius: 6px; overflow: hidden; position: relative;">
                                <div :style="'background: linear-gradient(90deg, #5DBE9E, #28a745); height: 100%; width: ' + getScorePercentage(value) + '%; transition: width 1s ease;'"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 结果解析 -->
            <div v-if="allInfo.answer_info" class="result-analysis" style="background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="color: #333; margin-bottom: 25px; font-size: 24px; text-align: center;">结果解析</h3>
                
                <!-- 主要结果 -->
                <div v-if="allInfo.answer_info.title" style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                    <h5 style="color: #5DBE9E; margin-bottom: 15px; font-size: 18px;">测试结果</h5>
                    <div style="color: #666; line-height: 1.8; font-size: 16px;">{{allInfo.answer_info.title}}</div>
                </div>
                
                <!-- 详细分析 -->
                <div v-if="allInfo.answer_info.content" style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                    <h5 style="color: #5DBE9E; margin-bottom: 15px; font-size: 18px;">详细分析</h5>
                    <div style="color: #666; line-height: 1.8; font-size: 16px;" v-html="allInfo.answer_info.content"></div>
                </div>
                
                <!-- 建议 -->
                <div v-if="allInfo.answer_info.suggestion" style="background: #e8f5e8; padding: 25px; border-radius: 12px; border-left: 5px solid #5DBE9E;">
                    <h5 style="color: #5DBE9E; margin-bottom: 15px; font-size: 18px;">建议</h5>
                    <div style="color: #666; line-height: 1.8; font-size: 16px;" v-html="allInfo.answer_info.suggestion"></div>
                </div>
            </div>

            <!-- 测试总结 -->
            <div class="test-summary" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <h3 style="color: white; margin-bottom: 20px; font-size: 24px;">测试总结</h3>
                <div class="row">
                    <div class="col-md-4">
                        <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">{{allInfo.max_score}}</div>
                        <div style="font-size: 16px; opacity: 0.9;">总分数</div>
                    </div>
                    <div class="col-md-4">
                        <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">{{getScoreLevel(allInfo.max_score)}}</div>
                        <div style="font-size: 16px; opacity: 0.9;">等级评定</div>
                    </div>
                    <div class="col-md-4">
                        <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">{{Object.keys(allInfo.stat_data || {}).length}}</div>
                        <div style="font-size: 16px; opacity: 0.9;">评分维度</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
new Vue({
    el: '#app',
    data: {
        loading: true,
        error: null,
        allInfo: null
    },
    mounted() {
        this.loadData();
    },
    methods: {
        loadData() {
            this.loading = true;
            this.error = null;
            
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const answer_id = urlParams.get('answer_id');
            
            if (!answer_id) {
                this.error = '缺少测试结果ID';
                this.loading = false;
                return;
            }
            
            // 调用API获取数据
            fetch('/addons/cms/psychometry/answerInfo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'answer_id=' + answer_id
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 1) {
                    this.allInfo = data.data;
                } else {
                    this.error = data.msg || '获取数据失败';
                }
                this.loading = false;
            })
            .catch(error => {
                this.error = '网络错误：' + error.message;
                this.loading = false;
            });
        },
        
        getScoreLevel(score) {
            if (score >= 90) return '优秀';
            if (score >= 80) return '良好';
            if (score >= 70) return '中等';
            if (score >= 60) return '及格';
            return '需要提升';
        },
        
        getScoreDescription(score) {
            if (score >= 90) return '您的表现非常出色，继续保持！';
            if (score >= 80) return '您的表现很好，还有提升空间。';
            if (score >= 70) return '您的表现中等，建议加强练习。';
            if (score >= 60) return '您的表现及格，需要更多努力。';
            return '建议重新学习相关知识点。';
        },
        
        getScoreItemName(key) {
            // 根据实际情况返回分数项名称
            return key || '评分项';
        },
        
        getScorePercentage(value) {
            // 根据总分计算百分比
            const maxScore = this.allInfo ? this.allInfo.max_score : 100;
            return Math.min((value / maxScore) * 100, 100);
        }
    }
});
</script>
{/block}
