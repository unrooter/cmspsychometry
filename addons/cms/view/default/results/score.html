{extend name="common/layout" /}

{block name="content"}
<div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
    <div id="app" class="hidden">
        <!-- 加载状态 -->
        <div v-if="loading" class="flex flex-col items-center justify-center py-16 text-center">
            <div class="h-10 w-10 animate-spin rounded-full border-4 border-gray-200 border-t-emerald-600" role="status"></div>
            <p class="mt-4 text-sm text-gray-600">正在加载测试结果...</p>
        </div>

        <!-- 错误状态 -->
        <div v-if="error" class="my-10 rounded-lg border border-red-200 bg-red-50 p-6 text-center">
            <h4 class="text-base font-semibold text-red-800">加载失败</h4>
            <p class="mt-2 text-sm text-red-700">{{error}}</p>
            <button @click="loadData" class="mt-4 inline-flex items-center rounded-md bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700">重新加载</button>
        </div>

        <!-- 分数结果内容 -->
        <div v-if="!loading && !error && allInfo" class="score-result-container">
            <!-- 测试信息头部 -->
            <div class="mb-8 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 p-8 text-center text-white shadow-lg sm:p-10">
                <h1 class="text-3xl font-bold drop-shadow-sm sm:text-5xl">
                    {{allInfo.max_score}} 分
                </h1>
                <p class="mt-2 text-base opacity-90 sm:text-lg">您的测试总分</p>
                <div v-if="allInfo.a_info" class="mt-3 text-sm opacity-80 sm:text-base">
                    {{allInfo.a_info.title}}
                </div>
            </div>

            <!-- 分数等级展示 -->
            <div class="mb-8 rounded-2xl bg-white p-6 text-center shadow-sm ring-1 ring-gray-100 sm:p-8">
                <h3 class="mb-6 text-center text-lg font-semibold text-gray-900 sm:text-2xl">分数等级评定</h3>
                <div class="inline-block rounded-2xl bg-gradient-to-r from-emerald-500 to-green-500 px-10 py-5 text-xl font-bold text-white shadow">
                    {{getScoreLevel(allInfo.max_score)}}
                </div>
                <p class="mt-4 text-sm leading-7 text-gray-600 sm:text-base">{{getScoreDescription(allInfo.max_score)}}</p>
            </div>

            <!-- 分数详情 -->
            <div v-if="allInfo.stat_data && Object.keys(allInfo.stat_data).length > 0" class="mb-8 rounded-2xl bg-white p-6 shadow-sm ring-1 ring-gray-100 sm:p-8">
                <h3 class="mb-6 text-center text-lg font-semibold text-gray-900 sm:text-2xl">分数详情</h3>
                <div class="grid gap-4 sm:grid-cols-2">
                    <div v-for="(value, key) in allInfo.stat_data" :key="key">
                        <div class="rounded-xl border-l-4 border-emerald-500 bg-gray-50 p-5">
                            <div class="flex items-center justify-between gap-3">
                                <h5 class="text-sm font-semibold text-gray-900 sm:text-base">{{getScoreItemName(key)}}</h5>
                                <span class="text-lg font-bold text-emerald-700">{{value}} 分</span>
                            </div>
                            <div class="mt-3 h-3 overflow-hidden rounded-full bg-gray-200">
                                <div class="h-full bg-gradient-to-r from-emerald-500 to-green-500 transition-all duration-700" :style="{ width: getScorePercentage(value) + '%' }"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 结果解析 -->
            <div v-if="allInfo.answer_info" class="mb-8 rounded-2xl bg-white p-6 shadow-sm ring-1 ring-gray-100 sm:p-8">
                <h3 class="mb-6 text-center text-lg font-semibold text-gray-900 sm:text-2xl">结果解析</h3>
                
                <!-- 主要结果 -->
                <div v-if="allInfo.answer_info.title" class="mb-6 rounded-xl bg-gray-50 p-5">
                    <h5 class="mb-2 text-base font-semibold text-emerald-600">测试结果</h5>
                    <div class="text-sm leading-7 text-gray-600">{{allInfo.answer_info.title}}</div>
                </div>
                
                <!-- 详细分析 -->
                <div v-if="allInfo.answer_info.content" class="mb-6 rounded-xl bg-gray-50 p-5">
                    <h5 class="mb-2 text-base font-semibold text-emerald-600">详细分析</h5>
                    <div class="prose max-w-none text-sm leading-7 text-gray-600" v-html="allInfo.answer_info.content"></div>
                </div>
                
                <!-- 建议 -->
                <div v-if="allInfo.answer_info.suggestion" class="rounded-xl border-l-4 border-emerald-500 bg-emerald-50 p-5">
                    <h5 class="mb-2 text-base font-semibold text-emerald-600">建议</h5>
                    <div class="prose max-w-none text-sm leading-7 text-gray-600" v-html="allInfo.answer_info.suggestion"></div>
                </div>
            </div>

            <!-- 测试总结 -->
            <div class="rounded-2xl bg-gradient-to-br from-fuchsia-400 to-rose-500 p-6 text-center text-white shadow sm:p-8">
                <h3 class="mb-5 text-lg font-semibold text-white sm:text-2xl">测试总结</h3>
                <div class="grid gap-4 sm:grid-cols-3">
                    <div class="rounded-xl bg-white/20 p-4">
                        <div class="text-2xl font-bold sm:text-3xl">{{allInfo.max_score}}</div>
                        <div class="mt-1 text-sm opacity-90">总分数</div>
                    </div>
                    <div class="rounded-xl bg-white/20 p-4">
                        <div class="text-2xl font-bold sm:text-3xl">{{getScoreLevel(allInfo.max_score)}}</div>
                        <div class="mt-1 text-sm opacity-90">等级评定</div>
                    </div>
                    <div class="rounded-xl bg-white/20 p-4">
                        <div class="text-2xl font-bold sm:text-3xl">{{Object.keys(allInfo.stat_data || {}).length}}</div>
                        <div class="mt-1 text-sm opacity-90">评分维度</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
new Vue({
    el: '#app',
    data: {
        loading: true,
        error: null,
        allInfo: null
    },
    mounted() {
        this.$el.classList.remove('hidden');
        this.loadData();
    },
    methods: {
        loadData() {
            this.loading = true;
            this.error = null;
            
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const answer_id = urlParams.get('answer_id');
            
            if (!answer_id) {
                this.error = '缺少测试结果ID';
                this.loading = false;
                return;
            }
            
            // 调用API获取数据
            fetch('/addons/cms/psychometry/answerInfo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'answer_id=' + answer_id
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 1) {
                    this.allInfo = data.data;
                } else {
                    this.error = data.msg || '获取数据失败';
                }
                this.loading = false;
            })
            .catch(error => {
                this.error = '网络错误：' + error.message;
                this.loading = false;
            });
        },
        
        getScoreLevel(score) {
            if (score >= 90) return '优秀';
            if (score >= 80) return '良好';
            if (score >= 70) return '中等';
            if (score >= 60) return '及格';
            return '需要提升';
        },
        
        getScoreDescription(score) {
            if (score >= 90) return '您的表现非常出色，继续保持！';
            if (score >= 80) return '您的表现很好，还有提升空间。';
            if (score >= 70) return '您的表现中等，建议加强练习。';
            if (score >= 60) return '您的表现及格，需要更多努力。';
            return '建议重新学习相关知识点。';
        },
        
        getScoreItemName(key) {
            // 根据实际情况返回分数项名称
            return key || '评分项';
        },
        
        getScorePercentage(value) {
            // 根据总分计算百分比
            const maxScore = this.allInfo ? this.allInfo.max_score : 100;
            return Math.min((value / maxScore) * 100, 100);
        }
    }
});
</script>
{/block}
