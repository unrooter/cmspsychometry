{extend name="common/layout" /}

{block name="content"}
<div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
    <div id="app" class="hidden">
        <!-- 加载状态 -->
        <div v-if="loading" class="flex flex-col items-center justify-center py-16 text-center">
            <div class="h-10 w-10 animate-spin rounded-full border-4 border-gray-200 border-t-emerald-600" role="status"></div>
            <p class="mt-4 text-sm text-gray-600">正在加载测试结果...</p>
        </div>

        <!-- 错误状态 -->
        <div v-if="error" class="my-10 rounded-lg border border-red-200 bg-red-50 p-6 text-center">
            <h4 class="text-base font-semibold text-red-800">加载失败</h4>
            <p class="mt-2 text-sm text-red-700">{{error}}</p>
            <button @click="loadData" class="mt-4 inline-flex items-center rounded-md bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700">重新加载</button>
        </div>

        <!-- 自定义结果内容 -->
        <div v-if="!loading && !error && allInfo" class="custom-result-container">
            <!-- 测试信息头部 -->
            <div class="mb-8 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 p-8 text-center text-white shadow-lg sm:p-10">
                <h1 class="text-2xl font-bold drop-shadow-sm sm:text-4xl">
                    测试结果
                </h1>
                <p class="mt-2 text-base opacity-90 sm:text-lg">根据您的选择进行分析</p>
                <div v-if="allInfo.a_info" class="mt-3 text-sm opacity-80 sm:text-base">
                    {{allInfo.a_info.title}}
                </div>
            </div>

            <!-- 选择分析 -->
            <div v-if="allInfo.answer_info && allInfo.answer_info.selected_options && allInfo.answer_info.selected_options.length > 0" class="mb-8 rounded-2xl bg-white p-6 shadow-sm ring-1 ring-gray-100 sm:p-8">
                <h3 class="mb-6 text-center text-lg font-semibold text-gray-900 sm:text-2xl">您的选择分析</h3>
                <div class="grid gap-4 sm:grid-cols-2">
                    <div v-for="(option, index) in allInfo.answer_info.selected_options" :key="index" class="h-full">
                        <div class="h-full rounded-xl border-l-4 border-emerald-500 bg-gray-50 p-5">
                            <div class="mb-4 flex items-center gap-3">
                                <div class="flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500 text-base font-bold text-white">
                                    {{option.option_key || (index + 1)}}
                                </div>
                                <h5 class="min-w-0 flex-1 text-sm font-semibold text-gray-900 sm:text-base">{{option.option_title}}</h5>
                            </div>

                            <div v-if="option.option_cover" class="mb-4">
                                <img :src="option.option_cover" alt="" class="mx-auto max-h-52 w-full rounded-xl object-contain shadow">
                            </div>

                            <div v-if="option.option_intro" class="text-sm leading-6 text-gray-600">
                                {{option.option_intro}}
                            </div>

                            <div v-if="option.score" class="mt-4 text-right">
                                <span class="inline-flex items-center rounded-full bg-emerald-600 px-3 py-1 text-xs font-semibold text-white">{{option.score}} 分</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 结果解析 -->
            <div v-if="allInfo.answer_info" class="mb-8 rounded-2xl bg-white p-6 shadow-sm ring-1 ring-gray-100 sm:p-8">
                <h3 class="mb-6 text-center text-lg font-semibold text-gray-900 sm:text-2xl">结果解析</h3>
                
                <!-- 主要结果 -->
                <div v-if="allInfo.answer_info.title" class="mb-6 rounded-xl bg-gray-50 p-5">
                    <h5 class="mb-2 text-base font-semibold text-emerald-600">测试结果</h5>
                    <div class="text-sm leading-7 text-gray-600">{{allInfo.answer_info.title}}</div>
                </div>
                
                <!-- 详细分析 -->
                <div v-if="allInfo.answer_info.content" class="mb-6 rounded-xl bg-gray-50 p-5">
                    <h5 class="mb-2 text-base font-semibold text-emerald-600">详细分析</h5>
                    <div class="prose max-w-none text-sm leading-7 text-gray-600" v-html="allInfo.answer_info.content"></div>
                </div>
                
                <!-- 建议 -->
                <div v-if="allInfo.answer_info.suggestion" class="rounded-xl border-l-4 border-emerald-500 bg-emerald-50 p-5">
                    <h5 class="mb-2 text-base font-semibold text-emerald-600">建议</h5>
                    <div class="prose max-w-none text-sm leading-7 text-gray-600" v-html="allInfo.answer_info.suggestion"></div>
                </div>
            </div>

            <!-- 通用结果内容 -->
            <div v-if="!allInfo.answer_info || !allInfo.answer_info.selected_options" class="mb-8 rounded-2xl bg-white p-6 text-center shadow-sm ring-1 ring-gray-100 sm:p-8">
                <h3 class="mb-5 text-lg font-semibold text-gray-900 sm:text-2xl">测试完成</h3>
                <div class="mb-5 text-sm leading-7 text-gray-600 sm:text-base">
                    感谢您参与测试！您的选择已经记录，我们会根据您的偏好为您提供更个性化的内容。
                </div>
                <div v-if="allInfo.result" class="inline-block rounded-xl bg-gray-50 px-5 py-4">
                    <strong class="text-emerald-600">{{allInfo.result}}</strong>
                </div>
            </div>

            <!-- 测试总结 -->
            <div class="rounded-2xl bg-gradient-to-br from-fuchsia-400 to-rose-500 p-6 text-center text-white shadow sm:p-8">
                <h3 class="mb-5 text-lg font-semibold text-white sm:text-2xl">测试总结</h3>
                <div class="grid gap-4 sm:grid-cols-3">
                    <div class="rounded-xl bg-white/20 p-4">
                        <div class="text-2xl font-bold sm:text-3xl">{{allInfo.answer_info && allInfo.answer_info.selected_options ? allInfo.answer_info.selected_options.length : 0}}</div>
                        <div class="mt-1 text-sm opacity-90">选择项目</div>
                    </div>
                    <div class="rounded-xl bg-white/20 p-4">
                        <div class="text-2xl font-bold sm:text-3xl">{{allInfo.max_score || 0}}</div>
                        <div class="mt-1 text-sm opacity-90">总分数</div>
                    </div>
                    <div class="rounded-xl bg-white/20 p-4">
                        <div class="text-2xl font-bold sm:text-3xl">100%</div>
                        <div class="mt-1 text-sm opacity-90">完成度</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
new Vue({
    el: '#app',
    data: {
        loading: true,
        error: null,
        allInfo: null
    },
    mounted() {
        this.$el.classList.remove('hidden');
        this.loadData();
    },
    methods: {
        loadData() {
            this.loading = true;
            this.error = null;
            
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const answer_id = urlParams.get('answer_id');
            
            if (!answer_id) {
                this.error = '缺少测试结果ID';
                this.loading = false;
                return;
            }
            
            // 调用API获取数据
            fetch('/addons/cms/psychometry/answerInfo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'answer_id=' + answer_id
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 1) {
                    this.allInfo = data.data;
                } else {
                    this.error = data.msg || '获取数据失败';
                }
                this.loading = false;
            })
            .catch(error => {
                this.error = '网络错误：' + error.message;
                this.loading = false;
            });
        }
    }
});
</script>
{/block}
