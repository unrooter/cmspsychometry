{layout name="common/layout" /}

<!-- SEO结构化数据 -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "{$__CHANNEL__.seotitle ?: $__CHANNEL__.name}",
  "description": "{$__CHANNEL__.description}",
  "url": "{$__CHANNEL__.url}"
}
</script>

<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8" id="content-container" itemscope itemtype="https://schema.org/CollectionPage">

    <nav aria-label="breadcrumb" class="mt-6">
        <ol class="flex flex-wrap items-center gap-x-2 gap-y-1 text-sm text-gray-600" itemscope itemtype="https://schema.org/BreadcrumbList">
            <!-- S 面包屑导航 -->
            {cms:breadcrumb id="item"}
            <li class="inline-flex items-center" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                <a class="hover:text-emerald-600" href="{$item.url}" itemprop="item"><span itemprop="name">{:__($item.name)}</span></a>
                <meta itemprop="position" content="{$i}" />
            </li>
            {/cms:breadcrumb}
            <!-- E 面包屑导航 -->
        </ol>
    </nav>

    <!-- 子栏目导航（仅父栏目显示子栏目） -->
    {php}$hasSubChannels = false;{/php}
    {cms:channellist id="subchan_check" type="son" typeid="$__CHANNEL__.id" limit="1"}
    {php}$hasSubChannels = true;{/php}
    {/cms:channellist}

    <header class="mt-4 rounded-lg border border-gray-200 bg-white p-5 shadow-sm">
        <div class="flex flex-wrap items-center gap-3">
            <h1 class="text-xl font-bold text-gray-900" itemprop="name">{:__($__CHANNEL__.name)}</h1>
        </div>

        {if $__CHANNEL__.description}
        <div class="mt-3 text-sm leading-7 text-gray-600" itemprop="description">{$__CHANNEL__.description}</div>
        {/if}

        {if $hasSubChannels}
        <nav class="mt-4 flex flex-wrap items-center gap-2" aria-label="{:__('栏目分类')}">
            <span class="inline-flex items-center gap-2 text-sm font-medium text-gray-700"><i class="fa fa-th-large" aria-hidden="true"></i>{:__('栏目分类')}</span>
            {cms:channellist id="subchan" type="son" typeid="$__CHANNEL__.id"}
            <a href="{$subchan.url}" class="rounded-full border border-gray-200 px-3 py-1 text-sm text-gray-700 hover:bg-gray-50 hover:text-emerald-600">{:__($subchan.name)}</a>
            {/cms:channellist}
        </nav>
        {/if}
    </header>
    
    <!-- Google AdSense 头部横向广告 -->
    <div id="ad-list-header" class="my-4 min-h-[90px] text-center"></div>
    
    {if $__FILTERLIST__}
    <section class="mt-4" aria-label="{:__('筛选条件')}">
        <div class="rounded-lg border border-gray-200 bg-white p-4 shadow-sm">
            <div class="flex flex-wrap items-center justify-between gap-3">
                <h2 class="inline-flex items-center gap-2 text-base font-semibold text-gray-900"><i class="fa fa-filter text-emerald-600" aria-hidden="true"></i>{:__('筛选')}</h2>
                <form action="" id="multipleform" class="flex items-center gap-2">
                    <input type="checkbox" name="multiple" id="multiple"
                           class="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-600"
                           onclick="document.getElementById('multipleform').submit();"
                           value="{:$Think.get.multiple?0:1}"
                           {:$Think.get.multiple?'checked':''}>
                    <label for="multiple" class="text-sm text-gray-700">{:__('多选模式')}</label>
                </form>
            </div>

            <div class="mt-4 space-y-4">
                {cms:pagefilter id="filter" exclude=""}
                <div class="flex flex-wrap items-start gap-3">
                    <div class="mt-1 w-20 shrink-0 text-sm font-medium text-gray-700">{$filter.title|htmlentities}:</div>
                    <div class="flex flex-wrap gap-2">
                        {volist name="$filter.content" id="filterItem"}
                        <a href="{$filterItem.url}" class="rounded-full border border-gray-200 bg-white px-3 py-1 text-sm text-gray-700 hover:bg-gray-50 hover:text-emerald-600 {$filterItem.active?'bg-emerald-50 text-emerald-700 border-emerald-200':''}">{$filterItem.title|htmlentities}</a>
                        {/volist}
                    </div>
                </div>
                {/cms:pagefilter}
            </div>
        </div>
    </section>
    {/if}

    <div class="mt-6 grid gap-6 lg:grid-cols-12">

        <main class="lg:col-span-8">
            <section aria-label="{:__('列表')}">
                <div class="rounded-lg border border-gray-200 bg-white shadow-sm">
                    <div class="flex flex-wrap items-center justify-between gap-3 border-b border-gray-100 px-4 py-3">
                        <h2 class="text-base font-semibold text-gray-900">{:__('列表')}</h2>
                        <div class="flex flex-wrap gap-2">
                            <!-- S 排序 -->
                            {cms:pageorder id="order"}
                            <a href="{$order.url}" class="rounded-full border border-gray-200 bg-white px-3 py-1 text-sm text-gray-700 hover:bg-gray-50 hover:text-emerald-600 {$order.active?'bg-emerald-50 text-emerald-700 border-emerald-200':''}">{$order.title|htmlentities}</a>
                            {/cms:pageorder}
                            <!-- E 排序 -->
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="divide-y divide-gray-100" itemscope itemtype="https://schema.org/ItemList">
                            <meta itemprop="name" content="{:__($__CHANNEL__.name)}文章列表" />
                            <!-- S 列表 -->
                            {cms:pagelist id="item"}
                                {include file="common/item_news"}
                            {/cms:pagelist}
                            <!-- E 列表 -->
                        </div>

                        <!-- S 分页 -->
                        <div class="mt-8">
                            {include file="common/pageinfo" /}
                        </div>
                        <!-- E 分页 -->
                    </div>
                </div>
            </section>
        </main>

        <aside class="space-y-6 lg:col-span-4">
            <!-- 判断是否有子栏目 -->
            {php}$hasSubChannels = false;{/php}
            {cms:channellist id="subchan_check" type="son" typeid="$__CHANNEL__.id" limit="1"}
            {php}$hasSubChannels = true;{/php}
            {/cms:channellist}
            
            <!-- 栏目导航 -->
            {php}
            // 判断显示哪种导航
            $showNav = false;
            $navType = '';
            $navParentId = 0;
            
            if ($hasSubChannels) {
                // 父栏目：显示子栏目
                $showNav = true;
                $navType = 'sub';
                $navParentId = $__CHANNEL__['id'];
            } elseif (isset($__CHANNEL__['parent_id']) && $__CHANNEL__['parent_id'] > 0) {
                // 子栏目：显示兄弟栏目
                $showNav = true;
                $navType = 'sibling';
                $navParentId = $__CHANNEL__['parent_id'];
            }
            {/php}
            
            {if $showNav}
            <section aria-labelledby="sidebar-nav-title">
                <div class="rounded-lg border border-gray-200 bg-white shadow-sm">
                    <h3 class="border-b border-gray-100 px-4 py-3 text-base font-semibold text-gray-900" id="sidebar-nav-title"><i class="fa fa-sitemap mr-2 text-emerald-600" aria-hidden="true"></i>{if $navType == 'sub'}{:__('子栏目')}{else}{:__('相关栏目')}{/if}</h3>
                    <nav class="p-2">
                        {cms:channellist id="navItem" type="son" typeid="$navParentId"}
                        <a href="{$navItem.url}" title="{:__($navItem.name)}" class="flex items-center gap-3 rounded-md px-3 py-3 text-sm text-gray-700 hover:bg-gray-50 hover:text-emerald-600 {if $navItem.id == $__CHANNEL__.id}bg-emerald-50 text-emerald-700{/if}">
                            <i class="fa fa-folder-o text-emerald-600" aria-hidden="true"></i>
                            <span class="min-w-0 flex-1 truncate">{:__($navItem.name)}</span>
                            {if $navItem.id == $__CHANNEL__.id}
                            <i class="fa fa-check text-emerald-600" aria-hidden="true"></i>
                            {else}
                            <i class="fa fa-angle-right text-gray-400" aria-hidden="true"></i>
                            {/if}
                        </a>
                        {/cms:channellist}
                    </nav>
                </div>
            </section>
            {/if}
            <!-- 热门文章 -->
            <section aria-labelledby="hot-articles-title">
                <div class="rounded-lg border border-gray-200 bg-white shadow-sm">
                    <h3 class="border-b border-gray-100 px-4 py-3 text-base font-semibold text-gray-900" id="hot-articles-title"><i class="fa fa-fire mr-2 text-emerald-600" aria-hidden="true"></i>{:__('热门推荐')}</h3>
                    <div class="space-y-3 p-4">
                        {php}$hotCount = 0;{/php}
                        {cms:arclist id="item" orderby="views" orderway="DESC" limit="6"}
                        {php}$hotCount++;{/php}
                        <a href="{$item.url}" class="group block overflow-hidden rounded-md border border-gray-200 bg-white shadow-sm transition hover:shadow-md" title="{$item.title|htmlentities}">
                            <div class="aspect-[4/1] overflow-hidden bg-gray-100">
                                <img src="{$item.image ?: '/assets/addons/cms/img/default.png'}" alt="{$item.title|htmlentities}" loading="lazy" class="h-full w-full object-cover transition duration-300 group-hover:scale-105">
                            </div>
                            <div class="p-2 text-sm font-medium text-gray-900 truncate">{$item.title|htmlentities}</div>
                        </a>
                        {/cms:arclist}
                        {if $hotCount == 0}
                        <div class="rounded-md border border-dashed border-gray-300 p-4 text-center text-sm text-gray-500">{:__('暂无热门文章')}</div>
                        {/if}
                    </div>
                </div>
            </section>
            
            
            <!-- 最新文章 -->
            <section aria-labelledby="recent-articles-title">
                <div class="rounded-lg border border-gray-200 bg-white shadow-sm">
                    <h3 class="border-b border-gray-100 px-4 py-3 text-base font-semibold text-gray-900" id="recent-articles-title"><i class="fa fa-clock-o mr-2 text-emerald-600" aria-hidden="true"></i>{:__('最新发布')}</h3>
                    <div class="divide-y divide-gray-100">
                        {cms:arclist id="item" orderby="publishtime" orderway="DESC" limit="8"}
                        <a href="{$item.url}" title="{$item.title|htmlentities}" class="block px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 hover:text-emerald-600">
                            <div class="font-medium leading-6 text-gray-900">{$item.title|htmlentities}</div>
                            <div class="mt-1 flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-gray-500">
                                <span><i class="fa fa-calendar mr-1" aria-hidden="true"></i>{$item.publishtime|date='Y-m-d',###}</span>
                                <span><i class="fa fa-eye mr-1" aria-hidden="true"></i>{$item.views}</span>
                            </div>
                        </a>
                        {/cms:arclist}
                    </div>
                </div>
            </section>
            
            <!-- Google AdSense 侧边栏广告 -->
            <div id="ad-list-sidebar" class="my-5 min-h-[600px] text-center"></div>
            
            {include file="common/sidebar" /}
        </aside>
    </div>
</div>

<!-- Google AdSense JavaScript -->
<script type="text/javascript" src="__ADDON__/js/vue.js"></script>
<script>
Vue.config.ignoredElements = ['o:p'];

new Vue({
    el: '#content-container',
    mounted() {
        // 立即初始化广告
        this.initAds();
    },
    methods: {
        initAds() {
            console.log('[AdSense] Init starting...', window._adsenseInitialized);
            
            if (window._adsenseInitialized) {
                console.log('[AdSense] Already initialized, skipping');
                return;
            }
            
            console.log('[AdSense] Starting initialization');
            
            // 50ms快速检测
            const waitForAdSense = (callback, maxAttempts = 100) => {
                let attempts = 0;
                const startTime = Date.now();
                
                const checkAdSense = () => {
                    if (window.adsbygoogle && Array.isArray(window.adsbygoogle)) {
                        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
                        console.log(`[AdSense] Script ready in ${elapsed}s`);
                        callback();
                    } else if (attempts >= maxAttempts) {
                        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
                        console.log(`[AdSense] Timeout after ${elapsed}s, trying anyway`);
                        callback();
                    } else {
                        attempts++;
                        setTimeout(checkAdSense, 50);
                    }
                };
                checkAdSense();
            };
            
            const createAd = (containerId, config) => {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.warn('[AdSense] Container not found:', containerId);
                    return;
                }
                
                const existingAd = container.querySelector('.adsbygoogle');
                if (existingAd && existingAd.getAttribute('data-adsbygoogle-status') === 'done') {
                    console.log('[AdSense] Ad already exists:', containerId);
                    return;
                }
                
                console.log('[AdSense] Creating ad:', containerId);
                container.innerHTML = '';
                const ins = document.createElement('ins');
                ins.className = 'adsbygoogle block';
                
                Object.keys(config).forEach(key => {
                    ins.setAttribute(key, config[key]);
                });
                
                container.appendChild(ins);
                
                // 立即push
                try {
                    console.log('[AdSense] Pushing ad:', containerId);
                    (adsbygoogle = window.adsbygoogle || []).push({});
                } catch (e) {
                    console.error('[AdSense] Push error:', containerId, e);
                }
            };
            
            waitForAdSense(() => {
                console.log('[AdSense] Creating all ads...');
                
                // 列表页头部横向广告
                createAd('ad-list-header', {
                    'data-ad-client': 'ca-pub-9195262048954682',
                    'data-ad-slot': '7906059149',
                    'data-ad-format': 'auto',
                    'data-full-width-responsive': 'true'
                });
                
                // 列表页侧边栏广告
                createAd('ad-list-sidebar', {
                    'data-ad-client': 'ca-pub-9195262048954682',
                    'data-ad-slot': '2901144473',
                    'data-ad-format': 'auto',
                    'data-full-width-responsive': 'true'
                });
                
                window._adsenseInitialized = true;
                console.log('[AdSense] ✅ All ads initialized');
            });
        }
    }
});

console.log('[AdSense] Vue initialized');
</script>
