{layout name="common/layout" /}

<!-- SEO结构化数据 - Quiz类型 -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Quiz",
  "name": "{$__ARCHIVES__.title|htmlentities}",
  "description": "{$__ARCHIVES__.sub_title|htmlentities}",
  "url": "{$Think.request.url}",
  "image": "{$__ARCHIVES__.image|cdnurl}",
  "author": {
    "@type": "Organization",
    "name": "{cms:config name='cms.sitename'/}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "{cms:config name='cms.sitename'/}",
    "logo": {
      "@type": "ImageObject",
      "url": "{$Think.config.cms.sitelogo|cdnurl}"
    }
  },
  "datePublished": "{$__ARCHIVES__.publishtime|date='c',###}",
  "dateModified": "{$__ARCHIVES__.updatetime|date='c',###}"
}
</script>

<style data-render="style">
 .oh-fun-head{display:flex;flex-direction:column;gap:14px}
 @media (min-width: 768px){.oh-fun-head{flex-direction:row;align-items:flex-start;justify-content:space-between}}
 .oh-fun-cta{display:inline-flex;align-items:center;justify-content:center;border-radius:12px;border:1px solid #facc15;background:#facc15;padding:12px 18px;font-size:13px;font-weight:900;letter-spacing:0.14em;color:#111;box-shadow:0 12px 28px rgba(250,204,21,0.28), 0 10px 26px rgba(0,0,0,0.10);user-select:none;white-space:nowrap}
 .oh-fun-cta:hover{background:#fbbf24;border-color:#fbbf24}
 .oh-fun-cta-muted{border-color:rgba(0,0,0,0.10);background:rgba(0,0,0,0.04);color:rgba(0,0,0,0.55);box-shadow:none}
 .oh-fun-cta-muted:hover{background:rgba(0,0,0,0.04);border-color:rgba(0,0,0,0.10)}
 @media (max-width: 767px){.oh-fun-cta{width:100%}}
 .oh-fun-shell{background:rgba(0,0,0,0.035);padding:16px;border-radius:16px}
 @media (min-width: 768px){.oh-fun-shell{padding:22px}}
 .oh-fun-work{background:#fff;box-shadow:0 18px 45px rgba(0,0,0,0.06);padding:16px;border-radius:16px}
 @media (min-width: 768px){.oh-fun-work{padding:20px}}
 .oh-fun-choice{border-radius:14px}
 .oh-fun-choice[disabled]{opacity:0.60;pointer-events:none}
 .oh-fun-mask{position:fixed;inset:0;z-index:9999;background:rgba(255,255,255,0.88);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;padding:24px}
 .oh-fun-mask-card{width:min(360px, 100%);background:#111;color:#fff;border-radius:16px;padding:18px 18px 16px;text-align:center;box-shadow:0 22px 60px rgba(0,0,0,0.22)}
 .oh-fun-spin{display:inline-block;width:22px;height:22px;border-radius:999px;border:2px solid rgba(255,255,255,0.35);border-top-color:#facc15;animation:oh-fun-spin 0.8s linear infinite}
 @keyframes oh-fun-spin{to{transform:rotate(360deg)}}
</style>


<div id="app" v-cloak class="hidden">
    <div v-if="isGenerating" class="oh-fun-mask" role="status" aria-live="polite" aria-label="{:__('报告生成中')}">
        <div class="oh-fun-mask-card">
            <div class="flex items-center justify-center gap-3" style="gap:12px;">
                <span class="oh-fun-spin" aria-hidden="true"></span>
                <div class="text-base font-semibold">{:__('报告生成中')}</div>
            </div>
            <div class="mt-2 text-sm" style="color:rgba(255,255,255,0.78);">{:__('正在分析你的答案，请稍候…')}</div>
        </div>
    </div>
    <div class="mx-auto max-w-7xl px-4 py-10 sm:px-6 lg:px-8" id="content-container" itemscope itemtype="https://schema.org/Quiz">
        <nav aria-label="breadcrumb" class="mb-6">
            <ol class="flex flex-wrap items-center gap-x-1.5 gap-y-1 text-xs text-gray-500" itemscope itemtype="https://schema.org/BreadcrumbList">
                {php}$breadPos = 0;{/php}
                {cms:breadcrumb id="item"}
                {php}$breadPos++;{/php}
                <li class="inline-flex items-center" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                    {if $breadPos>1}<span class="mx-1 text-gray-300">›</span>{/if}
                    <a class="no-underline hover:text-black" href="{$item.url}" itemprop="item">
                        <span itemprop="name">{:__($item.name)}</span>
                    </a>
                    <meta itemprop="position" content="{$breadPos}" />
                </li>
                {/cms:breadcrumb}
            </ol>
        </nav>

        <div class="mt-6 grid gap-6 lg:grid-cols-12">
            <main class="lg:col-span-8">
                <article class="ui-card">
                    <header class="ui-card-header">
                        <div class="oh-fun-head">
                            <div class="min-w-0 space-y-4">
                                <h1 class="text-xl font-bold leading-7 text-gray-900" itemprop="name" {if $__ARCHIVES__.style}data-css="{$__ARCHIVES__.style_text}"{/if} id="article-title">
                                    {cms:archives name="title|htmlentities" /}
                                </h1>
                                <div class="bg-black/5 p-2 text-sm font-semibold text-gray-900" itemprop="description">
                                    <i class="fa fa-quote-left mr-2" aria-hidden="true"></i>
                                    {cms:archives name="sub_title|htmlentities" /}
                                </div>
                                <div class="flex flex-wrap items-center gap-x-6 gap-y-2 text-sm text-gray-600">
                                    <span class="inline-flex items-center gap-2"><i class="fa fa-eye text-black/60" aria-hidden="true"></i>{cms:archives name="views" /} 次</span>
                                    <span class="inline-flex items-center gap-2"><i class="fa fa-calendar text-black/60" aria-hidden="true"></i>{$__ARCHIVES__.publishtime|date='Y-m-d',###}</span>
                                    <span class="inline-flex items-center gap-2"><i class="fa fa-tag text-black/60" aria-hidden="true"></i>{:__('趣味测试')}</span>
                                </div>
                            </div>
                            <div class="shrink-0">
                                {if $check_data['code']==3}
                                <a class="oh-fun-cta" href="{:url('index/user/login')}"><i class="fa fa-sign-in mr-2" aria-hidden="true"></i>{:__('登录后测试')}</a>
                                {elseif $check_data['code']==0}
                                <button type="button" class="oh-fun-cta oh-fun-cta-muted" disabled><i class="fa fa-check-circle mr-2" aria-hidden="true"></i>{:__('今日已完成')}</button>
                                {else}
                                <button type="button" class="oh-fun-cta" onclick="var el=document.getElementById('fun-test-start'); if(el){el.scrollIntoView({behavior:'smooth',block:'start'}); setTimeout(function(){window.scrollBy({top:-80,behavior:'smooth'});},300);} "><i class="fa fa-play-circle mr-2" aria-hidden="true"></i>{:__('立即测试')}</button>
                                {/if}
                            </div>
                        </div>
                    </header>

                    <div class="ui-card-body space-y-4">
                        <div class="bg-black/5 p-2 text-base font-bold text-gray-900">
                            {:__('测：')}{cms:archives name="sub_title|htmlentities" /}
                        </div>

                        <div class="text-sm leading-7 text-gray-700">
                            {cms:archives name="content" /}
                        </div>

                        <img src="{cms:archives name='image|cdnurl'}"
                             alt="{cms:archives name='title|htmlentities'} - 心理测试题图片"
                             title="{cms:archives name='title|htmlentities'}"
                             itemprop="image"
                             width="1280"
                             height="670"
                             fetchpriority="high"
                             loading="eager"
                             class="w-full bg-gray-100 object-contain" style="max-height:360px;">

                        <div class="bg-black/5 p-2 text-sm font-bold text-gray-900">
                            {:__('问题：')}{cms:archives name="title" /}
                        </div>

                        <div id="fun-test-start"></div>

                        {if $check_data['code']==3}
                        <a href="{:url('index/user/login')}" class="block border border-amber-200 bg-amber-50 p-4 text-center text-sm font-semibold text-amber-800 hover:bg-amber-100">{:__('超出游客次数，请登录增加测试次数')}</a>
                        {elseif $check_data['code']==0}
                        <div class="border border-amber-200 bg-amber-50 p-4 text-center text-sm font-semibold text-amber-800">{:__('今日已经做过该测试了，请明天再重试哦')}</div>
                        {elseif $check_data['code']!==4}

                        <div v-if="loading" class="border border-gray-200 bg-white p-4 text-center text-sm text-gray-600">
                            {:__('加载中...')}
                        </div>

                        <div class="oh-fun-shell">
                            <div class="oh-fun-work">

                                <div v-if="!loading && productInfo && productInfo.back_type==1" class="space-y-4">
                                    <button type="button" class="oh-fun-choice flex w-full items-center gap-3 bg-white px-4 py-3 text-left text-base font-semibold text-gray-900 shadow-sm transition hover:bg-black/5" v-for="item in quesList" @click="getExamResult(item)" :disabled="isGenerating">
                                        <span class="text-black/80">{{item.mark}}.</span>
                                        <span class="min-w-0 flex-1">{{item.title}}</span>
                                    </button>
                                </div>

                                <div v-if="!loading && productInfo && productInfo.back_type==0" class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                    <button type="button" class="oh-fun-choice flex w-full items-center justify-center bg-white p-4 text-base font-bold text-gray-900 shadow-sm transition hover:bg-black/5" v-for="item in quesList" @click="getExamResult(item)" :disabled="isGenerating">
                                        {{item.mark}}.
                                    </button>
                                </div>

                                <div v-if="!loading && productInfo && productInfo.back_type==2" class="space-y-4">
                                    <button type="button" class="oh-fun-choice flex w-full items-start gap-3 bg-white px-4 py-3 text-left text-base font-semibold text-gray-900 shadow-sm transition hover:bg-black/5" v-for="item in quesList" @click="getExamResult(item)" :disabled="isGenerating">
                                        <span class="text-black/80">{{item.mark}}.</span>
                                        <span class="min-w-0 flex-1">{{item.title}}</span>
                                    </button>
                                </div>

                                <div v-if="!loading && productInfo && productInfo.back_type==3" class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                    <button type="button" class="oh-fun-choice w-full bg-white p-4 text-left shadow-sm transition"
                                            v-for="item in quesList" @click="selectItem(item)"
                                            :class="selectedItem && selectedItem.id === item.id ? 'bg-black/5' : 'hover:bg-black/5'">
                                        <div class="flex items-start gap-2">
                                            <div class="font-bold text-black/80">{{item.mark}}.</div>
                                            <div class="min-w-0 flex-1 font-bold text-gray-900">{{item.title}}</div>
                                            <div v-if="selectedItem && selectedItem.id === item.id" class="ml-auto text-black">✓</div>
                                        </div>
                                        <img v-if="item.cover" :src="item.cover" :alt="item.title" width="270" height="350" class="mt-3 w-full max-h-52 bg-white object-contain">
                                    </button>
                                </div>

                                <div v-if="selectedItem" class="pt-2 text-center">
                                    <button type="button" @click="submitAnswer" class="inline-flex items-center rounded-none bg-black px-10 py-3 text-sm font-semibold tracking-[0.14em] text-white shadow hover:bg-black/90" :disabled="isGenerating">{:__('确认选择')}</button>
                                </div>

                            </div>
                        </div>
                        {/if}
                    </div>
                </article>

                <section class="ui-card mt-6" aria-label="{:__('免责声明')}">
                    <div class="ui-card-body bg-amber-50 text-center text-sm font-medium text-amber-800" style="padding:10px 12px;">
                        {:__('注：趣味型测试仅供娱乐参考，不可作为临床诊断依据。')}
                    </div>
                </section>

                {if $config.iscomment && config('fastadmin.usercenter')}
                <section class="ui-card mt-6" id="comments">
                    <div class="ui-card-header">
                        <h2 class="text-base font-semibold text-gray-900">{:__('评论列表')}
                            <small class="ml-2 text-sm font-normal text-gray-600">{:__('共有')} <span class="font-semibold text-black">{cms:archives name="comments" /}</span> {:__('条评论')}</small>
                        </h2>
                    </div>
                    <div class="ui-card-body">
                        <!--@formatter:off-->
                        {if $__ARCHIVES__.iscomment}
                        {include file="common/comment" type="archives" aid="__ARCHIVES__.eid"}
                        {else/}
                        <div class="text-center text-sm text-gray-500">{:__('评论功能已关闭')}</div>
                        {/if}
                        <!--@formatter:on-->
                    </div>
                </section>
                {/if}
            </main>

            <aside class="space-y-6 lg:col-span-4">
                <section class="ui-card" aria-label="{:__('相关推荐')}">
                    <div class="ui-card-header">
                        <h2 class="text-base font-semibold text-gray-900">{:__('相关推荐')}</h2>
                    </div>
                    <div class="ui-card-body grid grid-cols-1 gap-4 sm:grid-cols-2">
                        {cms:arclist id="item" type="son" channel="25" limit="6"}
                        {include file="common/item_funtest" /}
                        {/cms:arclist}
                    </div>
                </section>

                {include file="common/authorinfo" /}
                {include file="common/sidebar" /}
            </aside>
        </div>
    </div>
</div>
<script type="text/javascript" src="__ADDON__/js/vue.js"></script>
<script type="text/javascript" src="__ADDON__/js/vue-index.js"></script>

<script>
    var token = "<?php echo $token?>";
    var currentDomain = window.location.host;
    
    // 忽略 Office 标签（从 Word 复制粘贴产生的标签）
    Vue.config.ignoredElements = ['o:p'];
    
    new Vue({
        el: '#app',
        data: {
            qid: '',
            count: 100,
            is_continue: '',
            quesList: [],
            productInfo: null,
            isMobile: false,
            loading: true,
            selectedItem: null,
            isGenerating: false
        },
        mounted() {
            this.$el.classList.remove('hidden');
            this.applyDynamicTitleStyle();
            this.isMobile = window.innerWidth <= 992;
            window.addEventListener('resize', () => {
                this.isMobile = window.innerWidth <= 992;
            });

            setTimeout(function () {
                if (typeof window.__cmsInitAdsense === 'function') {
                    window.__cmsInitAdsense();
                }
            }, 0);
            
            var url = window.location.href;
            const parsedUrl = new URL(url);
            const pathnameParts = parsedUrl.pathname.split("/");
            const filename = pathnameParts[pathnameParts.length - 1];
            this.qid = filename.split(".")[0];
            this.getQuestions()
        },
        methods: {
            applyDynamicTitleStyle() {
                const title = document.getElementById('article-title');
                if (!title) return;

                const cssText = title.getAttribute('data-css');
                if (!cssText) return;

                try {
                    title.style.cssText = cssText;
                } catch (e) {
                    console.warn('[Title] Failed to apply dynamic style', e);
                }
            },
            // 获取当前语言设置
            getCurrentLanguage() {
                // 优先从URL参数获取
                const urlParams = new URLSearchParams(window.location.search);
                const urlLang = urlParams.get('lg');
                if (urlLang) {
                    return urlLang;
                }
                
                // 从cookie获取
                const cookieLang = this.getCookie('frontend_language');
                if (cookieLang) {
                    return cookieLang;
                }
                
                // 默认返回中文
                return 'zh-cn';
            },
            
            // 获取Cookie的辅助函数
            getCookie(name) {
                const value = "; " + document.cookie;
                const parts = value.split("; " + name + "=");
                if (parts.length === 2) return parts.pop().split(";").shift();
            },
            
            getQuestions() {
                const params = new URLSearchParams();
                params.append('aid', this.qid);
                // 添加语言参数
                const currentLang = this.getCurrentLanguage();
                if (currentLang) {
                    params.append('lang', currentLang);
                }
                // params.append('token',token);
                
                fetch('/addons/cms/psychometry/getQuestions?',
                    {
                        method: 'POST',
                        body: params,
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.data) {
                            // 检查是否是custom类型测试（back_type == 3）
                            if (data.data.exam_info && data.data.exam_info.back_type == 3) {
                                // custom类型测试：question_data直接是选项数组
                                const options = data.data.question_data;
                                this.quesList = options || [];
                            } else {
                                // 普通测试：question_data是题目数组
                                this.quesList = data.data.question_data || [];
                            }
                            
                            this.productInfo = data.data.exam_info || null
                            this.loading = false
                        } else {
                            this.loading = false
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                        this.loading = false
                    });
            },
            selectItem(item) {
                this.selectedItem = item;
            },
            submitAnswer() {
                if (this.selectedItem) {
                    this.getExamResult(this.selectedItem);
                }
            },
            getExamResult(item) {
                if (this.isGenerating) return;
                this.isGenerating = true;
                const params = new URLSearchParams();
                params.append('aid', this.qid);
                params.append('token', token);
                
                // 构造答案数据
                const answerData = [{
                    qid: item.id,
                    question_id: item.id,
                    answer: item.mark
                }];
                
                params.append('answer_data', JSON.stringify(answerData));
                params.append('answer_mark', item.mark);

                fetch('/addons/cms/psychometry/getExamResult?',
                    {
                        method: 'POST',
                        body: params,
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code == 1) {
                            // Redirect to the result page based on test type
                            const testType = data.data.test_type || (this.productInfo && this.productInfo.test_type) || 'custom';
                            const resultPage = getResultPage(testType);
                            // 使用完整的URL，包含端口号
                            const baseUrl = window.location.protocol + '//' + window.location.host;
                            try {
                                sessionStorage.setItem('cms_result_generating', '1');
                                sessionStorage.setItem('cms_result_generating_at', String(Date.now()));
                            } catch (e) {}
                            window.location.href = baseUrl + resultPage + '?answer_id=' + data.data.answer_id;
                        } else {
                            this.isGenerating = false;
                            alert(data.msg || '{:__("提交失败")}');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                        this.isGenerating = false;
                    });
            }
        }
    });
    
    // 根据测试类型获取对应的结果页面
    function getResultPage(testType) {
        const resultPages = {
            'mbti': '/p/results_mbti.html',
            'score': '/p/results_score.html',
            'dimension': '/p/results_dimension.html',
            'custom': '/p/results_custom.html',
            'nine_type': '/p/results_nine_type.html',
            'multiple_type': '/p/results_multiple.html'
        };
        return resultPages[testType] || '/p/ceshiye.html'; // 默认使用原来的页面
    }
</script>