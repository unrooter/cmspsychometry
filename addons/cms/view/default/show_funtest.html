{layout name="common/layout" /}

<!-- SEO结构化数据 - Quiz类型 -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Quiz",
  "name": "{$__ARCHIVES__.title|htmlentities}",
  "description": "{$__ARCHIVES__.sub_title|htmlentities}",
  "url": "{$Think.request.url}",
  "image": "{$__ARCHIVES__.image|cdnurl}",
  "author": {
    "@type": "Organization",
    "name": "{cms:config name='cms.sitename'/}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "{cms:config name='cms.sitename'/}",
    "logo": {
      "@type": "ImageObject",
      "url": "{$Think.config.cms.sitelogo|cdnurl}"
    }
  },
  "datePublished": "{$__ARCHIVES__.publishtime|date='c',###}",
  "dateModified": "{$__ARCHIVES__.updatetime|date='c',###}"
}
</script>


<div id="app" v-cloak class="hidden">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8" id="content-container" itemscope itemtype="https://schema.org/Quiz">
        <nav aria-label="breadcrumb" class="mt-6">
            <ol class="flex flex-wrap items-center gap-x-2 gap-y-1 text-sm text-gray-600" itemscope itemtype="https://schema.org/BreadcrumbList">
                {php}$breadPos = 0;{/php}
                {cms:breadcrumb id="item"}
                {php}$breadPos++;{/php}
                <li class="inline-flex items-center" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                    <a class="hover:text-emerald-600" href="{$item.url}" itemprop="item">
                        <span itemprop="name">{:__($item.name)}</span>
                    </a>
                    <meta itemprop="position" content="{$breadPos}" />
                </li>
                {/cms:breadcrumb}
            </ol>
        </nav>

        <div class="mt-6 grid gap-6 lg:grid-cols-12">
            <main class="lg:col-span-8">
                <article class="rounded-lg border border-gray-200 bg-white shadow-sm">
                    <header class="space-y-4 border-b border-gray-100 p-5">
                        <h1 class="text-xl font-bold leading-7 text-gray-900" itemprop="name" {if $__ARCHIVES__.style}data-css="{$__ARCHIVES__.style_text}"{/if} id="article-title">
                            {cms:archives name="title|htmlentities" /}
                        </h1>
                        <div class="rounded-md bg-emerald-50 p-3 text-sm font-semibold text-emerald-800" itemprop="description">
                            <i class="fa fa-quote-left mr-2" aria-hidden="true"></i>
                            {cms:archives name="sub_title|htmlentities" /}
                        </div>
                        <div class="flex flex-wrap items-center gap-x-6 gap-y-2 text-sm text-gray-600">
                            <span class="inline-flex items-center gap-2"><i class="fa fa-eye text-emerald-600" aria-hidden="true"></i>{cms:archives name="views" /} 次</span>
                            <span class="inline-flex items-center gap-2"><i class="fa fa-calendar text-emerald-600" aria-hidden="true"></i>{$__ARCHIVES__.publishtime|date='Y-m-d',###}</span>
                            <span class="inline-flex items-center gap-2"><i class="fa fa-tag text-emerald-600" aria-hidden="true"></i>{:__('趣味测试')}</span>
                        </div>
                    </header>

                    <div id="ad-header-horizontal" class="my-4 min-h-[90px]"></div>

                    <div class="space-y-5 p-5">
                        <div class="rounded-md bg-emerald-50 p-3 text-base font-bold text-gray-900">
                            {:__('测：')}{cms:archives name="sub_title|htmlentities" /}
                        </div>

                        <div class="text-sm leading-7 text-gray-700">
                            {cms:archives name="content" /}
                        </div>

                        <div id="ad-in-article" class="my-4 min-h-[100px] text-center"></div>

                        <img src="{cms:archives name='image|cdnurl'}"
                             alt="{cms:archives name='title|htmlentities'} - 心理测试题图片"
                             title="{cms:archives name='title|htmlentities'}"
                             itemprop="image"
                             width="1280"
                             height="670"
                             fetchpriority="high"
                             loading="eager"
                             class="w-full rounded-lg bg-gray-100 object-cover">

                        <div class="rounded-md bg-emerald-50 p-3 text-sm font-bold text-gray-900">
                            {:__('问题：')}{cms:archives name="title" /}
                        </div>

                        {if $check_data['code']==3}
                        <a href="{:url('index/user/login')}" class="block rounded-md border border-amber-200 bg-amber-50 p-4 text-center text-sm font-semibold text-amber-800 hover:bg-amber-100">{:__('超出游客次数，请登录增加测试次数')}</a>
                        {elseif $check_data['code']==0}
                        <div class="rounded-md border border-amber-200 bg-amber-50 p-4 text-center text-sm font-semibold text-amber-800">{:__('今日已经做过该测试了，请明天再重试哦')}</div>
                        {elseif $check_data['code']!==4}

                        <div v-if="loading" class="rounded-md border border-gray-200 bg-white p-4 text-center text-sm text-gray-600">
                            {:__('加载中...')}
                        </div>

                        <div v-if="!loading && productInfo && productInfo.back_type==1" class="space-y-4">
                            <button type="button" class="flex w-full items-center gap-3 rounded-lg bg-gray-100 p-4 text-left text-base font-semibold text-gray-900 transition hover:bg-gray-200" v-for="item in quesList" @click="getExamResult(item)">
                                <span class="text-emerald-700">{{item.mark}}.</span>
                                <span class="min-w-0 flex-1">{{item.title}}</span>
                            </button>
                        </div>

                        <div v-if="!loading && productInfo && productInfo.back_type==0" class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                            <button type="button" class="flex w-full items-center justify-center rounded-lg bg-gray-100 p-6 text-base font-bold text-gray-900 transition hover:bg-gray-200" v-for="item in quesList" @click="getExamResult(item)">
                                {{item.mark}}.
                            </button>
                        </div>

                        <div v-if="!loading && productInfo && productInfo.back_type==2" class="space-y-4">
                            <button type="button" class="flex w-full items-start gap-3 rounded-lg bg-gray-100 p-4 text-left text-base font-semibold text-gray-900 transition hover:bg-gray-200" v-for="item in quesList" @click="getExamResult(item)">
                                <span class="text-emerald-700">{{item.mark}}.</span>
                                <span class="min-w-0 flex-1">{{item.title}}</span>
                            </button>
                        </div>

                        <div v-if="!loading && productInfo && productInfo.back_type==3" class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                            <button type="button" class="w-full rounded-lg border-2 p-4 text-left transition"
                                    v-for="item in quesList" @click="selectItem(item)"
                                    :class="selectedItem && selectedItem.id === item.id ? 'border-emerald-600 bg-emerald-50 shadow' : 'border-gray-200 bg-white hover:border-emerald-600'">
                                <div class="flex items-start gap-2">
                                    <div class="font-bold text-emerald-700">{{item.mark}}.</div>
                                    <div class="min-w-0 flex-1 font-bold text-gray-900">{{item.title}}</div>
                                    <div v-if="selectedItem && selectedItem.id === item.id" class="ml-auto text-emerald-600">✓</div>
                                </div>
                                <img v-if="item.cover" :src="item.cover" :alt="item.title" width="270" height="350" class="mt-3 w-full max-h-52 rounded-md bg-white object-contain">
                            </button>
                        </div>

                        <div v-if="selectedItem" class="pt-2 text-center">
                            <button type="button" @click="submitAnswer" class="inline-flex items-center rounded-full bg-emerald-600 px-8 py-3 text-sm font-semibold text-white shadow hover:bg-emerald-700">{:__('确认选择')}</button>
                        </div>
                        {/if}
                    </div>
                </article>

                <section class="mt-6 rounded-lg border border-amber-200 bg-amber-50 p-4 text-center text-sm font-medium text-amber-800">
                    {:__('注：趣味型测试仅供娱乐参考，不可作为临床诊断依据。')}
                </section>

                {if $config.iscomment && config('fastadmin.usercenter')}
                <section class="mt-6 rounded-lg border border-gray-200 bg-white shadow-sm" id="comments">
                    <div class="border-b border-gray-100 px-4 py-3">
                        <h2 class="text-base font-semibold text-gray-900">{:__('评论列表')}
                            <small class="ml-2 text-sm font-normal text-gray-600">{:__('共有')} <span class="font-semibold text-emerald-700">{cms:archives name="comments" /}</span> {:__('条评论')}</small>
                        </h2>
                    </div>
                    <div class="p-4">
                        <!--@formatter:off-->
                        {if $__ARCHIVES__.iscomment}
                        {include file="common/comment" type="archives" aid="__ARCHIVES__.eid"}
                        {else/}
                        <div class="text-center text-sm text-gray-500">{:__('评论功能已关闭')}</div>
                        {/if}
                        <!--@formatter:on-->
                    </div>
                </section>
                {/if}
            </main>

            <aside class="space-y-6 lg:col-span-4">
                <section class="rounded-lg border border-gray-200 bg-white shadow-sm" aria-label="{:__('相关推荐')}">
                    <div class="border-b border-gray-100 px-4 py-3">
                        <h2 class="text-base font-semibold text-gray-900">{:__('相关推荐')}</h2>
                    </div>
                    <div class="grid grid-cols-1 gap-4 p-4 sm:grid-cols-2">
                        {cms:arclist id="item" type="son" channel="25" limit="6"}
                        {include file="common/item_funtest" /}
                        {/cms:arclist}
                    </div>
                </section>

                <div id="ad-feed" class="my-4 min-h-[100px]"></div>
                <div id="ad-sidebar-top" class="my-4 min-h-[100px]"></div>

                {include file="common/authorinfo" /}
                {include file="common/sidebar" /}
            </aside>
        </div>
    </div>
</div>
<script type="text/javascript" src="__ADDON__/js/vue.js"></script>
<script type="text/javascript" src="__ADDON__/js/vue-index.js"></script>

<script>
    var token = "<?php echo $token?>";
    var currentDomain = window.location.host;
    
    // 忽略 Office 标签（从 Word 复制粘贴产生的标签）
    Vue.config.ignoredElements = ['o:p'];
    
    new Vue({
        el: '#app',
        data: {
            qid: '',
            count: 100,
            is_continue: '',
            quesList: [],
            productInfo: null,
            isMobile: false,
            loading: true,
            selectedItem: null
        },
        mounted() {
            this.$el.classList.remove('hidden');
            this.applyDynamicTitleStyle();
            this.isMobile = window.innerWidth <= 992;
            window.addEventListener('resize', () => {
                this.isMobile = window.innerWidth <= 992;
            });
            
            var url = window.location.href;
            const parsedUrl = new URL(url);
            const pathnameParts = parsedUrl.pathname.split("/");
            const filename = pathnameParts[pathnameParts.length - 1];
            this.qid = filename.split(".")[0];
            this.getQuestions()
            
            // 动态插入 Google AdSense 广告
            this.initAds();
        },
        methods: {
            applyDynamicTitleStyle() {
                const title = document.getElementById('article-title');
                if (!title) return;

                const cssText = title.getAttribute('data-css');
                if (!cssText) return;

                try {
                    title.style.cssText = cssText;
                } catch (e) {
                    console.warn('[Title] Failed to apply dynamic style', e);
                }
            },
            initAds() {
                // 等待 AdSense 脚本加载
                const waitForAdSense = (callback, maxAttempts = 50) => {
                    let attempts = 0;
                    const checkAdSense = () => {
                        if (window.adsbygoogle || attempts >= maxAttempts) {
                            callback();
                        } else {
                            attempts++;
                            setTimeout(checkAdSense, 200);
                        }
                    };
                    checkAdSense();
                };
                
                // 创建广告的辅助函数
                const createAd = (container, config) => {
                    if (!container) return;
                    
                    // 创建 ins 元素
                    const ins = document.createElement('ins');
                    ins.className = 'adsbygoogle block';
                    
                    // 设置广告属性
                    Object.keys(config).forEach(key => {
                        ins.setAttribute(key, config[key]);
                    });
                    
                    container.appendChild(ins);
                    
                    // 延迟执行广告加载
                    setTimeout(() => {
                        try {
                            (adsbygoogle = window.adsbygoogle || []).push({});
                        } catch (e) {
                            // 静默处理错误
                        }
                    }, 100);
                };
                
                // 等待 AdSense 加载完成后创建广告
                waitForAdSense(() => {
                    // 头部横向广告
                    createAd(document.getElementById('ad-header-horizontal'), {
                        'data-ad-client': 'ca-pub-9195262048954682',
                        'data-ad-slot': '7906059149',
                        'data-ad-format': 'auto',
                        'data-full-width-responsive': 'true'
                    });
                    
                    // 文章内嵌广告
                    createAd(document.getElementById('ad-in-article'), {
                        'data-ad-layout': 'in-article',
                        'data-ad-format': 'fluid',
                        'data-ad-client': 'ca-pub-9195262048954682',
                        'data-ad-slot': '5294962935'
                    });
                    
                    // 信息流广告
                    createAd(document.getElementById('ad-feed'), {
                        'data-ad-format': 'fluid',
                        'data-ad-layout-key': '-6t+ed+2i-1n-4w',
                        'data-ad-client': 'ca-pub-9195262048954682',
                        'data-ad-slot': '3120669155'
                    });
                    
                    // 侧边栏广告 (autorelaxed 格式)
                    createAd(document.getElementById('ad-sidebar-top'), {
                        'data-ad-client': 'ca-pub-9195262048954682',
                        'data-ad-slot': '2901144473',
                        'data-ad-format': 'autorelaxed'
                    });
                });
            },
            // 获取当前语言设置
            getCurrentLanguage() {
                // 优先从URL参数获取
                const urlParams = new URLSearchParams(window.location.search);
                const urlLang = urlParams.get('lg');
                if (urlLang) {
                    return urlLang;
                }
                
                // 从cookie获取
                const cookieLang = this.getCookie('frontend_language');
                if (cookieLang) {
                    return cookieLang;
                }
                
                // 默认返回中文
                return 'zh-cn';
            },
            
            // 获取Cookie的辅助函数
            getCookie(name) {
                const value = "; " + document.cookie;
                const parts = value.split("; " + name + "=");
                if (parts.length === 2) return parts.pop().split(";").shift();
            },
            
            getQuestions() {
                const params = new URLSearchParams();
                params.append('aid', this.qid);
                // 添加语言参数
                const currentLang = this.getCurrentLanguage();
                if (currentLang) {
                    params.append('lang', currentLang);
                }
                // params.append('token',token);
                
                fetch('/addons/cms/psychometry/getQuestions?',
                    {
                        method: 'POST',
                        body: params,
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.data) {
                            // 检查是否是custom类型测试（back_type == 3）
                            if (data.data.exam_info && data.data.exam_info.back_type == 3) {
                                // custom类型测试：question_data直接是选项数组
                                const options = data.data.question_data;
                                this.quesList = options || [];
                            } else {
                                // 普通测试：question_data是题目数组
                                this.quesList = data.data.question_data || [];
                            }
                            
                            this.productInfo = data.data.exam_info || null
                            this.loading = false
                        } else {
                            this.loading = false
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                        this.loading = false
                    });
            },
            selectItem(item) {
                this.selectedItem = item;
            },
            submitAnswer() {
                if (this.selectedItem) {
                    this.getExamResult(this.selectedItem);
                }
            },
            getExamResult(item) {
                const params = new URLSearchParams();
                params.append('aid', this.qid);
                params.append('token', token);
                
                // 构造答案数据
                const answerData = [{
                    qid: item.id,
                    question_id: item.id,
                    answer: item.mark
                }];
                
                params.append('answer_data', JSON.stringify(answerData));
                params.append('answer_mark', item.mark);

                fetch('/addons/cms/psychometry/getExamResult?',
                    {
                        method: 'POST',
                        body: params,
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code == 1) {
                            // Redirect to the result page based on test type
                            const testType = data.data.test_type || productInfo.test_type || 'custom';
                            const resultPage = getResultPage(testType);
                            // 使用完整的URL，包含端口号
                            const baseUrl = window.location.protocol + '//' + window.location.host;
                            window.location.href = baseUrl + resultPage + '?answer_id=' + data.data.answer_id;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                    });
            }
        }
    });
    
    // 根据测试类型获取对应的结果页面
    function getResultPage(testType) {
        const resultPages = {
            'mbti': '/p/results_mbti.html',
            'score': '/p/results_score.html',
            'dimension': '/p/results_dimension.html',
            'custom': '/p/results_custom.html',
            'nine_type': '/p/results_nine_type.html',
            'multiple_type': '/p/results_multiple.html'
        };
        return resultPages[testType] || '/p/ceshiye.html'; // 默认使用原来的页面
    }
</script>