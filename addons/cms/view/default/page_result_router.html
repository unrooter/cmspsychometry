{extend name="common/layout" /}

{block name="content"}
<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div id="app">
        <!-- 加载状态 -->
        <div v-if="loading" class="py-14 text-center">
            <div class="mx-auto h-10 w-10 animate-spin rounded-full border-4 border-gray-200 border-t-black" role="status">
                <span class="sr-only">加载中...</span>
            </div>
            <p class="mt-3 text-sm text-gray-600">正在加载测试结果...</p>
        </div>

        <!-- 错误状态 -->
        <div v-if="error" class="my-12 ui-card text-center">
            <div class="ui-card-body">
                <h4 class="text-base font-semibold text-gray-900">加载失败</h4>
                <p class="mt-2 text-sm text-gray-600">{{error}}</p>
                <button @click="loadData" class="mt-4 inline-flex items-center justify-center rounded-md bg-black px-4 py-2 text-sm font-semibold text-white hover:bg-black/90">重新加载</button>
            </div>
        </div>

        <!-- 动态结果页面容器 -->
        <div v-if="!loading && !error && allInfo" id="dynamic-result-container">
            <!-- 根据测试类型动态加载对应的结果页面 -->
            <div v-if="allInfo.test_info && allInfo.test_info.test_type">
                <!-- MBTI类型 -->
                <div v-if="allInfo.test_info.test_type === 'mbti'" v-html="mbtiTemplate"></div>
                
                <!-- 分数类型 -->
                <div v-else-if="allInfo.test_info.test_type === 'score'" v-html="scoreTemplate"></div>
                
                <!-- 维度类型 -->
                <div v-else-if="allInfo.test_info.test_type === 'dimension'" v-html="dimensionTemplate"></div>
                
                <!-- 自定义类型 -->
                <div v-else-if="allInfo.test_info.test_type === 'custom'" v-html="customTemplate"></div>
                
                <!-- 九型人格类型 -->
                <div v-else-if="allInfo.test_info.test_type === 'nine_type'" v-html="nineTypeTemplate"></div>
                
                <!-- 多选类型 -->
                <div v-else-if="allInfo.test_info.test_type === 'multiple_type'" v-html="multipleTypeTemplate"></div>
                
                <!-- 默认类型 -->
                <div v-else>
                    <div class="my-12 ui-card text-center">
                        <div class="ui-card-body">
                            <h4 class="text-base font-semibold text-gray-900">测试结果</h4>
                            <p class="mt-2 text-sm text-gray-600">测试类型：{{allInfo.test_info.test_type}}</p>
                            <p class="mt-1 text-sm text-gray-600">结果：{{allInfo.result || '测试完成'}}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
new Vue({
    el: '#app',
    data: {
        loading: true,
        error: null,
        allInfo: null,
        mbtiTemplate: '',
        scoreTemplate: '',
        dimensionTemplate: '',
        customTemplate: '',
        nineTypeTemplate: '',
        multipleTypeTemplate: ''
    },
    mounted() {
        this.loadData();
        this.loadTemplates();
    },
    methods: {
        loadData() {
            this.loading = true;
            this.error = null;
            
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const answer_id = urlParams.get('answer_id');
            
            if (!answer_id) {
                this.error = '缺少测试结果ID';
                this.loading = false;
                return;
            }
            
            // 调用API获取数据
            fetch('/addons/cms/psychometry/answerInfo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'answer_id=' + answer_id
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 1) {
                    this.allInfo = data.data;
                } else {
                    this.error = data.msg || '获取数据失败';
                }
                this.loading = false;
            })
            .catch(error => {
                this.error = '网络错误：' + error.message;
                this.loading = false;
            });
        },
        
        loadTemplates() {
            // 加载不同测试类型的模板
            this.loadTemplate('mbti', '/addons/cms/view/default/results/mbti.html');
            this.loadTemplate('score', '/addons/cms/view/default/results/score.html');
            this.loadTemplate('dimension', '/addons/cms/view/default/results/dimension.html');
            this.loadTemplate('custom', '/addons/cms/view/default/results/custom.html');
            // 九型人格和多选类型暂时使用自定义模板
            this.nineTypeTemplate = this.getDefaultTemplate('nine_type');
            this.multipleTypeTemplate = this.getDefaultTemplate('multiple_type');
        },
        
        loadTemplate(type, url) {
            fetch(url)
            .then(response => response.text())
            .then(html => {
                // 提取body内容
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const bodyContent = doc.body.innerHTML;
                this[type + 'Template'] = bodyContent;
            })
            .catch(error => {
                console.error('加载模板失败:', error);
                this[type + 'Template'] = this.getDefaultTemplate(type);
            });
        },
        
        getDefaultTemplate(type) {
            return `
                <div class="my-12 rounded-lg border border-sky-200 bg-sky-50 p-6 text-center">
                    <h4 class="text-base font-semibold text-sky-900">${this.getTypeName(type)}测试结果</h4>
                    <p class="mt-2 text-sm text-sky-800">测试类型：${type}</p>
                    <p class="mt-1 text-sm text-sky-800">结果：{{allInfo.result || '测试完成'}}</p>
                </div>
            `;
        },
        
        getTypeName(type) {
            const names = {
                'mbti': 'MBTI',
                'score': '分数',
                'dimension': '维度',
                'custom': '自定义',
                'nine_type': '九型人格',
                'multiple_type': '多选'
            };
            return names[type] || type;
        }
    }
});
</script>
{/block}
