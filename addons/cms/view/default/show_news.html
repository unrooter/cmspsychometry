{layout name="common/layout" /}

<div class="container" id="content-container">

    <div class="row">

        <main class="col-xs-12 col-md-8">
            <div class="panel panel-default article-content">
                <div class="panel-heading">
                    <ol class="breadcrumb">
                        <!-- S 面包屑导航 -->
                        {cms:breadcrumb id="item"}
                        <li><a href="{$item.url}">{:__($item.name)}</a></li>
                        {/cms:breadcrumb}
                        <!-- E 面包屑导航 -->
                    </ol>
                </div>
                
                <!-- Google AdSense 头部横向广告 -->
                <div id="ad-header-horizontal" style="margin: 15px 0; min-height: 90px;"></div>
                
                <div class="panel-body">
                    <div class="article-metas">
                        <h1 class="metas-title" {if $__ARCHIVES__.style}style="{$__ARCHIVES__.style_text}" {/if}>{cms:archives name="title|htmlentities" /}</h1>

                        <div class="metas-body">
                            {if isset($__ARCHIVES__.author) && $__ARCHIVES__.author}
                            <span>
                                <i class="fa fa-user"></i> {cms:archives name="author|htmlentities" /}
                            </span>
                            {/if}
                            <span class="views-num">
                                <i class="fa fa-eye"></i> {cms:archives name="views" /} 阅读
                            </span>
                            <span class="comment-num">
                                <i class="fa fa-comments"></i> {cms:archives name="comments" /} 评论
                            </span>
                            <span class="like-num">
                                <i class="fa fa-thumbs-o-up"></i>
                                <span class="js-like-num"> {cms:archives name="likes" /} 点赞
                                </span>
                            </span>
                        </div>

                    </div>

                    <div class="article-text">
                        <!-- S 正文 -->
                        <p>
                            {if $__ARCHIVES__.is_paid_part_of_content || $__ARCHIVES__.ispaid}
                            {cms:archives name="content" /}
                            {/if}
                        </p>
                        <!-- E 正文 -->
                    </div>
                    
                    <!-- Google AdSense 文章内嵌广告 -->
                    <div id="ad-in-article" style="margin: 20px 0; min-height: 250px;"></div>

                    {include file="common/metainfo" /}

                    {include file="common/related" /}

                    <div class="clearfix"></div>
                </div>
            </div>

            {if $config.iscomment && config('fastadmin.usercenter')}
            <div class="panel panel-default" id="comments">
                <div class="panel-heading">
                    <h3 class="panel-title">{:__('Comment list')}
                        <small>共有 <span>{cms:archives name="comments" /}</span> 条评论</small>
                    </h3>
                </div>
                <div class="panel-body">
                    {if $__ARCHIVES__.iscomment}
                    {include file="common/comment" type="archives" aid="__ARCHIVES__.eid"}
                    {else/}
                    <div class="text-muted text-center">评论功能已关闭</div>
                    {/if}
                </div>
            </div>
            {/if}

        </main>

        <aside class="col-xs-12 col-md-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">专业测评</h3>
                </div>
                <div class="panel-body p-0">
                    <div class="row">
                        <div class="article-list">
                            {cms:arclist id="item" channel="8" length="8" row="3"}
                            <div class="col-xs-12 product-item">
                                {include file="common/item_protest"}
                            </div>
                            {/cms:arclist}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Google AdSense 侧边栏广告 -->
            <div id="ad-sidebar" style="margin: 20px 0; min-height: 600px;"></div>
            
            {include file="common/authorinfo" /}
            {include file="common/sidebar" /}
        </aside>
    </div>
</div>

<!-- Google AdSense JavaScript -->
<script type="text/javascript" src="__ADDON__/js/vue.js"></script>
<script>
Vue.config.ignoredElements = ['o:p'];

new Vue({
    el: '#content-container',
    mounted() {
        // 激进优化：立即初始化
        this.initAds();
    },
    methods: {
        initAds() {
            console.log('[AdSense] Init starting...', window._adsenseInitialized);
            
            if (window._adsenseInitialized) {
                console.log('[AdSense] Already initialized, skipping');
                return;
            }
            
            console.log('[AdSense] Starting initialization');
            
            // 50ms快速检测
            const waitForAdSense = (callback, maxAttempts = 100) => {
                let attempts = 0;
                const startTime = Date.now();
                
                const checkAdSense = () => {
                    if (window.adsbygoogle && Array.isArray(window.adsbygoogle)) {
                        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
                        console.log(`[AdSense] Script ready in ${elapsed}s`);
                        callback();
                    } else if (attempts >= maxAttempts) {
                        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
                        console.log(`[AdSense] Timeout after ${elapsed}s, trying anyway`);
                        callback();
                    } else {
                        attempts++;
                        setTimeout(checkAdSense, 50);
                    }
                };
                checkAdSense();
            };
            
            const createAd = (containerId, config) => {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.warn('[AdSense] Container not found:', containerId);
                    return;
                }
                
                const existingAd = container.querySelector('.adsbygoogle');
                if (existingAd && existingAd.getAttribute('data-adsbygoogle-status') === 'done') {
                    console.log('[AdSense] Ad already exists:', containerId);
                    return;
                }
                
                console.log('[AdSense] Creating ad:', containerId);
                container.innerHTML = '';
                const ins = document.createElement('ins');
                ins.className = 'adsbygoogle';
                ins.style.display = 'block';
                
                Object.keys(config).forEach(key => {
                    ins.setAttribute(key, config[key]);
                });
                
                container.appendChild(ins);
                
                // 立即push
                try {
                    console.log('[AdSense] Pushing ad:', containerId);
                    (adsbygoogle = window.adsbygoogle || []).push({});
                } catch (e) {
                    console.error('[AdSense] Push error:', containerId, e);
                }
            };
            
            waitForAdSense(() => {
                console.log('[AdSense] Creating all ads...');
                
                createAd('ad-header-horizontal', {
                    'data-ad-client': 'ca-pub-9195262048954682',
                    'data-ad-slot': '7906059149',
                    'data-ad-format': 'auto',
                    'data-full-width-responsive': 'true'
                });
                
                createAd('ad-in-article', {
                    'data-ad-client': 'ca-pub-9195262048954682',
                    'data-ad-slot': '5294962935',
                    'data-ad-format': 'fluid',
                    'data-ad-layout': 'in-article'
                });
                
                createAd('ad-sidebar', {
                    'data-ad-client': 'ca-pub-9195262048954682',
                    'data-ad-slot': '2901144473',
                    'data-ad-format': 'auto',
                    'data-full-width-responsive': 'true'
                });
                
                window._adsenseInitialized = true;
                console.log('[AdSense] ✅ All ads initialized');
            });
        }
    }
});

console.log('[AdSense] Vue initialized');
</script>
