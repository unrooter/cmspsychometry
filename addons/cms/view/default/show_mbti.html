{layout name="common/layout" /}

<!-- SEO结构化数据 - MBTI Quiz类型 -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Quiz",
  "name": "{$__ARCHIVES__.title|htmlentities}",
  "description": "{$__ARCHIVES__.sub_title ?: 'MBTI性格测试'}",
  "url": "{$Think.request.url}",
  "image": "{$__ARCHIVES__.image|cdnurl}",
  "author": {
    "@type": "Organization",
    "name": "{cms:config name='cms.sitename'/}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "{cms:config name='cms.sitename'/}",
    "logo": {
      "@type": "ImageObject",
      "url": "{$Think.config.cms.sitelogo|cdnurl}"
    }
  },
  "datePublished": "{$__ARCHIVES__.publishtime|date='c',###}",
  "dateModified": "{$__ARCHIVES__.updatetime|date='c',###}",
  "genre": "MBTI Personality Test"
}
</script>


<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8" id="content-container">
    <nav aria-label="breadcrumb" class="mt-6">
        <ol class="flex flex-wrap items-center gap-x-2 gap-y-1 text-sm text-gray-600" itemscope itemtype="https://schema.org/BreadcrumbList">
            {php}$breadPos = 0;{/php}
            {cms:breadcrumb id="item"}
            {php}$breadPos++;{/php}
            <li class="inline-flex items-center" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                <a class="hover:text-emerald-600" href="{$item.url}" itemprop="item">
                    <span itemprop="name">{:__($item.name)}</span>
                </a>
                <meta itemprop="position" content="{$breadPos}" />
            </li>
            {/cms:breadcrumb}
        </ol>
    </nav>

    <header class="mt-4 rounded-lg border border-gray-200 bg-white p-5 shadow-sm">
        <h1 class="text-xl font-bold text-gray-900" itemprop="headline">{cms:archives name="title|htmlentities" /}</h1>
        {if $__ARCHIVES__.sub_title}
        <p class="mt-2 text-sm leading-7 text-gray-600" itemprop="description">{$__ARCHIVES__.sub_title|htmlentities}</p>
        {/if}
        <div class="mt-3 flex flex-wrap items-center gap-x-6 gap-y-2 text-sm text-gray-600">
            <span class="inline-flex items-center gap-2">
                <i class="fa fa-eye text-emerald-600" aria-hidden="true"></i>
                <span>{cms:archives name="views" /} {:__('阅读')}</span>
            </span>
            <span class="inline-flex items-center gap-2">
                <i class="fa fa-calendar text-emerald-600" aria-hidden="true"></i>
                <span>{$__ARCHIVES__.publishtime|date="Y-m-d",###}</span>
            </span>
            <span class="inline-flex items-center gap-2">
                <i class="fa fa-folder-o text-emerald-600" aria-hidden="true"></i>
                <span>{$__CHANNEL__.name}</span>
            </span>
        </div>
    </header>

    <div id="ad-header-horizontal" class="my-4 min-h-[90px]"></div>

    <div id="app" v-cloak class="hidden">
        <div class="grid gap-6 lg:grid-cols-12">
            <main class="lg:col-span-8">
                <section class="rounded-lg border border-gray-200 bg-white shadow-sm" id="ceshi">
                    <div class="p-4">
                        <div id="introSection" class="space-y-4" :class="isShow ? 'hidden' : ''">
                            <div class="text-sm leading-7 text-gray-700">
                                {cms:archives name="content" /}
                            </div>
                            <div id="ad-in-article" class="my-4 min-h-[100px]"></div>
                            {if isset($check_data) && $check_data['code']==0}
                            <div class="rounded-md border border-amber-200 bg-amber-50 p-4 text-center text-sm font-medium text-amber-800">
                                <i class="fa fa-info-circle mr-2" aria-hidden="true"></i> {:__("今日已经做过该测试了，请明天再重试哦")}
                            </div>
                            {else}
                            <div class="py-6 text-center">
                                <button type="button" class="inline-flex items-center rounded-md bg-gradient-to-r from-emerald-500 to-emerald-600 px-10 py-4 text-base font-semibold text-white shadow hover:from-emerald-600 hover:to-emerald-700" @click="toTest">
                                    <i class="fa fa-play-circle mr-2" aria-hidden="true"></i> {:__('立即测试')}
                                </button>
                            </div>
                            {/if}
                        </div>

                        <div id="testSection" class="mt-6" :class="isShow ? '' : 'hidden'">
                            <div class="sticky top-0 z-10 rounded-lg bg-white/95 p-4 shadow-sm backdrop-blur">
                                <div class="h-2 overflow-hidden rounded-full bg-gray-200">
                                    <div class="h-full bg-gradient-to-r from-emerald-500 to-emerald-600 transition-all duration-500" :style="{width: progressPercentage + '%'}"></div>
                                </div>
                                <div class="mt-2 text-center text-sm font-semibold text-gray-700">
                                    <i class="fa fa-check-circle mr-2 text-emerald-600" aria-hidden="true"></i>
                                    {:__("已完成")} {{answer_data.length}} / {{quesInfo.count}} {:__("题")} ({{progressPercentage}}%)
                                </div>
                            </div>

                            <div class="mt-4 text-center">
                                <div v-for="(question, index) in quesList" :key="index" :class="currentIndex === index ? 'block' : 'hidden'">
                                    <div class="border-b-4 border-dashed border-gray-300 p-2">
                                        <div class="text-sm font-medium text-gray-600">
                                            <i class="fa fa-question-circle mr-2" aria-hidden="true"></i>{:__("第")}{{index+1}}{:__("题")}
                                        </div>
                                        <h2 class="mt-2 text-lg font-semibold leading-7 text-gray-900">{{ question.question }}</h2>
                                    </div>

                                    <div class="w-full">
                                        <div v-for="option in question.selectdata" class="mt-4 flex" @click="currentChange(option, index)">
                                            <div class="relative w-full rounded-lg border-2 p-4 text-left text-base font-semibold transition"
                                                 :class="[
                                                     option.current == 1 ? 'border-emerald-600 bg-emerald-600 text-white' : 'border-transparent bg-gray-100 text-gray-900 hover:bg-gray-200 hover:translate-x-1 hover:border-emerald-500',
                                                     isProcessing ? 'opacity-60 pointer-events-none' : ''
                                                 ]">
                                                {{option.value}}
                                                <span v-if="option.current == 1" class="absolute right-4 top-1/2 -translate-y-1/2 text-white">✔</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-4 flex items-center justify-between gap-3">
                                        <button type="button" class="inline-flex items-center rounded-md bg-gray-100 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-200" @click="toReturn">{:__("上一题")}</button>
                                        <div class="text-sm text-gray-700">
                                            {:__("第")} <span class="text-lg font-bold text-gray-900">{{index+1}}</span> / {{quesInfo.count}} {:__("题")}
                                        </div>
                                    </div>
                                </div>

                                <button type="button" class="mt-6 w-full rounded-lg bg-gradient-to-r from-emerald-500 to-emerald-600 py-4 text-center text-base font-bold tracking-wide text-white shadow hover:from-emerald-600 hover:to-emerald-700"
                                        v-show="isSubmit" @click="getExamResult()" :class="isSubmitting ? 'opacity-60 pointer-events-none' : ''">
                                    <span v-if="!isSubmitting"><i class="fa fa-check-circle mr-2" aria-hidden="true"></i>{:__("已完成做题，确认提交")}</span>
                                    <span v-else><i class="fa fa-spinner fa-spin mr-2" aria-hidden="true"></i>{:__("正在提交中...")}</span>
                                </button>
                            </div>
                        </div>

                        <div class="mt-6 space-y-6">
                            {include file="common/payment" /}
                            {include file="common/donate" /}
                            {include file="common/share" type="archives" image="__ARCHIVES__.image" aid="__ARCHIVES__.id"}
                            {include file="common/metainfo" /}
                        </div>
                    </div>
                </section>

                {if $config.iscomment && config('fastadmin.usercenter')}
                <section class="mt-6 rounded-lg border border-gray-200 bg-white shadow-sm" id="comments">
                    <div class="border-b border-gray-100 px-4 py-3">
                        <h2 class="text-base font-semibold text-gray-900">{:__('Comment list')}
                            <small class="ml-2 text-sm font-normal text-gray-600">{:__("共有")} <span class="font-semibold text-emerald-700">{cms:archives name="comments" /}</span> {:__("条评论")}</small>
                        </h2>
                    </div>
                    <div class="p-4">
                        {if $__ARCHIVES__.iscomment}
                        {include file="common/comment" type="archives" aid="__ARCHIVES__.id"}
                        {else/}
                        <div class="text-center text-sm text-gray-500">{:__("评论功能已关闭")}</div>
                        {/if}
                    </div>
                </section>
                {/if}
            </main>

            <aside class="space-y-6 lg:col-span-4">
                <section class="rounded-lg border border-gray-200 bg-white shadow-sm" aria-label="{:__('相关推荐')}">
                    <div class="border-b border-gray-100 px-4 py-3">
                        <h2 class="text-base font-semibold text-gray-900"><i class="fa fa-lightbulb-o mr-2 text-emerald-600" aria-hidden="true"></i>{:__('相关推荐')}</h2>
                    </div>
                    <div class="space-y-3 p-4">
                        {cms:arclist id="related" channel="$__CHANNEL__.id" limit="6" orderby="views" orderway="DESC"}
                        {if $related.id != $__ARCHIVES__.id}
                        <a href="{$related.url}" class="group flex gap-3 rounded-md bg-gray-50 p-3 transition hover:bg-gray-100">
                            <div class="relative h-20 w-20 shrink-0 overflow-hidden rounded-md bg-white">
                                <img src="{$related.image ?: '/assets/addons/cms/img/default.png'}" alt="{$related.title|htmlentities} - {:__('MBTI测试')}" loading="lazy" class="h-full w-full object-cover transition duration-300 group-hover:scale-105">
                                {if isset($related.tags[0])}
                                <span class="absolute bottom-1 left-1 right-1 rounded bg-emerald-600/95 px-1.5 py-0.5 text-center text-[10px] font-semibold text-white">{$related.tags.0.title|htmlentities}</span>
                                {/if}
                            </div>
                            <div class="min-w-0 flex-1">
                                <div class="text-sm font-semibold leading-6 text-gray-900 truncate">{$related.title|htmlentities|mb_substr=0,30}</div>
                                <div class="mt-1 text-xs text-gray-500"><i class="fa fa-eye mr-1 text-emerald-600" aria-hidden="true"></i>{$related.views|default=0}</div>
                            </div>
                        </a>
                        {/if}
                        {/cms:arclist}
                    </div>
                </section>

                <div id="ad-feed" class="my-4 min-h-[100px]"></div>
                <div id="ad-sidebar-top" class="my-4 min-h-[100px]"></div>

                {include file="common/authorinfo" /}
                {include file="common/sidebar" /}
            </aside>
        </div>
    </div>
</div>

<script data-render="script">
        var galleryThumbs = new Swiper('.gallery-thumbs', {
            spaceBetween: 10,
            slidesPerView: 5,
            freeMode: true,
            watchSlidesVisibility: true,
            watchSlidesProgress: true,
        });
        var galleryTop = new Swiper('.gallery-top', {
            spaceBetween: 10,
            navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev',
            },
            thumbs: {
                swiper: galleryThumbs
            }
        });
        //点击放大
        $(document).on("click", ".article-image .gallery-top .swiper-slide", function () {
            var data = [];
            $.each($(this).parent().children(), function (i, j) {
                data.push({
                    "src": $(this).data("src")
                });
            });
            var json = {
                "title": "",
                "start": $(this).index(),
                "data": data
            };
            layer.photos(JSON.parse(JSON.stringify({photos: json})));
        });
</script>

<script type="text/javascript" src="__ADDON__/js/vue.js"></script>
<script>
    var token = "{$token}";
    
    // 忽略 Office 标签（从 Word 复制粘贴产生的标签）
    Vue.config.ignoredElements = ['o:p'];
    
    // 根据测试类型获取对应的结果页面
    function getResultPage(testType) {
        const resultPages = {
            'mbti': '/p/results_mbti.html',
            'score': '/p/results_score.html', 
            'dimension': '/p/results_dimension.html',
            'custom': '/p/results_custom.html',
            'nine_type': '/p/results_nine_type.html',
            'multiple_type': '/p/results_multiple.html'
        };
        return resultPages[testType] || '/p/ceshiye.html';
    }
    
    new Vue({
        el: '#app',
        data: {
            qid: '',
            isShow: false,
            quesList: [],
            currentIndex: 0,
            quesInfo: '',
            answer_data: [],
            isSubmit: false,
            isSubmitting: false,
            isMobile: false,
            authCode: 0,
            currentLang: 'zh',
            isProcessing: false
        },
        computed: {
            // 计算进度百分比
            progressPercentage() {
                if (!this.quesInfo || !this.quesInfo.count) return 0;
                return Math.round((this.answer_data.length / this.quesInfo.count) * 100);
            }
        },
        mounted() {
            this.$el.classList.remove('hidden');
            this.isMobile = window.innerWidth <= 992;
            window.addEventListener('resize', () => {
                this.isMobile = window.innerWidth <= 992;
            });
            var url = window.location.href;
            const parsedUrl = new URL(url);
            const pathnameParts = parsedUrl.pathname.split("/");
            const filename = pathnameParts[pathnameParts.length - 1];
            this.qid = filename.split(".")[0];

            this.loadProgress();
            this.getQuestions();

            if (parsedUrl.searchParams.has('question')) {
                const questionIndex = parseInt(parsedUrl.searchParams.get('question')) - 1;
                if (questionIndex >= 0) {
                    this.currentIndex = questionIndex;
                    this.isShow = true;
                } else {
                    this.isShow = false;
                }
            } else {
                this.isShow = false;
            }
            
            setTimeout(() => {
                if (this.quesList.length === 0) {
                    this.isShow = false;
                }
            }, 100);
            window.addEventListener('popstate', this.handlePopState);
            
            // 动态插入 Google AdSense 广告
            this.initAds();
        },
        methods: {
            initAds() {
                // 等待 AdSense 脚本加载
                const waitForAdSense = (callback, maxAttempts = 50) => {
                    let attempts = 0;
                    const checkAdSense = () => {
                        if (window.adsbygoogle || attempts >= maxAttempts) {
                            callback();
                        } else {
                            attempts++;
                            setTimeout(checkAdSense, 200);
                        }
                    };
                    checkAdSense();
                };
                
                // 创建广告的辅助函数
                const createAd = (container, config) => {
                    if (!container) return;
                    
                    // 创建 ins 元素
                    const ins = document.createElement('ins');
                    ins.className = 'adsbygoogle';
                    ins.style.display = 'block';
                    
                    // 设置广告属性
                    Object.keys(config).forEach(key => {
                        ins.setAttribute(key, config[key]);
                    });
                    
                    container.appendChild(ins);
                    
                    // 延迟执行广告加载
                    setTimeout(() => {
                        try {
                            (adsbygoogle = window.adsbygoogle || []).push({});
                        } catch (e) {
                            // 静默处理错误
                        }
                    }, 100);
                };
                
                // 等待 AdSense 加载完成后创建广告
                waitForAdSense(() => {
                    // 头部横向广告
                    createAd(document.getElementById('ad-header-horizontal'), {
                        'data-ad-client': 'ca-pub-9195262048954682',
                        'data-ad-slot': '7906059149',
                        'data-ad-format': 'auto',
                        'data-full-width-responsive': 'true'
                    });
                    
                    // 文章内嵌广告
                    createAd(document.getElementById('ad-in-article'), {
                        'style': 'display:block; text-align:center;',
                        'data-ad-layout': 'in-article',
                        'data-ad-format': 'fluid',
                        'data-ad-client': 'ca-pub-9195262048954682',
                        'data-ad-slot': '5294962935'
                    });
                    
                    // 信息流广告
                    createAd(document.getElementById('ad-feed'), {
                        'data-ad-format': 'fluid',
                        'data-ad-layout-key': '-6t+ed+2i-1n-4w',
                        'data-ad-client': 'ca-pub-9195262048954682',
                        'data-ad-slot': '3120669155'
                    });
                    
                    // 侧边栏广告
                    const sidebarAd = document.getElementById('ad-sidebar-top');
                    createAd(sidebarAd, {
                        'data-ad-client': 'ca-pub-9195262048954682',
                        'data-ad-slot': '1134419628',
                        'data-ad-format': 'auto',
                        'data-full-width-responsive': 'true'
                    });
                });
            },
            
            getCurrentLanguage() {
                const urlParams = new URLSearchParams(window.location.search);
                const urlLang = urlParams.get('lg');
                if (urlLang) {
                    this.currentLang = urlLang;
                    return urlLang;
                }
                
                const cookieLang = this.getCookie('frontend_language');
                if (cookieLang) {
                    this.currentLang = cookieLang;
                    return cookieLang;
                }
                
                this.currentLang = 'zh';
                return 'zh-cn';
            },
            
            getCookie(name) {
                const value = "; " + document.cookie;
                const parts = value.split("; " + name + "=");
                if (parts.length === 2) return parts.pop().split(";").shift();
            },
            
            handlePopState() {
                var url = window.location.href;
                const parsedUrl = new URL(url);
                if (parsedUrl.searchParams.has('question')) {
                    const questionIndex = parseInt(parsedUrl.searchParams.get('question')) - 1;
                    if (questionIndex >= 0) {
                        this.currentIndex = questionIndex;
                        this.isShow = true;
                    } else {
                        this.isShow = false;
                    }
                } else {
                    this.isShow = false;
                }
            },
            toTest() {
                this.restartTest()
                this.isShow = true;
                history.pushState(null, '', `${window.location.pathname}?question=${this.currentIndex + 1}`);
                
                // 页面滚动到做题区域
                this.$nextTick(() => {
                    const testSection = document.getElementById('testSection');
                    if (testSection) {
                        testSection.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                        // 额外向上偏移一点，避免被导航栏遮挡
                        setTimeout(() => {
                            window.scrollBy({ 
                                top: -80, 
                                behavior: 'smooth' 
                            });
                        }, 300);
                    }
                });
            },
            currentChange(option, questionIndex) {
                // 防止连续快速点击
                if (this.isProcessing) {
                    return;
                }
                
                this.isProcessing = true;
                
                let answerList = {
                    qid: this.quesList[questionIndex].id,
                    answer: option.key,
                };

                this.quesList[questionIndex].selectdata.forEach(opt => {
                    this.$set(opt, 'current', opt.key === option.key ? 1 : '');
                });

                let index = this.answer_data.findIndex(answer => answer.qid == answerList.qid);
                if (index > -1) {
                    this.$set(this.answer_data, index, answerList);
                } else {
                    this.answer_data.push(answerList);
                }

                this.saveProgress();

                if (this.currentIndex < this.quesList.length - 1) {
                    setTimeout(() => {
                        this.currentIndex++;
                        history.pushState(null, '', `${window.location.pathname}?question=${this.currentIndex + 1}`);
                        // 在切换完成后才允许下一次点击
                        this.isProcessing = false;
                    }, 300);
                } else {
                    this.isSubmit = true;
                    this.isProcessing = false;
                }
            },
            toReturn() {
                if (this.isProcessing) {
                    return;
                }
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    history.pushState(null, '', `${window.location.pathname}?question=${this.currentIndex + 1}`);
                }
            },
            getQuestions() {
                const params = new URLSearchParams();
                params.append('aid', this.qid);
                const currentLang = this.getCurrentLanguage();
                if (currentLang) {
                    params.append('lang', currentLang);
                }
                fetch('/addons/cms/psychometry/getQuestions?', {
                    method: 'POST',
                    body: params,
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.data.exam_info && data.data.exam_info.back_type == 3) {
                            const options = data.data.question_data;
                            
                            const questionText = this.currentLang === 'zh-cn' || this.currentLang === 'zh' ? 
                                (data.data.exam_info.test_type === 'custom' ? '请选择您的答案：' : '测试题目') :
                                (data.data.exam_info.test_type === 'custom' ? 'Please select your answer:' : 'Test Question');
                            
                            this.quesList = [{
                                id: 1,
                                question: questionText,
                                selectdata: options.map(option => ({
                                    key: option.mark,
                                    value: option.title
                                }))
                            }];
                        } else {
                            this.quesList = data.data.question_data;
                        }
                        
                        this.quesInfo = data.data;
                        this.productInfo = data.data.exam_info;
                        this.restoreProgress();
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                    });
            },
            getExamResult() {
                if (this.isSubmitting) return;
                
                this.isSubmitting = true;
                
                const params = new URLSearchParams();
                params.append('aid', this.qid);
                params.append('answer_data', JSON.stringify(this.answer_data));

                fetch('/addons/cms/psychometry/getExamResult?', {
                    method: 'POST',
                    body: params,
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('提交返回的数据：', data);
                        
                        if (data.code == 1) {
                            if (!data.data || !data.data.answer_id) {
                                console.error('返回数据不完整：', data);
                                const alertMsg = this.currentLang === 'zh-cn' || this.currentLang === 'zh' ? 
                                    '提交成功，但返回数据不完整' : 'Submitted successfully, but data incomplete';
                                alert(alertMsg);
                                this.isSubmitting = false;
                                return;
                            }
                            
                            localStorage.removeItem(`quiz_${this.qid}_progress`);
                            this.answer_data = [];
                            this.currentIndex = 0;
                            this.isSubmit = false;
                            this.isShow = false;

                            const testType = data.data.test_type || 'mbti';
                            const resultPage = getResultPage(testType);
                            const baseUrl = window.location.protocol + '//' + window.location.host;
                            const resultUrl = baseUrl + resultPage + '?answer_id=' + data.data.answer_id;
                            
                            console.log('跳转到结果页：', resultUrl);
                            window.location.href = resultUrl;

                            history.replaceState(null, '', window.location.pathname);
                        } else {
                            console.error('提交失败：', data.msg);
                            const failMsg = this.currentLang === 'zh-cn' || this.currentLang === 'zh' ? 
                                '提交失败：' + (data.msg || '未知错误') : 
                                'Submission failed: ' + (data.msg || 'Unknown error');
                            alert(failMsg);
                            this.isSubmitting = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error submitting exam:', error);
                        const errorMsg = this.currentLang === 'zh-cn' || this.currentLang === 'zh' ? 
                            '提交出错：' + error.message : 
                            'Submission error: ' + error.message;
                        alert(errorMsg);
                        this.isSubmitting = false;
                    });
            },

            saveProgress() {
                localStorage.setItem(`quiz_${this.qid}_progress`, JSON.stringify(this.answer_data));
            },
            loadProgress() {
                const savedProgress = localStorage.getItem(`quiz_${this.qid}_progress`);
                if (savedProgress) {
                    this.answer_data = JSON.parse(savedProgress);
                }
            },
            restoreProgress() {
                this.answer_data.forEach(answer => {
                    const questionIndex = this.quesList.findIndex(q => q.id === answer.qid);
                    if (questionIndex > -1) {
                        this.quesList[questionIndex].selectdata.forEach(option => {
                            if (option.key === answer.answer) {
                                this.$set(option, 'current', 1);
                            }
                        });
                    }
                });
                this.currentIndex = this.answer_data.length;
            },
            restartTest() {
                this.answer_data = [];
                this.currentIndex = 0;
                this.isSubmit = false;
                this.isProcessing = false;
                if (this.quesList && Array.isArray(this.quesList)) {
                    this.quesList.forEach(question => {
                        if (question.selectdata && Array.isArray(question.selectdata)) {
                            question.selectdata.forEach(option => {
                                this.$set(option, 'current', '');
                            });
                        }
                    });
                }
                localStorage.removeItem(`quiz_${this.qid}_progress`);
                history.pushState(null, '', window.location.pathname);
                this.isShow = false;
            }
        },
        beforeDestroy() {
            window.removeEventListener('popstate', this.handlePopState);
        }
    });
</script>
