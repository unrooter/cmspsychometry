{layout name="common/layout" /}

<!-- SEO结构化数据 - MBTI Quiz类型 -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Quiz",
  "name": "{$__ARCHIVES__.title|htmlentities}",
  "description": "{$__ARCHIVES__.sub_title ?: 'MBTI性格测试'}",
  "url": "{$Think.request.url}",
  "image": "{$__ARCHIVES__.image|cdnurl}",
  "author": {
    "@type": "Organization",
    "name": "{cms:config name='cms.sitename'/}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "{cms:config name='cms.sitename'/}",
    "logo": {
      "@type": "ImageObject",
      "url": "{$Think.config.cms.sitelogo|cdnurl}"
    }
  },
  "datePublished": "{$__ARCHIVES__.publishtime|date='c',###}",
  "dateModified": "{$__ARCHIVES__.updatetime|date='c',###}",
  "genre": "MBTI Personality Test"
}
</script>

<style data-render="style">
 .oh-mbti-head{display:flex;flex-direction:column;gap:16px}
 @media (min-width: 768px){.oh-mbti-head{flex-direction:row;align-items:flex-start;justify-content:space-between}}
 .oh-mbti-cta{display:inline-flex;align-items:center;justify-content:center;border-radius:12px;border:1px solid #facc15;background:#facc15;padding:12px 18px;font-size:13px;font-weight:900;letter-spacing:0.14em;color:#111;box-shadow:0 12px 28px rgba(250,204,21,0.28), 0 10px 26px rgba(0,0,0,0.10);user-select:none;white-space:nowrap}
 .oh-mbti-cta:hover{background:#fbbf24;border-color:#fbbf24}
 @media (max-width: 767px){.oh-mbti-cta{width:100%}}
 .oh-test-shell{background:rgba(0,0,0,0.035);padding:14px;border-radius:16px}
 @media (min-width: 768px){.oh-test-shell{padding:22px}}
 .oh-test-card{background:#fff;box-shadow:0 18px 45px rgba(0,0,0,0.06);border-radius:16px}
 .oh-test-top{display:flex;flex-direction:column;align-items:stretch;justify-content:space-between;gap:12px}
 @media (min-width: 640px){.oh-test-top{flex-direction:row;align-items:center}}
 .oh-test-hint{font-size:12px;line-height:1.5;color:rgba(0,0,0,0.55);margin-top:4px}
 .oh-mbti-mask{position:fixed;inset:0;z-index:9999;background:rgba(255,255,255,0.88);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;padding:24px}
 .oh-mbti-mask-card{width:min(380px, 100%);background:#111;color:#fff;border-radius:16px;padding:18px 18px 16px;text-align:center;box-shadow:0 22px 60px rgba(0,0,0,0.22)}
 .oh-mbti-spin{display:inline-block;width:22px;height:22px;border-radius:999px;border:2px solid rgba(255,255,255,0.35);border-top-color:#facc15;animation:oh-mbti-spin 0.8s linear infinite}
 @keyframes oh-mbti-spin{to{transform:rotate(360deg)}}
</style>


<div class="mx-auto max-w-7xl px-4 py-10 sm:px-6 lg:px-8" id="content-container">
    <nav aria-label="breadcrumb" class="mb-6">
        <ol class="flex flex-wrap items-center gap-x-1.5 gap-y-1 text-xs text-gray-500" itemscope itemtype="https://schema.org/BreadcrumbList">
            {php}$breadPos = 0;{/php}
            {cms:breadcrumb id="item"}
            {php}$breadPos++;{/php}
            <li class="inline-flex items-center" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                {if $breadPos>1}<span class="mx-1 text-gray-300">›</span>{/if}
                <a class="no-underline hover:text-black" href="{$item.url}" itemprop="item">
                    <span itemprop="name">{:__($item.name)}</span>
                </a>
                <meta itemprop="position" content="{$breadPos}" />
            </li>
            {/cms:breadcrumb}
        </ol>
    </nav>

    <header class="ui-card">
        <div class="ui-card-body">
        <div class="oh-mbti-head">
            <div class="min-w-0">
                <h1 class="text-xl font-semibold tracking-tight text-gray-900" itemprop="headline">{cms:archives name="title|htmlentities" /}</h1>
                {if $__ARCHIVES__.sub_title}
                <p class="mt-2 text-sm leading-7 text-gray-600" itemprop="description">{$__ARCHIVES__.sub_title|htmlentities}</p>
                {/if}
                <div class="mt-3 flex flex-wrap items-center gap-x-6 gap-y-2 text-sm text-gray-600">
                    <span class="inline-flex items-center gap-2">
                        <i class="fa fa-eye text-black/60" aria-hidden="true"></i>
                        <span>{cms:archives name="views" /} {:__('阅读')}</span>
                    </span>
                    <span class="inline-flex items-center gap-2">
                        <i class="fa fa-calendar text-black/60" aria-hidden="true"></i>
                        <span>{$__ARCHIVES__.publishtime|date="Y-m-d",###}</span>
                    </span>
                    <span class="inline-flex items-center gap-2">
                        <i class="fa fa-folder-o text-black/60" aria-hidden="true"></i>
                        <span>{$__CHANNEL__.name}</span>
                    </span>
                </div>
            </div>
            <div class="shrink-0">
                <button type="button" class="oh-mbti-cta" onclick="if (window.__MBTI_APP__ && window.__MBTI_APP__.toTest) { window.__MBTI_APP__.toTest(); } else { window.location.search='?question=1'; }">
                    <i class="fa fa-play-circle mr-2" aria-hidden="true"></i> {:__('立即测试')}
                </button>
            </div>
        </div>
        </div>
    </header>

    <div id="app" v-cloak class="hidden">
        <div v-if="isSubmitting" class="oh-mbti-mask" role="status" aria-live="polite" aria-label="{:__('报告生成中')}">
            <div class="oh-mbti-mask-card">
                <div class="flex items-center justify-center gap-3" style="gap:12px;">
                    <span class="oh-mbti-spin" aria-hidden="true"></span>
                    <div class="text-base font-semibold">{:__('报告生成中')}</div>
                </div>
                <div class="mt-2 text-sm" style="color:rgba(255,255,255,0.78);">{:__('正在分析你的答案，请稍候…')}</div>
            </div>
        </div>
        <div class="mt-6 grid gap-6 lg:grid-cols-12">
            <main class="lg:col-span-8">
                <section class="ui-card" id="ceshi">
                    <div class="ui-card-body">
                        <div id="introSection" class="space-y-4" :class="isShow ? 'hidden' : ''">
                            <div class="text-sm leading-7 text-gray-700">
                                {cms:archives name="content" /}
                            </div>
                            {if isset($check_data) && $check_data['code']==0}
                            <div class="rounded-md border border-amber-200 bg-amber-50 p-4 text-center text-sm font-medium text-amber-800">
                                <i class="fa fa-info-circle mr-2" aria-hidden="true"></i> {:__("今日已经做过该测试了，请明天再重试哦")}
                            </div>
                            {else}
                            <div class="py-6 text-center">
                                <button type="button" class="inline-flex items-center rounded-md bg-black px-10 py-4 text-base font-semibold text-white shadow hover:bg-black/90" @click="toTest">
                                    <i class="fa fa-play-circle mr-2" aria-hidden="true"></i> {:__('立即测试')}
                                </button>
                            </div>
                            {/if}
                        </div>

                        <div id="testSection" class="mt-6" :class="isShow ? '' : 'hidden'">
                            <div class="oh-test-shell">
                                <div class="oh-test-card p-4 md:p-6">
                                    <div class="oh-test-top">
                                        <div>
                                            <div class="text-xs font-semibold tracking-[0.18em] text-gray-900">
                                                <i class="fa fa-pencil-square-o mr-2 text-black/60" aria-hidden="true"></i>{:__('开始答题')}
                                            </div>
                                            <div class="oh-test-hint">{:__('请选择最符合你的选项，系统会自动进入下一题')}</div>
                                        </div>
                                        <button type="button" class="inline-flex items-center justify-center rounded-none border border-black/10 bg-white px-4 py-2 text-xs font-semibold tracking-[0.12em] text-gray-800/90 hover:bg-gray-50" @click="restartTest">
                                            <i class="fa fa-refresh mr-2" aria-hidden="true"></i>{:__('重新开始')}
                                        </button>
                                    </div>

                                    <div class="mt-5 rounded-none bg-black/5 p-4">
                                        <div class="h-2 overflow-hidden rounded-full bg-white">
                                            <div class="h-full bg-black transition-all duration-500" :style="{width: progressPercentage + '%'}"></div>
                                        </div>
                                        <div class="mt-2 text-center text-sm font-semibold text-gray-700">
                                            <i class="fa fa-check-circle mr-2 text-black/60" aria-hidden="true"></i>
                                            {:__("已完成")} {{answer_data.length}} / {{quesInfo.count}} {:__("题")} ({{progressPercentage}}%)
                                        </div>
                                    </div>

                                    <div class="mt-6 text-center">
                                <div v-for="(question, index) in quesList" :key="index" :class="currentIndex === index ? 'block' : 'hidden'">
                                    <div class="rounded-none bg-white p-5 shadow-sm">
                                        <div class="text-sm font-medium text-gray-600">
                                            <i class="fa fa-question-circle mr-2" aria-hidden="true"></i>{:__("第")}{{index+1}}{:__("题")}
                                        </div>
                                        <h2 class="mt-2 text-lg font-semibold leading-7 text-gray-900">{{ question.question }}</h2>
                                    </div>

                                    <div class="w-full">
                                        <div v-for="option in question.selectdata" class="mt-4 flex" @click="currentChange(option, index)">
                                            <div class="relative w-full rounded-none border p-4 text-left text-base font-semibold transition"
                                                 :class="[
                                                     option.current == 1 ? 'border-black bg-black/5 text-gray-900' : 'border-black/10 bg-white text-gray-900 hover:bg-black/5',
                                                     isProcessing ? 'opacity-60 pointer-events-none' : ''
                                                 ]">
                                                {{option.value}}
                                                <span v-if="option.current == 1" class="absolute right-4 top-1/2 -translate-y-1/2 text-black">✔</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-6 flex items-center justify-between gap-3">
                                        <button type="button" class="inline-flex items-center rounded-none bg-white px-4 py-2 text-sm font-semibold text-gray-800/90 shadow-sm hover:bg-black/5" @click="toReturn">{:__("上一题")}</button>
                                        <div class="text-sm text-gray-700">
                                            {:__("第")} <span class="text-lg font-bold text-gray-900">{{index+1}}</span> / {{quesInfo.count}} {:__("题")}
                                        </div>
                                    </div>
                                </div>

                                <button type="button" class="mt-8 w-full rounded-none bg-black py-4 text-center text-base font-bold tracking-wide text-white shadow hover:bg-black/90"
                                        v-show="isSubmit" @click="getExamResult()" :class="isSubmitting ? 'opacity-60 pointer-events-none' : ''">
                                    <span v-if="!isSubmitting"><i class="fa fa-check-circle mr-2" aria-hidden="true"></i>{:__("已完成做题，确认提交")}</span>
                                    <span v-else><i class="fa fa-spinner fa-spin mr-2" aria-hidden="true"></i>{:__("正在提交中...")}</span>
                                </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 space-y-6">
                            {include file="common/payment" /}
                            {include file="common/donate" /}
                            {include file="common/metainfo" /}
                        </div>
                    </div>
                </section>

                {if $config.iscomment && config('fastadmin.usercenter')}
                <section class="ui-card mt-6" id="comments">
                    <div class="border-b border-gray-100 px-4 py-3">
                        <h2 class="text-base font-semibold text-gray-900">{:__('Comment list')}
                            <small class="ml-2 text-sm font-normal text-gray-600">{:__("共有")} <span class="font-semibold text-black">{cms:archives name="comments" /}</span> {:__("条评论")}</small>
                        </h2>
                    </div>
                    <div class="p-4">
                        {if $__ARCHIVES__.iscomment}
                        {include file="common/comment" type="archives" aid="__ARCHIVES__.id"}
                        {else/}
                        <div class="text-center text-sm text-gray-500">{:__("评论功能已关闭")}</div>
                        {/if}
                    </div>
                </section>
                {/if}
            </main>

            <aside class="space-y-6 lg:col-span-4">
                <section class="ui-card" aria-label="{:__('相关推荐')}" style="border:1px solid rgba(0,0,0,0.08);">
                    <div class="ui-card-body" style="padding:14px 14px 12px;">
                        <div class="pb-2 text-xs font-semibold tracking-[0.18em] text-gray-900"><i class="fa fa-lightbulb-o mr-2 text-black/60" aria-hidden="true"></i>{:__('相关推荐')}</div>
                        <div class="space-y-2">
                        {cms:arclist id="related" channel="$__CHANNEL__.id" limit="6" orderby="views" orderway="DESC"}
                        {if $related.id != $__ARCHIVES__.id}
                        <a href="{$related.url}" class="group flex gap-3 rounded-none bg-transparent transition hover:bg-black/5 no-underline" style="padding:10px 12px;">
                            <div class="relative h-16 w-16 shrink-0 overflow-hidden rounded-none bg-black/5">
                                <img src="{$related.image ?: '/assets/addons/cms/img/default.png'}" alt="{$related.title|htmlentities} - {:__('MBTI测试')}" loading="lazy" class="h-full w-full object-cover transition duration-300 group-hover:scale-105" onerror="this.onerror=null;this.src='/assets/addons/cms/img/default.png'">
                                {if isset($related.tags[0])}
                                <span class="absolute bottom-1 left-1 right-1 bg-black/80 px-1.5 py-0.5 text-center text-[10px] font-semibold text-white">{$related.tags.0.title|htmlentities}</span>
                                {/if}
                            </div>
                            <div class="min-w-0 flex-1">
                                <div class="text-sm font-semibold leading-6 text-gray-900 truncate">{$related.title|htmlentities|mb_substr=0,30}</div>
                                <div class="mt-0.5 text-xs text-gray-500"><i class="fa fa-eye mr-1 text-black/60" aria-hidden="true"></i>{$related.views|default=0}</div>
                            </div>
                        </a>
                        {/if}
                        {/cms:arclist}
                        </div>
                    </div>
                </section>

                {include file="common/authorinfo" /}
                {include file="common/sidebar" /}
            </aside>
        </div>
    </div>
</div>

<script data-render="script">
        var galleryThumbs = new Swiper('.gallery-thumbs', {
            spaceBetween: 10,
            slidesPerView: 5,
            freeMode: true,
            watchSlidesVisibility: true,
            watchSlidesProgress: true,
        });
        var galleryTop = new Swiper('.gallery-top', {
            spaceBetween: 10,
            navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev',
            },
            thumbs: {
                swiper: galleryThumbs
            }
        });
        //点击放大
        $(document).on("click", ".article-image .gallery-top .swiper-slide", function () {
            var data = [];
            $.each($(this).parent().children(), function (i, j) {
                data.push({
                    "src": $(this).data("src")
                });
            });
            var json = {
                "title": "",
                "start": $(this).index(),
                "data": data
            };
            layer.photos(JSON.parse(JSON.stringify({photos: json})));
        });
</script>

<script type="text/javascript" src="__ADDON__/js/vue.js"></script>
<script>
    var token = "{$token}";
    
    // 忽略 Office 标签（从 Word 复制粘贴产生的标签）
    Vue.config.ignoredElements = ['o:p'];
    
    // 根据测试类型获取对应的结果页面
    function getResultPage(testType) {
        const resultPages = {
            'mbti': '/p/results_mbti.html',
            'score': '/p/results_score.html', 
            'dimension': '/p/results_dimension.html',
            'custom': '/p/results_custom.html',
            'nine_type': '/p/results_nine_type.html',
            'multiple_type': '/p/results_multiple.html'
        };
        return resultPages[testType] || '/p/ceshiye.html';
    }
    
    new Vue({
        el: '#app',
        data: {
            qid: '',
            isShow: false,
            quesList: [],
            currentIndex: 0,
            quesInfo: '',
            answer_data: [],
            isSubmit: false,
            isSubmitting: false,
            isMobile: false,
            authCode: 0,
            currentLang: 'zh',
            isProcessing: false
        },
        computed: {
            // 计算进度百分比
            progressPercentage() {
                if (!this.quesInfo || !this.quesInfo.count) return 0;
                return Math.round((this.answer_data.length / this.quesInfo.count) * 100);
            }
        },
        mounted() {
            this.$el.classList.remove('hidden');
            window.__MBTI_APP__ = this;
            this.isMobile = window.innerWidth <= 992;
            window.addEventListener('resize', () => {
                this.isMobile = window.innerWidth <= 992;
            });
            var url = window.location.href;
            const parsedUrl = new URL(url);
            const pathnameParts = parsedUrl.pathname.split("/");
            const filename = pathnameParts[pathnameParts.length - 1];
            this.qid = filename.split(".")[0];

            this.loadProgress();
            this.getQuestions();

            if (parsedUrl.searchParams.has('question')) {
                const questionIndex = parseInt(parsedUrl.searchParams.get('question')) - 1;
                if (questionIndex >= 0) {
                    this.currentIndex = questionIndex;
                    this.isShow = true;
                } else {
                    this.isShow = false;
                }
            } else {
                this.isShow = false;
            }

            if (this.isShow) {
                this.$nextTick(() => {
                    const testSection = document.getElementById('testSection');
                    if (testSection) {
                        testSection.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                        setTimeout(() => {
                            window.scrollBy({
                                top: -80,
                                behavior: 'smooth'
                            });
                        }, 300);
                    }
                });
            }
            
            setTimeout(() => {
                if (this.quesList.length === 0) {
                    this.isShow = false;
                }
            }, 100);
            window.addEventListener('popstate', this.handlePopState);
        },
        methods: {
            getCurrentLanguage() {
                const urlParams = new URLSearchParams(window.location.search);
                const urlLang = urlParams.get('lg');
                if (urlLang) {
                    this.currentLang = urlLang;
                    return urlLang;
                }
                
                const cookieLang = this.getCookie('frontend_language');
                if (cookieLang) {
                    this.currentLang = cookieLang;
                    return cookieLang;
                }
                
                this.currentLang = 'zh';
                return 'zh-cn';
            },
            
            getCookie(name) {
                const value = "; " + document.cookie;
                const parts = value.split("; " + name + "=");
                if (parts.length === 2) return parts.pop().split(";").shift();
            },
            
            handlePopState() {
                var url = window.location.href;
                const parsedUrl = new URL(url);
                if (parsedUrl.searchParams.has('question')) {
                    const questionIndex = parseInt(parsedUrl.searchParams.get('question')) - 1;
                    if (questionIndex >= 0) {
                        this.currentIndex = questionIndex;
                        this.isShow = true;
                    } else {
                        this.isShow = false;
                    }
                } else {
                    this.isShow = false;
                }
            },
            toTest() {
                this.restartTest()
                this.isShow = true;
                history.pushState(null, '', `${window.location.pathname}?question=${this.currentIndex + 1}`);
                
                // 页面滚动到做题区域
                this.$nextTick(() => {
                    const testSection = document.getElementById('testSection');
                    if (testSection) {
                        testSection.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                        // 额外向上偏移一点，避免被导航栏遮挡
                        setTimeout(() => {
                            window.scrollBy({ 
                                top: -80, 
                                behavior: 'smooth' 
                            });
                        }, 300);
                    }
                });
            },
            currentChange(option, questionIndex) {
                // 防止连续快速点击
                if (this.isProcessing) {
                    return;
                }
                
                this.isProcessing = true;
                
                let answerList = {
                    qid: this.quesList[questionIndex].id,
                    answer: option.key,
                };

                this.quesList[questionIndex].selectdata.forEach(opt => {
                    this.$set(opt, 'current', opt.key === option.key ? 1 : '');
                });

                let index = this.answer_data.findIndex(answer => answer.qid == answerList.qid);
                if (index > -1) {
                    this.$set(this.answer_data, index, answerList);
                } else {
                    this.answer_data.push(answerList);
                }

                this.saveProgress();

                if (this.currentIndex < this.quesList.length - 1) {
                    setTimeout(() => {
                        this.currentIndex++;
                        history.pushState(null, '', `${window.location.pathname}?question=${this.currentIndex + 1}`);
                        // 在切换完成后才允许下一次点击
                        this.isProcessing = false;
                    }, 300);
                } else {
                    this.isSubmit = true;
                    this.isProcessing = false;
                }
            },
            toReturn() {
                if (this.isProcessing) {
                    return;
                }
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    history.pushState(null, '', `${window.location.pathname}?question=${this.currentIndex + 1}`);
                }
            },
            getQuestions() {
                const params = new URLSearchParams();
                params.append('aid', this.qid);
                const currentLang = this.getCurrentLanguage();
                if (currentLang) {
                    params.append('lang', currentLang);
                }
                fetch('/addons/cms/psychometry/getQuestions?', {
                    method: 'POST',
                    body: params,
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.data.exam_info && data.data.exam_info.back_type == 3) {
                            const options = data.data.question_data;
                            
                            const questionText = this.currentLang === 'zh-cn' || this.currentLang === 'zh' ? 
                                (data.data.exam_info.test_type === 'custom' ? '请选择您的答案：' : '测试题目') :
                                (data.data.exam_info.test_type === 'custom' ? 'Please select your answer:' : 'Test Question');
                            
                            this.quesList = [{
                                id: 1,
                                question: questionText,
                                selectdata: options.map(option => ({
                                    key: option.mark,
                                    value: option.title
                                }))
                            }];
                        } else {
                            this.quesList = data.data.question_data;
                        }
                        
                        this.quesInfo = data.data;
                        this.productInfo = data.data.exam_info;
                        this.restoreProgress();
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                    });
            },
            getExamResult() {
                if (this.isSubmitting) return;
                
                this.isSubmitting = true;
                
                const params = new URLSearchParams();
                params.append('aid', this.qid);
                params.append('answer_data', JSON.stringify(this.answer_data));

                fetch('/addons/cms/psychometry/getExamResult?', {
                    method: 'POST',
                    body: params,
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('提交返回的数据：', data);
                        
                        if (data.code == 1) {
                            if (!data.data || !data.data.answer_id) {
                                console.error('返回数据不完整：', data);
                                const alertMsg = this.currentLang === 'zh-cn' || this.currentLang === 'zh' ? 
                                    '提交成功，但返回数据不完整' : 'Submitted successfully, but data incomplete';
                                alert(alertMsg);
                                this.isSubmitting = false;
                                return;
                            }
                            
                            localStorage.removeItem(`quiz_${this.qid}_progress`);
                            this.answer_data = [];
                            this.currentIndex = 0;
                            this.isSubmit = false;
                            this.isShow = false;

                            const testType = data.data.test_type || 'mbti';
                            const resultPage = getResultPage(testType);
                            const baseUrl = window.location.protocol + '//' + window.location.host;
                            const resultUrl = baseUrl + resultPage + '?answer_id=' + data.data.answer_id;
                            
                            console.log('跳转到结果页：', resultUrl);
                            try {
                                sessionStorage.setItem('cms_result_generating', '1');
                                sessionStorage.setItem('cms_result_generating_at', String(Date.now()));
                            } catch (e) {}
                            window.location.href = resultUrl;

                            history.replaceState(null, '', window.location.pathname);
                        } else {
                            console.error('提交失败：', data.msg);
                            const failMsg = this.currentLang === 'zh-cn' || this.currentLang === 'zh' ? 
                                '提交失败：' + (data.msg || '未知错误') : 
                                'Submission failed: ' + (data.msg || 'Unknown error');
                            alert(failMsg);
                            this.isSubmitting = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error submitting exam:', error);
                        const errorMsg = this.currentLang === 'zh-cn' || this.currentLang === 'zh' ? 
                            '提交出错：' + error.message : 
                            'Submission error: ' + error.message;
                        alert(errorMsg);
                        this.isSubmitting = false;
                    });
            },

            saveProgress() {
                localStorage.setItem(`quiz_${this.qid}_progress`, JSON.stringify(this.answer_data));
            },
            loadProgress() {
                const savedProgress = localStorage.getItem(`quiz_${this.qid}_progress`);
                if (savedProgress) {
                    this.answer_data = JSON.parse(savedProgress);
                }
            },
            restoreProgress() {
                this.answer_data.forEach(answer => {
                    const questionIndex = this.quesList.findIndex(q => q.id === answer.qid);
                    if (questionIndex > -1) {
                        this.quesList[questionIndex].selectdata.forEach(option => {
                            if (option.key === answer.answer) {
                                this.$set(option, 'current', 1);
                            }
                        });
                    }
                });
                this.currentIndex = this.answer_data.length;
            },
            restartTest() {
                this.answer_data = [];
                this.currentIndex = 0;
                this.isSubmit = false;
                this.isProcessing = false;
                if (this.quesList && Array.isArray(this.quesList)) {
                    this.quesList.forEach(question => {
                        if (question.selectdata && Array.isArray(question.selectdata)) {
                            question.selectdata.forEach(option => {
                                this.$set(option, 'current', '');
                            });
                        }
                    });
                }
                localStorage.removeItem(`quiz_${this.qid}_progress`);
                history.pushState(null, '', window.location.pathname);
                this.isShow = false;
            }
        },
        beforeDestroy() {
            window.removeEventListener('popstate', this.handlePopState);
        }
    });
</script>
