{layout name="common/layout" /}
<article class="min-h-screen bg-gray-50 py-6" itemscope itemtype="https://schema.org/Article">
    <!-- 谷歌广告位 - 顶部横幅（展示广告）-->
    <div class="mx-auto my-6 max-w-3xl px-4 text-center sm:px-6 lg:px-8">
        <ins class="adsbygoogle block"
             data-ad-client="ca-pub-9195262048954682"
             data-ad-slot="2969657271"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <div class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8">
        <div class="rounded-2xl bg-white p-6 shadow-sm ring-1 ring-gray-200 sm:p-8">
            <!-- 测试标题 -->
            <header class="border-b border-gray-100 pb-6 text-center">
                <h1 id="test-title" class="text-2xl font-bold text-gray-900 sm:text-3xl" itemprop="headline">九型人格测试结果</h1>
                <p id="test-subtitle" class="mt-2 text-sm text-gray-600 sm:text-base" itemprop="description">测试结果仅供参考，具体请咨询专业指导</p>
                <meta itemprop="author" content="心理测试平台">
                <meta itemprop="datePublished" content="">
                <meta itemprop="dateModified" content="">
            </header>

            <!-- 测试信息 - 折叠式 -->
            <section class="mt-6 overflow-hidden rounded-2xl border border-gray-200 bg-gray-50" id="test-info">
                <button type="button" class="flex w-full items-center justify-between gap-3 px-5 py-4 text-left" onclick="toggleTestInfo()">
                    <h2 class="text-base font-semibold text-gray-900">测试信息</h2>
                    <span class="text-sm font-semibold text-gray-500" id="test-info-icon">▼</span>
                </button>
                <div class="hidden px-5 pb-5" id="info-content">
                    <!-- 测试信息将在这里显示 -->
                </div>
            </section>

            <!-- 主要性格类型显示 -->
            <section class="mt-6">
                <div class="rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 p-6 text-white shadow-sm sm:flex sm:items-center sm:gap-6">
                    <div class="mx-auto flex h-28 w-28 flex-col items-center justify-center rounded-full bg-white/20 ring-2 ring-white/20 sm:mx-0">
                        <div class="text-3xl font-bold" id="main-type">分析中...</div>
                        <div class="mt-1 text-sm font-semibold opacity-90">主要性格</div>
                    </div>
                    <div class="mt-4 text-center sm:mt-0 sm:text-left">
                        <div class="text-base font-semibold sm:text-lg" id="type-description">正在分析您的性格类型...</div>
                        <div class="mt-2 text-sm opacity-90" id="type-percentage">计算中...</div>
                    </div>
                </div>
            </section>

            <!-- 各类型分数显示 -->
            <section class="mt-8" id="dimension-scores-section" itemscope itemtype="https://schema.org/ItemList">
                <h2 class="text-center text-lg font-semibold text-gray-900 sm:text-2xl" itemprop="name">九型人格各类型得分详情</h2>
                <div class="mt-5 grid gap-4 sm:grid-cols-2 lg:grid-cols-3" id="dimension-grid" itemprop="itemListElement">
                    <!-- 类型分数将在这里显示 -->
                </div>
            </section>

            <!-- 结果分析 -->
            <section class="mt-8" id="analysis-section" itemscope itemtype="https://schema.org/Article">
                <h2 class="text-center text-lg font-semibold text-gray-900 sm:text-2xl" itemprop="headline">详细分析报告</h2>
                <div class="prose prose-sm mt-5 max-w-none rounded-2xl border border-gray-200 bg-white p-5 text-gray-700 shadow-sm" id="analysis-content" itemprop="articleBody">
                    <!-- 分析内容将在这里显示 -->
                </div>
            </section>

            <!-- 建议和指导 -->
            <section class="mt-8" id="suggestions-section">
                <h2 class="text-center text-lg font-semibold text-gray-900 sm:text-2xl">建议和指导</h2>
                <div class="prose prose-sm mt-5 max-w-none rounded-2xl border border-gray-200 bg-white p-5 text-gray-700 shadow-sm" id="suggestions-content">
                    <!-- 建议内容将在这里显示 -->
                </div>
            </section>
        </div>
    </div>

    <!-- 谷歌广告位 - 中间内容（文章内嵌广告）-->
    <div class="mx-auto my-10 max-w-3xl px-4 text-center sm:px-6 lg:px-8">
        <ins class="adsbygoogle block"
             data-ad-layout="in-article"
             data-ad-format="fluid"
             data-ad-client="ca-pub-9195262048954682"
             data-ad-slot="5294962935"></ins>
        <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>
</article>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 获取URL参数
    const urlParams = new URLSearchParams(window.location.search);
    const answer_id = urlParams.get('answer_id');
    
    if (!answer_id) {
        document.getElementById('type-description').textContent = '未找到测试结果';
        return;
    }
    
    // 获取测试结果
    fetch('/addons/cms/psychometry/answerInfo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'answer_id=' + answer_id
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 1) {
            displayNineTypeResult(data.data);
        } else {
            document.getElementById('type-description').textContent = '获取结果失败：' + data.msg;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('type-description').textContent = '网络错误，请稍后重试';
    });
});

function displayNineTypeResult(data) {
    // 更新页面标题和SEO信息
    if (data.a_info) {
        const title = data.a_info.title || '九型人格测试结果';
        const subtitle = data.a_info.sub_title || '测试结果仅供参考，具体请咨询专业指导';
        
        document.getElementById('test-title').textContent = title;
        document.getElementById('test-subtitle').textContent = subtitle;
        
        // 更新页面标题
        document.title = title + ' - 测试结果';
        
        // 更新meta描述
        const metaDescription = document.querySelector('meta[name="description"]');
        if (metaDescription) {
            metaDescription.setAttribute('content', subtitle);
        }
        
        // 更新结构化数据
        const headlineMeta = document.querySelector('meta[itemprop="headline"]');
        const descriptionMeta = document.querySelector('meta[itemprop="description"]');
        const datePublishedMeta = document.querySelector('meta[itemprop="datePublished"]');
        
        if (headlineMeta) headlineMeta.setAttribute('content', title);
        if (descriptionMeta) descriptionMeta.setAttribute('content', subtitle);
        if (datePublishedMeta) datePublishedMeta.setAttribute('content', new Date().toISOString());
    }
    
    // 显示测试信息
    displayTestInfo(data);
    
    // 显示主要性格类型
    displayMainType(data);
    
    // 显示各类型分数
    displayTypeScores(data);
    
    // 显示分析内容
    displayAnalysis(data);
    
    // 显示建议内容
    displaySuggestions(data);
}

function displayTestInfo(data) {
    const infoContent = document.getElementById('info-content');
    
    let html = '';
    if (data.a_info) {
        html += '<div class="divide-y divide-gray-200 overflow-hidden rounded-xl border border-gray-200 bg-white">';
        html += '<div class="flex items-center justify-between gap-4 px-4 py-3 text-sm"><span class="font-semibold text-gray-700">测试名称</span><span class="text-gray-600">' + (data.a_info.title || '未知测试') + '</span></div>';
        html += '<div class="flex items-center justify-between gap-4 px-4 py-3 text-sm"><span class="font-semibold text-gray-700">测试说明</span><span class="text-gray-600">' + (data.a_info.sub_title || '暂无说明') + '</span></div>';
        html += '<div class="flex items-center justify-between gap-4 px-4 py-3 text-sm"><span class="font-semibold text-gray-700">题目数量</span><span class="text-gray-600">' + (data.test_info.question_count || 0) + '题</span></div>';
        html += '<div class="flex items-center justify-between gap-4 px-4 py-3 text-sm"><span class="font-semibold text-gray-700">满分</span><span class="text-gray-600">' + (data.test_info.question_count || 0) + '分</span></div>';
        html += '</div>';
    }
    
    infoContent.innerHTML = html;
}

function displayMainType(data) {
    if (!data.stat_data) return;
    
    // 找到得分最高的类型
    let maxType = '';
    let maxScore = 0;
    let totalScore = 0;
    
    for (const [type, score] of Object.entries(data.stat_data)) {
        totalScore += score;
        if (score > maxScore) {
            maxScore = score;
            maxType = type;
        }
    }
    
    // 类型名称映射
    const typeNames = {
        '1': '完美主义者',
        '2': '助人者',
        '3': '成就者',
        '4': '艺术家',
        '5': '思想家',
        '6': '忠诚者',
        '7': '享乐主义者',
        '8': '挑战者',
        '9': '和平者'
    };
    
    const typeName = typeNames[maxType] || '未知';
    const percentage = totalScore > 0 ? Math.round((maxScore / totalScore) * 100) : 0;
    
    document.getElementById('main-type').textContent = maxType + '型';
    document.getElementById('type-description').textContent = `您的主要性格类型是${maxType}型 - ${typeName}，得分${maxScore}分`;
    document.getElementById('type-percentage').textContent = `占比${percentage}%`;
}

function displayTypeScores(data) {
    if (!data.stat_data) return;
    
    const dimensionGrid = document.getElementById('dimension-grid');
    const typeNames = {
        '1': { name: '完美主义者', border: 'border-red-500', text: 'text-red-600', bar: 'from-red-500 to-red-700' },
        '2': { name: '助人者', border: 'border-sky-500', text: 'text-sky-600', bar: 'from-sky-500 to-sky-700' },
        '3': { name: '成就者', border: 'border-amber-500', text: 'text-amber-600', bar: 'from-amber-500 to-amber-700' },
        '4': { name: '艺术家', border: 'border-purple-500', text: 'text-purple-600', bar: 'from-purple-500 to-purple-700' },
        '5': { name: '思想家', border: 'border-slate-500', text: 'text-slate-600', bar: 'from-slate-500 to-slate-700' },
        '6': { name: '忠诚者', border: 'border-teal-500', text: 'text-teal-600', bar: 'from-teal-500 to-teal-700' },
        '7': { name: '享乐主义者', border: 'border-orange-500', text: 'text-orange-600', bar: 'from-orange-500 to-orange-700' },
        '8': { name: '挑战者', border: 'border-pink-500', text: 'text-pink-600', bar: 'from-pink-500 to-pink-700' },
        '9': { name: '和平者', border: 'border-emerald-500', text: 'text-emerald-600', bar: 'from-emerald-500 to-emerald-700' }
    };
    
    // 计算总分用于百分比计算
    const scores = Object.values(data.stat_data);
    const totalScore = scores.reduce((sum, score) => sum + score, 0);
    
    // 找到最高分
    let maxScore = 0;
    for (const score of scores) {
        if (score > maxScore) {
            maxScore = score;
        }
    }
    
    let html = '';
    for (const [type, score] of Object.entries(data.stat_data)) {
        const typeInfo = typeNames[type] || { name: '未知', border: 'border-gray-300', text: 'text-gray-700', bar: 'from-gray-400 to-gray-600' };
        const percentage = totalScore > 0 ? Math.round((score / totalScore) * 100) : 0;
        const isHighest = score === maxScore;
        
        html += `
            <div class="relative rounded-2xl border ${typeInfo.border} bg-white p-5 shadow-sm" itemprop="item" itemscope itemtype="https://schema.org/ListItem">
                <meta itemprop="position" content="${type}">
                ${isHighest ? '<div class="absolute -right-2 -top-2 rounded-full bg-gradient-to-r from-rose-500 to-orange-500 px-2 py-1 text-[10px] font-semibold text-white shadow-sm">最高分</div>' : ''}
                <div class="text-sm font-semibold text-gray-900" itemprop="name">${type}型 - ${typeInfo.name}</div>
                <div class="mt-2 text-3xl font-bold ${typeInfo.text}" itemprop="value">${score}</div>
                <div class="mt-3 h-2 w-full overflow-hidden rounded-full bg-gray-200">
                    <div class="h-full rounded-full bg-gradient-to-r ${typeInfo.bar}" data-width="${percentage}" aria-label="${typeInfo.name}得分${score}分，占比${percentage}%"></div>
                </div>
                <div class="mt-2 text-xs font-medium text-gray-500">${percentage}%</div>
            </div>
        `;
    }
    
    dimensionGrid.innerHTML = html;
    dimensionGrid.querySelectorAll('[data-width]').forEach(el => {
        el.style.width = el.dataset.width + '%';
    });
}

function displayAnalysis(data) {
    const analysisContent = document.getElementById('analysis-content');
    
    if (data.analyse && data.analyse.content) {
        analysisContent.innerHTML = data.analyse.content;
    } else {
        analysisContent.innerHTML = '<p>感谢您完成九型人格测试！您的性格类型分析已完成。</p>';
    }
}

function displaySuggestions(data) {
    const suggestionsContent = document.getElementById('suggestions-content');
    
    if (data.analyse && data.analyse.suggestion) {
        suggestionsContent.innerHTML = data.analyse.suggestion;
    } else {
        suggestionsContent.innerHTML = '<p>测试结果仅供参考，如需专业指导，请咨询相关领域的专家。</p>';
    }
}

function toggleTestInfo() {
    const content = document.getElementById('info-content');
    const icon = document.getElementById('test-info-icon');
    
    if (!content || !icon) {
        console.error('无法找到测试信息元素');
        return;
    }
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.textContent = '▲';
        
        // 移动端滚动到展开的内容
        if (window.innerWidth <= 768) {
            setTimeout(() => {
                content.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
            }, 100);
        }
    } else {
        content.classList.add('hidden');
        icon.textContent = '▼';
    }
}

</script>