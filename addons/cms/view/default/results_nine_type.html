{layout name="common/layout" /}

<style data-render="style">
 .oh-result-page{background:transparent}
 .oh-result-hero{border-radius:16px;background:#111;color:#fff;padding:22px 18px 18px;text-align:center;box-shadow:0 20px 55px rgba(0,0,0,0.14)}
 @media (min-width:640px){.oh-result-hero{padding:28px 24px 22px}}
 .oh-result-badge{display:inline-flex;align-items:center;gap:8px;border-radius:999px;background:rgba(250,204,21,0.18);color:#facc15;padding:6px 12px;font-size:12px;font-weight:900;letter-spacing:0.16em}
 .oh-result-title{margin-top:12px;font-size:24px;font-weight:900;color:#fff}
 @media (min-width:640px){.oh-result-title{font-size:30px}}
 .oh-result-subtitle{margin-top:10px;font-size:13px;line-height:1.7;color:rgba(255,255,255,0.82)}
</style>

<article class="min-h-screen bg-gray-50 py-10" itemscope itemtype="https://schema.org/Article">
    <div class="oh-result-page">
    <div class="mx-auto max-w-3xl px-4 py-10 sm:px-6 lg:px-8">
        <div class="ui-card">
            <div class="ui-card-body">
            <!-- 测试标题 -->
            <header class="oh-result-hero">
                <span class="oh-result-badge"><span aria-hidden="true">✦</span><span>RESULT</span></span>
                <h1 id="test-title" class="oh-result-title" itemprop="headline">九型人格测试结果</h1>
                <p id="test-subtitle" class="oh-result-subtitle" itemprop="description">测试结果仅供参考，具体请咨询专业指导</p>
                <meta itemprop="author" content="心理测试平台">
                <meta itemprop="datePublished" content="">
                <meta itemprop="dateModified" content="">
            </header>

            <div id="result-loading" class="mt-6 ui-card">
                <div class="ui-card-body text-center">
                    <div class="mx-auto h-10 w-10 animate-spin rounded-full border-4 border-gray-200 border-t-black"></div>
                    <p class="mt-3 text-sm text-gray-600">正在生成结果...</p>
                </div>
            </div>

            <!-- 测试信息 - 折叠式 -->
            <section class="mt-6 ui-card" id="test-info">
                <div class="ui-card-header flex w-full cursor-pointer items-center justify-between gap-3 text-left" onclick="toggleTestInfo()">
                    <h2 class="text-base font-semibold text-gray-900">测试信息</h2>
                    <span class="text-sm font-semibold text-gray-500" id="test-info-icon">▲</span>
                </div>
                <div class="ui-card-body" id="info-content">
                    <!-- 测试信息将在这里显示 -->
                </div>
            </section>

            <!-- 主要性格类型显示 -->
            <section class="mt-6">
                <div class="ui-card bg-black text-white">
                    <div class="ui-card-body sm:flex sm:items-center sm:gap-6">
                    <div class="mx-auto flex h-28 w-28 flex-col items-center justify-center rounded-full bg-white/10 ring-2 ring-white/10 sm:mx-0">
                        <div class="text-3xl font-bold" id="main-type">分析中...</div>
                        <div class="mt-1 text-sm font-semibold opacity-90">主要性格</div>
                    </div>
                    <div class="mt-4 text-center sm:mt-0 sm:text-left">
                        <div class="text-base font-semibold sm:text-lg" id="type-description">正在分析您的性格类型...</div>
                        <div class="mt-2 text-sm opacity-90" id="type-percentage">计算中...</div>
                    </div>
                    </div>
                </div>
            </section>

            <!-- 各类型分数显示 -->
            <section class="mt-8" id="dimension-scores-section" itemscope itemtype="https://schema.org/ItemList">
                <h2 class="text-center text-lg font-semibold text-gray-900 sm:text-2xl" itemprop="name">九型人格各类型得分详情</h2>
                <div class="mt-5 grid gap-4 sm:grid-cols-2 lg:grid-cols-3" id="dimension-grid" itemprop="itemListElement">
                    <!-- 类型分数将在这里显示 -->
                </div>
            </section>

            <!-- 结果分析 -->
            <section class="mt-8" id="analysis-section" itemscope itemtype="https://schema.org/Article">
                <h2 class="text-center text-lg font-semibold text-gray-900 sm:text-2xl" itemprop="headline">详细分析报告</h2>
                <div class="mt-5 ui-card">
                    <div class="ui-card-body prose prose-sm max-w-none text-gray-700" id="analysis-content" itemprop="articleBody"><!-- 分析内容将在这里显示 --></div>
                </div>
            </section>

            <!-- 建议和指导 -->
            <section class="mt-8" id="suggestions-section">
                <h2 class="text-center text-lg font-semibold text-gray-900 sm:text-2xl">建议和指导</h2>
                <div class="mt-5 ui-card">
                    <div class="ui-card-body prose prose-sm max-w-none text-gray-700" id="suggestions-content"><!-- 建议内容将在这里显示 --></div>
                </div>
            </section>
            </div>
        </div>
    </div>
    </div>
</article>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function setResultLoadingVisible(visible) {
        const el = document.getElementById('result-loading');
        if (!el) return;
        try {
            const fromSubmit = sessionStorage.getItem('cms_result_generating') === '1';
            const msgEl = el.querySelector('p');
            if (msgEl) msgEl.textContent = fromSubmit ? '正在生成结果...' : '正在加载结果...';
            if (!visible && fromSubmit) {
                sessionStorage.removeItem('cms_result_generating');
                sessionStorage.removeItem('cms_result_generating_at');
            }
        } catch (e) {}
        el.style.display = visible ? '' : 'none';
    }

    // 获取URL参数
    const urlParams = new URLSearchParams(window.location.search);
    const answer_id = urlParams.get('answer_id');

    setResultLoadingVisible(true);
    
    if (!answer_id) {
        setResultLoadingVisible(false);
        document.getElementById('type-description').textContent = '未找到测试结果';
        return;
    }
    
    // 获取测试结果
    fetch('/addons/cms/psychometry/answerInfo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'answer_id=' + answer_id
    })
    .then(response => response.json())
    .then(data => {
        setResultLoadingVisible(false);
        if (data.code === 1) {
            displayNineTypeResult(data.data);
        } else {
            document.getElementById('type-description').textContent = '获取结果失败：' + data.msg;
        }
    })
    .catch(error => {
        setResultLoadingVisible(false);
        console.error('Error:', error);
        document.getElementById('type-description').textContent = '网络错误，请稍后重试';
    });
});

function displayNineTypeResult(data) {
    // 更新页面标题和SEO信息
    if (data.a_info) {
        const title = data.a_info.title || '九型人格测试结果';
        const subtitle = data.a_info.sub_title || '测试结果仅供参考，具体请咨询专业指导';
        
        document.getElementById('test-title').textContent = title;
        document.getElementById('test-subtitle').textContent = subtitle;
        
        // 更新页面标题
        document.title = title + ' - 测试结果';
        
        // 更新meta描述
        const metaDescription = document.querySelector('meta[name="description"]');
        if (metaDescription) {
            metaDescription.setAttribute('content', subtitle);
        }
        
        // 更新结构化数据
        const headlineMeta = document.querySelector('meta[itemprop="headline"]');
        const descriptionMeta = document.querySelector('meta[itemprop="description"]');
        const datePublishedMeta = document.querySelector('meta[itemprop="datePublished"]');
        
        if (headlineMeta) headlineMeta.setAttribute('content', title);
        if (descriptionMeta) descriptionMeta.setAttribute('content', subtitle);
        if (datePublishedMeta) datePublishedMeta.setAttribute('content', new Date().toISOString());
    }
    
    // 显示测试信息
    displayTestInfo(data);
    
    // 显示主要性格类型
    displayMainType(data);
    
    // 显示各类型分数
    displayTypeScores(data);
    
    // 显示分析内容
    displayAnalysis(data);
    
    // 显示建议内容
    displaySuggestions(data);
}

function displayTestInfo(data) {
    const infoContent = document.getElementById('info-content');
    
    let html = '';
    if (data.a_info) {
        const testTitle = data.a_info.title || '未知测试';
        const description = data.a_info.sub_title || data.a_info.description || '暂无说明';
        const questionCount = data.test_info?.question_count || 0;
        const theoreticalMaxScore = questionCount;

        html += '<div class="grid" style="row-gap:10px;">';
        html += '<div style="display:flex;gap:14px;align-items:flex-start;"><span class="font-semibold text-gray-700" style="flex:0 0 92px;white-space:nowrap;">测试名称</span><span class="text-gray-600" style="flex:1;min-width:0;">' + testTitle + '</span></div>';
        html += '<div style="display:flex;gap:14px;align-items:flex-start;"><span class="font-semibold text-gray-700" style="flex:0 0 92px;white-space:nowrap;">测试说明</span><span class="text-gray-600" style="flex:1;min-width:0;line-height:1.65;">' + description + '</span></div>';
        html += '<div style="display:flex;gap:14px;align-items:flex-start;"><span class="font-semibold text-gray-700" style="flex:0 0 92px;white-space:nowrap;">题目数量</span><span class="text-gray-600" style="flex:1;min-width:0;">' + questionCount + '题</span></div>';
        html += '<div style="display:flex;gap:14px;align-items:flex-start;"><span class="font-semibold text-gray-700" style="flex:0 0 92px;white-space:nowrap;">满分</span><span class="text-gray-600" style="flex:1;min-width:0;">' + theoreticalMaxScore + '分</span></div>';
        html += '</div>';
    }
    
    infoContent.innerHTML = html;
}

function displayMainType(data) {
    if (!data.stat_data) return;
    
    // 找到得分最高的类型
    let maxType = '';
    let maxScore = 0;
    let totalScore = 0;
    
    for (const [type, score] of Object.entries(data.stat_data)) {
        totalScore += score;
        if (score > maxScore) {
            maxScore = score;
            maxType = type;
        }
    }
    
    // 类型名称映射
    const typeNames = {
        '1': '完美主义者',
        '2': '助人者',
        '3': '成就者',
        '4': '艺术家',
        '5': '思想家',
        '6': '忠诚者',
        '7': '享乐主义者',
        '8': '挑战者',
        '9': '和平者'
    };
    
    const typeName = typeNames[maxType] || '未知';
    const percentage = totalScore > 0 ? Math.round((maxScore / totalScore) * 100) : 0;
    
    document.getElementById('main-type').textContent = maxType + '型';
    document.getElementById('type-description').textContent = `您的主要性格类型是${maxType}型 - ${typeName}，得分${maxScore}分`;
    document.getElementById('type-percentage').textContent = `占比${percentage}%`;
}

function displayTypeScores(data) {
    if (!data.stat_data) return;
    
    const dimensionGrid = document.getElementById('dimension-grid');
    const typeNames = {
        '1': { name: '完美主义者' },
        '2': { name: '助人者' },
        '3': { name: '成就者' },
        '4': { name: '艺术家' },
        '5': { name: '思想家' },
        '6': { name: '忠诚者' },
        '7': { name: '享乐主义者' },
        '8': { name: '挑战者' },
        '9': { name: '和平者' }
    };
    
    // 计算总分用于百分比计算
    const scores = Object.values(data.stat_data);
    const totalScore = scores.reduce((sum, score) => sum + score, 0);
    
    // 找到最高分
    let maxScore = 0;
    for (const score of scores) {
        if (score > maxScore) {
            maxScore = score;
        }
    }
    
    let html = '';
    for (const [type, score] of Object.entries(data.stat_data)) {
        const typeInfo = typeNames[type] || { name: '未知' };
        const percentage = totalScore > 0 ? Math.round((score / totalScore) * 100) : 0;
        const isHighest = score === maxScore;
        
        html += `
            <div class="relative overflow-hidden rounded-2xl border border-gray-200 bg-white p-5 shadow-sm ${isHighest ? 'ring-2 ring-yellow-300' : ''}" itemprop="item" itemscope itemtype="https://schema.org/ListItem">
                <meta itemprop="position" content="${type}">
                ${isHighest ? '<div class="absolute right-3 top-3 inline-flex items-center rounded-full bg-yellow-300 px-2.5 py-1 text-[10px] font-black tracking-[0.12em] text-black">TOP</div>' : ''}
                <div class="text-sm font-semibold text-gray-900" itemprop="name">${type}型 - ${typeInfo.name}</div>
                <div class="mt-2 text-3xl font-extrabold text-gray-900" itemprop="value">${score}</div>
                <div class="mt-3 h-2 w-full overflow-hidden rounded-full bg-gray-200">
                    <div class="h-full rounded-full bg-black" data-width="${percentage}" aria-label="${typeInfo.name}得分${score}分，占比${percentage}%"></div>
                </div>
                <div class="mt-2 text-xs font-semibold text-gray-500">${percentage}%</div>
            </div>
        `;
    }
    
    dimensionGrid.innerHTML = html;
    dimensionGrid.querySelectorAll('[data-width]').forEach(el => {
        el.style.width = el.dataset.width + '%';
    });
}

function displayAnalysis(data) {
    const analysisContent = document.getElementById('analysis-content');
    
    if (data.analyse && data.analyse.content) {
        analysisContent.innerHTML = data.analyse.content;
    } else {
        analysisContent.innerHTML = '<p>感谢您完成九型人格测试！您的性格类型分析已完成。</p>';
    }
}

function displaySuggestions(data) {
    const suggestionsContent = document.getElementById('suggestions-content');
    
    if (data.analyse && data.analyse.suggestion) {
        suggestionsContent.innerHTML = data.analyse.suggestion;
    } else {
        suggestionsContent.innerHTML = '<p>测试结果仅供参考，如需专业指导，请咨询相关领域的专家。</p>';
    }
}

function toggleTestInfo() {
    const content = document.getElementById('info-content');
    const icon = document.getElementById('test-info-icon');
    
    if (!content || !icon) {
        console.error('无法找到测试信息元素');
        return;
    }
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.textContent = '▲';
        
        // 移动端滚动到展开的内容
        if (window.innerWidth <= 768) {
            setTimeout(() => {
                content.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
            }, 100);
        }
    } else {
        content.classList.add('hidden');
        icon.textContent = '▼';
    }
}

</script>