{layout name="common/layout" /}
<style>
  .questions-page .questions-main > section.ui-card {
    border: 1px solid rgba(0,0,0,0.12);
    background: rgba(255,255,255,0.92);
    box-shadow: 0 18px 40px rgba(0,0,0,0.08);
    position: relative;
    overflow: hidden;
  }

  .questions-page .questions-main > section.ui-card::before {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    height: 2px;
    background: rgba(250, 204, 21, 0.85);
  }

  .questions-page .questions-main .ui-card-body {
    padding: 18px 18px;
  }

  @media (min-width: 1024px) {
    .questions-page .questions-main .ui-card-body {
      padding: 22px 22px;
    }
  }
</style>
 <div id="app" class="hidden">
  <div class="questions-page mx-auto max-w-7xl px-4 py-10 sm:px-6 lg:px-8" id="content-container">
    <div class="grid gap-6 lg:grid-cols-12">
      <main class="questions-main space-y-6 lg:col-span-8">
        <section class="ui-card">
          <div class="ui-card-body">
            <div class="flex items-start gap-4">
              <div class="w-24 shrink-0">
                <div class="aspect-[1/1] overflow-hidden rounded-lg bg-gray-100">
                  <img :src="examInfo.image" alt="" loading="lazy" class="h-full w-full object-cover">
                </div>
              </div>
              <div class="min-w-0 flex-1">
                <h2 class="text-lg font-bold text-gray-900">{{examInfo.title}}</h2>
                <div class="mt-2 text-sm leading-6 text-gray-600">{{examInfo.intro}}</div>
                <div class="mt-3" v-if="isGet">
                  <button type="button" class="inline-flex items-center rounded-md bg-black px-4 py-2 text-sm font-semibold text-white hover:bg-black/90" @click="toBack">重新测试</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="ui-card" v-if="isGet">
          <div class="ui-card-header">
            <h3 class="text-xs font-semibold tracking-[0.18em] text-gray-900">测试结果</h3>
          </div>
          <div class="ui-card-body">
            <div>
              <div>
                <div v-if="examInfo.channel_id == 25">
                <div class="text-center">
                   <h3 class="ml-2 text-xl font-bold text-black">{{resultInfo.intro}}</h3>
                    <div class="mt-2 text-sm text-gray-600">您的选择:</div>
                    <div class="ml-2 text-xl font-bold text-gray-900" v-if="resultInfo.title">{{resultInfo.title}}</div>
                    <div class="mt-4">
                      <img :src="resultInfo.full_cover" alt="" class="mx-auto w-2/5 max-w-full">
                    </div>
                    </div>
                  </div>
                  <div class="mt-4" v-html="resultInfo.content"></div>
                </div>

                <div class="text-center" v-if="examInfo.channel_id !== 25">
                  <!-- 测试结果标题 -->
                  <div class="mb-8 ui-card bg-black text-white">
                    <div class="ui-card-body">
                    <h2 class="mb-2 text-3xl font-bold drop-shadow-sm">
                      {{getTestResultTitle()}}
                    </h2>
                    <p class="text-lg opacity-90">{{getTestResultSubtitle()}}</p>
                    </div>
                  </div>

                  <!-- 维度分数展示 -->
                  <div class="mb-8" v-if="allInfo.stat_data && Object.keys(allInfo.stat_data).length > 0">
                    <h4 class="mb-5 text-lg font-semibold text-gray-900">{{getDimensionsTitle()}}</h4>
                    <div class="grid gap-4 sm:grid-cols-2">
                      <div class="min-w-0" v-for="(value, key) in allInfo.stat_data" :key="key">
                        <div class="rounded-xl border-l-4 border-black bg-gray-50 p-4">
                          <div class="mb-1 text-sm font-semibold text-gray-900">
                            {{getDimensionDisplayName(key)}} {{allInfo.test_info && allInfo.test_info.test_type === 'mbti' ? '(' + key + ')' : ''}}
                          </div>
                          <div class="text-2xl font-bold text-gray-900">
                            {{value}} 分
                          </div>
                          <div class="mt-2 h-2 overflow-hidden rounded bg-gray-200">
                            <div class="h-full bg-black transition-all duration-700" :style="{ width: getDimensionPercentage(value) + '%' }"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                    </div>
                  </div>

                  <!-- 动态测试结果内容 -->
                  <div class="mb-8 ui-card" v-if="allInfo.answer_info">
                    <div class="ui-card-body">
                    <!-- 测试结果标题 -->
                    <h4 class="mb-5 text-lg font-semibold text-gray-900">
                      {{allInfo.answer_info.title || '测试结果解析'}}
                    </h4>
                    
                    <!-- 主要结果展示 -->
                    <div v-if="allInfo.answer_info.mbti_type || allInfo.answer_info.type" class="mb-6 text-center">
                      <div class="inline-block min-w-[200px] rounded-none bg-black px-6 py-5 text-white">
                        <div class="mb-1 text-3xl font-bold">
                          {{allInfo.answer_info.mbti_type || allInfo.answer_info.type}}
                        </div>
                        <div class="text-sm opacity-90">您的测试结果</div>
                      </div>
                    </div>
                    
                    <!-- MBTI详细内容 -->
                    <div v-if="allInfo.answer_info.mbti_content">
                      <!-- 简介 -->
                      <div v-if="allInfo.answer_info.mbti_content.intro" class="mb-5 rounded-xl bg-gray-50 p-5 text-left">
                        <h5 class="mb-2 text-base font-semibold text-black">类型简介</h5>
                        <div class="text-sm leading-6 text-gray-600">{{allInfo.answer_info.mbti_content.intro}}</div>
                      </div>
                      
                      <!-- 详细内容 -->
                      <div v-if="allInfo.answer_info.mbti_content.content" class="mb-5 rounded-xl bg-gray-50 p-5 text-left">
                        <h5 class="mb-2 text-base font-semibold text-black">性格特征</h5>
                        <div class="text-sm leading-6 text-gray-600" v-html="allInfo.answer_info.mbti_content.content"></div>
                      </div>
                      
                      <!-- 分析内容 -->
                      <div v-if="allInfo.answer_info.mbti_content.analysis" class="mb-5 rounded-xl bg-gray-50 p-5 text-left">
                        <h5 class="mb-2 text-base font-semibold text-black">深度分析</h5>
                        <div class="text-sm leading-6 text-gray-600" v-html="allInfo.answer_info.mbti_content.analysis"></div>
                      </div>
                      
                      <!-- 建议 -->
                      <div v-if="allInfo.answer_info.mbti_content.suggestion" class="rounded-xl border-l-4 border-black bg-gray-50 p-5 text-left">
                        <h5 class="mb-2 text-base font-semibold text-black">发展建议</h5>
                        <div class="text-sm leading-6 text-gray-600" v-html="allInfo.answer_info.mbti_content.suggestion"></div>
                      </div>
                      
                      <!-- 封面图片 -->
                      <div v-if="allInfo.answer_info.mbti_content.cover" class="mt-5 text-center">
                        <img :src="allInfo.answer_info.mbti_content.cover" class="mx-auto max-h-72 w-full max-w-full rounded-xl object-contain shadow">
                      </div>
                    </div>
                    
                    <!-- 自定义测试的选择分析 -->
                    <div v-if="allInfo.answer_info.selected_options && allInfo.answer_info.selected_options.length > 0" class="mt-5 rounded-xl bg-gray-50 p-5 text-left">
                      <h5 class="mb-4 text-base font-semibold text-gray-900">您的选择分析</h5>
                      <div v-for="(option, index) in allInfo.answer_info.selected_options" :key="index" class="mb-5 border-b border-gray-200 pb-4 last:mb-0 last:border-b-0 last:pb-0">
                        <div class="mb-2 flex items-center">
                          <div class="mr-4 flex h-8 w-8 items-center justify-center rounded-full bg-black text-sm font-bold text-white">
                            {{option.option_key}}
                          </div>
                          <div class="text-sm font-semibold text-gray-900">{{option.option_title}}</div>
                        </div>
                        <div v-if="option.option_intro" class="ml-12 text-sm leading-6 text-gray-600">
                          {{option.option_intro}}
                        </div>
                        <div v-if="option.option_cover" class="ml-12 mt-2">
                          <img :src="option.option_cover" class="max-h-40 w-full max-w-[200px] rounded-lg object-cover">
                        </div>
                      </div>
                    </div>
                    
                    <!-- 通用结果内容 -->
                    <div v-if="!allInfo.answer_info.mbti_content && !allInfo.answer_info.selected_options" class="p-5 text-center">
                      <div class="mb-5 text-lg font-bold text-black">
                        {{allInfo.result || '测试完成'}}
                      </div>
                      <div class="text-base leading-7 text-gray-600">
                        感谢您参与测试！您的选择已经记录。
                      </div>
                    </div>
                  </div>

                  <!-- 测试总结 -->
                  <div class="mb-8 ui-card bg-black text-white">
                    <div class="ui-card-body">
                    <h4 class="mb-4 text-lg font-semibold text-white">测试总结</h4>
                    <div class="grid gap-4 sm:grid-cols-3">
                      <div class="text-center">
                        <div class="rounded-xl bg-white/20 p-4">
                          <div class="text-2xl font-bold">{{allInfo.max_score}}</div>
                          <div class="text-sm opacity-90">总题数</div>
                        </div>
                      </div>
                      <div class="text-center">
                        <div class="rounded-xl bg-white/20 p-4">
                          <div class="text-2xl font-bold">{{resultInfo.mbti_type || resultInfo.type}}</div>
                          <div class="text-sm opacity-90">性格类型</div>
                        </div>
                      </div>
                      <div class="text-center">
                        <div class="rounded-xl bg-white/20 p-4">
                          <div class="text-2xl font-bold">{{Math.round((allInfo.max_score - Object.values(allInfo.stat_data).reduce((a,b) => a+b, 0)) / allInfo.max_score * 100)}}%</div>
                          <div class="text-sm opacity-90">完成度</div>
                        </div>
                      </div>
                    </div>
                    </div>
                  </div>

                  <!-- 个人建议 -->
                  <div class="mb-8 ui-card">
                    <div class="ui-card-body border-l-4 border-black">
                    <h4 class="mb-5 text-lg font-semibold text-gray-900">个人发展建议</h4>
                    <div class="grid gap-4 sm:grid-cols-2">
                      <div>
                        <div class="rounded-xl bg-gray-50 p-4">
                          <h6 class="mb-2 text-sm font-semibold text-black">优势发挥</h6>
                          <p class="m-0 text-sm leading-6 text-gray-600">
                            基于您的性格类型，建议在{{allInfo.stat_data.E > allInfo.stat_data.I ? '社交互动' : '独立思考'}}和{{allInfo.stat_data.N > allInfo.stat_data.S ? '创新思维' : '细节处理'}}方面发挥优势。
                          </p>
                        </div>
                      </div>
                      <div>
                        <div class="rounded-xl bg-gray-50 p-4">
                          <h6 class="mb-2 text-sm font-semibold text-black">成长方向</h6>
                          <p class="m-0 text-sm leading-6 text-gray-600">
                            可以尝试在{{allInfo.stat_data.I > allInfo.stat_data.E ? '社交沟通' : '深度思考'}}和{{allInfo.stat_data.S > allInfo.stat_data.N ? '宏观规划' : '具体执行'}}方面进行提升。
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>

                  </div>

                    <!-- Table -->
                    <div class="overflow-hidden rounded-lg border border-gray-200" v-if="answerbackInfo.length>1">
                      <table class="min-w-full divide-y divide-gray-200 text-sm text-gray-700">
                        <thead class="bg-gray-50">
                          <tr>
                            <th class="px-3 py-2 text-center font-semibold" v-for="item in answerbackInfo">{{item.title}}</th>
                          </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 bg-white">
                          <tr>
                            <td class="px-3 py-2 text-center" v-for="item in answerbackInfo">{{item.score}}</td>
                          </tr>
                          <!-- 可以添加更多的行 -->
                        </tbody>
                      </table>
                    </div>

                    <!-- 通用长形图表 -->
                

                <div class="text-center" v-if="isShowCharts">

                  

                  <!-- <el-tag class="m-4" type="danger" size="medium">图表显示</el-tag> -->
                  <div class="mx-auto ui-card">
                    <div class="ui-card-body">
                    <div class="text-left" v-if="allInfo.show_type == 'common'">
                      <div class="mb-4" v-for="item in allInfo.stat_data">
                        <div class="mb-1 text-sm">
                          <div class="mb-3 font-semibold text-gray-900">{{item.name}} | <span class="font-bold">(得分:{{item.score}})</span></div>
                          <el-progress :text-inside="true" :stroke-width="26" :percentage="item.score_rate" status="warning"></el-progress>
                        </div>
                      </div>
                    </div>
                      <canvas id="columnCharts" class="h-64 w-full" v-if="allInfo.show_type !== 'common'"></canvas>
                    </div>
                  </div>
                </div>
               
                <div>
                  <div class="mt-6 space-y-4 text-left" v-for="item in answerbackInfo">
                    <div v-if="item.score" class="mb-2 text-2xl font-semibold text-black">{{item.title}}——你的分值:{{item.score}}</div>
                    <div v-html="item.content"></div>
                  </div>
                </div>
              </div>

                <div class="mt-9 text-center" v-if="examInfo.channel_id == 10">
                  <el-button class="w-full" @click="toAnalyse">查看该人格的详细报告</el-button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="ui-card">
          <div class="p-4 text-sm leading-7 text-gray-700">
            <div class="rounded-md bg-gray-50 px-4 py-3">
              <span class="font-semibold">温馨提示：</span> 测试结果仅供用户自评参考，不可作为临床诊断依据，趣味型测试仅供娱乐。
            </div>
          </div>
        </section>
      </main>

      <aside class="space-y-6 lg:col-span-4">
        <section class="ui-card">
          <div class="ui-card-header">
            <h3 class="text-xs font-semibold tracking-[0.18em] text-gray-900">{:__('MBTI专区')}</h3>
          </div>
          <div class="p-4">
            <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-1">
              {cms:arclist id="item" channel="10" length="8" row="3"}
              <div>
                {include file="common/item_mbti"}
              </div>
              {/cms:arclist}
            </div>
          </div>
        </section>
      </aside>
    </div>
  </div>
</div>

<script type="text/javascript" src="__ADDON__/js/vue.js"></script>
<script type="text/javascript" src="__ADDON__/js/vue-index.js"></script>
<script type="text/javascript" src="__ADDON__/js/u-charts.js"></script>


<script>
  var token = "<?php echo $token?>";
  var currentDomain = window.location.hostname;
  var uChartsInstance = {};
  new Vue({
    el: '#app',
    data: {
      allInfo: '',
      resultInfo: '',
      answerbackInfo:'',
      examInfo: '',
      aid: '',
      isGet: false,
      isShowCharts:false,
      chartdata:{
          categories:[],
          series: [
            {
              name: '分值',
              color: '#111827',
              data: [],
            }
          ]
        }
    },
    mounted() {
      this.$el.classList.remove('hidden');
      var searchString = window.location.search;
      var params = new URLSearchParams(searchString);
      this.aid = params.get('aid')
      this.getResultDetail()
    },
    methods: {
      getDimensionName(key) {
        const dimensionNames = {
          'E': '外向性',
          'I': '内向性', 
          'S': '感觉',
          'N': '直觉',
          'T': '思考',
          'F': '情感',
          'J': '判断',
          'P': '知觉'
        };
        return dimensionNames[key] || key;
      },
      
      getTestResultTitle() {
        if (this.allInfo.test_info && this.allInfo.test_info.test_type === 'mbti') {
          return this.resultInfo.mbti_type || this.resultInfo.type || '未知类型';
        } else if (this.allInfo.test_info && this.allInfo.test_info.test_type === 'dimension') {
          return this.resultInfo.total_score || this.allInfo.max_score || '0';
        } else if (this.allInfo.test_info && this.allInfo.test_info.test_type === 'custom') {
          return this.resultInfo.title || this.allInfo.result || '测试完成';
        } else {
          return this.resultInfo.title || '测试结果';
        }
      },
      
      getTestResultSubtitle() {
        if (this.allInfo.test_info && this.allInfo.test_info.test_type === 'mbti') {
          return '您的MBTI性格类型';
        } else if (this.allInfo.test_info && this.allInfo.test_info.test_type === 'dimension') {
          return '您的测试总分';
        } else if (this.allInfo.test_info && this.allInfo.test_info.test_type === 'custom') {
          return '您的测试结果';
        } else {
          return '测试结果';
        }
      },
      
      getDimensionsTitle() {
        if (this.allInfo.test_info && this.allInfo.test_info.test_type === 'mbti') {
          return '各维度得分详情';
        } else if (this.allInfo.test_info && this.allInfo.test_info.test_type === 'dimension') {
          return '各维度得分详情';
        } else if (this.allInfo.test_info && this.allInfo.test_info.test_type === 'custom') {
          return '测试结果详情';
        } else {
          return '得分详情';
        }
      },
      
      getDimensionDisplayName(key) {
        if (this.allInfo.test_info && this.allInfo.test_info.test_type === 'mbti') {
          return this.getDimensionName(key);
        } else {
          return key;
        }
      },
      
      getDimensionPercentage(value) {
        if (this.allInfo.test_info && this.allInfo.test_info.test_type === 'mbti') {
          return (value / 12 * 100);
        } else {
          return Math.min((value / this.allInfo.max_score * 100), 100);
        }
      },
      
      toPay(type) {
        // 使用完整的URL，包含端口号
        const baseUrl = window.location.protocol + '//' + window.location.host;
        window.location.href = baseUrl + '/addons/cms/order/submit.html?ua_id=' + this.aid + '&paytype=' + type;
      },
      
      getResultDetail() {
        let chartdata = this.chartdata
        const params = new URLSearchParams();
        params.append('answer_id', this.aid);
        params.append('token',token );
   
        fetch('/addons/cms/psychometry/answerInfo?',
          {
            method: 'POST',
            body: params,
          })
          .then(response => response.json())
          .then(data => {
            if (data.code == 1) {
              this.allInfo = data.data
              this.examInfo = data.data.a_info
              this.isShowCharts = true
              let stat_data = data.data.stat_data;
              chartdata.show_type = data.data.show_type;

              // 直接显示结果，不需要支付验证
              this.isGet = true;
              this.resultInfo = data.data.answer_info;
              this.answerbackInfo = data.data.answer_back;

              if (data.data.show_type == 'none'||data.data.show_type == 'common') {
                this.isShowCharts = false
              }else{
                // 处理 arcbar 类型（单一分数的弧形进度条）
                if (data.data.show_type == 'arcbar' && stat_data && stat_data.score !== undefined) {
                  chartdata.title_name = stat_data.score;
                  chartdata.series[0].data = stat_data.score/100;
                  this.showCharts(chartdata);
                }
                // 处理 radar 类型（多维度雷达图）
                else if (data.data.show_type == 'radar' && stat_data && typeof stat_data === 'object') {
                  // 统计维度数量
                  let dimensionCount = 0;
                  for (let key in stat_data) {
                    if (stat_data[key] && stat_data[key].name !== undefined && stat_data[key].score !== undefined) {
                      chartdata.categories.push(stat_data[key].name);
                      chartdata.series[0].data.push(stat_data[key].score);
                      chartdata.max_score = data.data.max_score
                      dimensionCount++;
                    }
                  }
                  
                  // 只有维度数量>=3时才显示雷达图，否则不显示图表
                  if (dimensionCount >= 3) {
                    this.showCharts(chartdata);
                  } else {
                    this.isShowCharts = false;
                    console.log('维度数量少于3个，不适合显示雷达图');
                  }
                }
                // 处理 mount 类型（山峰图）
                else if (data.data.show_type == 'mount') {
                  if (stat_data && typeof stat_data === 'object') {
                    const newArray = Object.keys(stat_data).map(key => ({ name: key, value: Number(stat_data[key])  }));
                    chartdata.series[0].data= newArray
                  }
                  this.showCharts(chartdata);
                }
              }
            }
          })
          .catch(error => {
            console.error('Error fetching data:', error);
          });
      },
      toBack() {
        window.history.back();
      },
      toAnalyse() {
        window.location.href = '/addons/cms/analyse/index?aid=' + this.aid;
      },
      showCharts(chartdata) {
        // 使用定时器等待元素的出现
        const interval = setInterval(() => {
          const canvas = document.getElementById('columnCharts');
          if (canvas) {
            clearInterval(interval); // 清除定时器
            const ctx = canvas.getContext("2d");
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            // 在获取到canvas元素后执行图表初始化操作
            uChartsInstance['columnCharts'] = new uCharts({
              type: chartdata.show_type,
              context: ctx,
              width: canvas.width,
              height: canvas.height,
              categories: chartdata.categories,
              series: chartdata.series,
              animation: true,
              background: "#FFFFFF",
              padding: [10, 10, 0, 5],
              enableScroll: false,
              legend: {
                show: true,
                position: 'bottom',
                lineHeight: 5
              },
              xAxis: {
                disableGrid: true
              },
              yAxis: {
                data: [
                  {
                    min: 0,
                    max: 100
                  }
                ]
              },
              title: {
                name: chartdata.title_name,
                fontSize: 35,
                color: '#5DBE9E'
              },
              subtitle: {
                name: '分值',
                fontSize: 25,
                color: '#666666'
              },
              extra: {
                arcbar: {
                  type: 'default',
                  width: 24,
                  backgroundColor: '#E9E9E9',
                  startAngle: 0.75,
                  endAngle: 0.25,
                  gap: 2,
                  linearType: 'custom'
                },
                radar: {
                  gridType: 'circle',
                  gridColor: '#CCCCCC',
                  gridCount: 3,
                  opacity: 0.2,
                  max: chartdata.max_score,
                  labelShow: true
                },
                mount: {
                  type: 'bar',
                  widthRatio: 0.8
                }
              }
            });
          }
        }, 100); // 每100毫秒检查一次是否获取到canvas元素
      }
    }
  });
</script>